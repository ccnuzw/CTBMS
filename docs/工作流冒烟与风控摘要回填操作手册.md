# 工作流冒烟与风控摘要回填操作手册

## 1. 目标

用于统一执行以下两类操作：

1. 工作流核心能力冒烟回归（`risk-gate`、`hasRiskSummary` 及筛选组合回归）。
2. 历史执行实例 `outputSnapshot.riskGate` 摘要回填。

## 2. 前置条件

1. 已完成依赖安装：`pnpm install`。
2. API 可连接数据库（默认 `apps/api/.env` 的 `DATABASE_URL`）。
3. 已执行数据库迁移（若环境是新库）：`pnpm --filter api exec prisma migrate deploy`。
4. 回填审计表 `WorkflowBackfillAudit` 已存在（由迁移 `20260210233000_add_workflow_backfill_audit` 创建）。

## 3. 推荐执行顺序

1. 先跑工作流自检套件（脚本回归预检）：
   - `pnpm workflow:summary:self-check:all`
2. 校验自检报告 schema（防止聚合报告结构漂移）：
   - `pnpm workflow:summary:self-check:report:validate -- --report-file=logs/workflow-summary-self-check-report.json --summary-json-file=logs/workflow-summary-self-check-validation.json --expected-report-schema-version=1.0`
3. 再跑扩展一键冒烟（含 types 构建）：
   - `pnpm workflow:smoke:extended`
4. 运行发布前门禁（扩展冒烟 + 工作流 e2e 套件）：
   - `pnpm workflow:smoke:gate`
5. 运行风险闸门性能门禁：
   - `pnpm workflow:perf:risk-gate:gate`
6. 校验 smoke/perf 报告契约并输出摘要：
   - `pnpm workflow:reports:validate:strict -- --summary-markdown-file=logs/workflow-reports-summary.md`
   - `pnpm workflow:reports:validate:strict -- --summary-markdown-file=logs/workflow-reports-summary.md --summary-json-file=logs/workflow-reports-summary.json`
7. 如需一键执行完整工作流门禁（功能 + 性能 + 报告校验）：
   - `pnpm workflow:quality:gate`
   - 默认输出：`logs/workflow-quality-gate-report.json`
8. 校验质量门禁报告 schema（防止质量报告结构漂移）：
   - `pnpm workflow:quality:report:validate -- --report-file=logs/workflow-quality-gate-report.json --summary-json-file=logs/workflow-quality-gate-report-validation.json --expected-report-schema-version=1.0 --require-summary-json-assert`
9. 如需快速回归，仅执行基础冒烟：
   - `pnpm workflow:smoke`
10. 再跑回填 dry-run（仅统计，不写库）：

- `pnpm workflow:backfill:risk-summary:dry-run`

11. 评估 dry-run 输出后，执行正式回填：

- `pnpm --filter api run workflow:risk-summary:backfill -- --limit=2000`

## 4. 命令清单

### 4.1 冒烟

1. 根命令（推荐）：
   - `pnpm workflow:smoke`
2. 根命令（扩展筛选组合回归）：
   - `pnpm workflow:smoke:extended`
3. 根命令（发布前门禁，含工作流关键 e2e）：
   - `pnpm workflow:smoke:gate`
   - 说明：覆盖 `risk-gate`、`risk-gate-contract`、`has-risk-summary`、`execution-filters` 冒烟 + `workflow-execution-filters`、`workflow-dag`、`workflow-debate-execution`、`workflow-api-alias` e2e。
   - 说明：对数据库瞬时失败（`P1001 / Can't reach database server`）包含有限重试（执行器/脚本双层兜底，按步骤生效）。
   - 默认输出报告：`logs/workflow-smoke-gate-report.json`
4. API 子命令：
   - `pnpm --filter api run workflow:smoke`
   - `pnpm --filter api run workflow:smoke:extended`
   - `pnpm --filter api run workflow:execution-filters:smoke`
   - `pnpm --filter api run workflow:risk-gate:smoke`
   - `pnpm --filter api run workflow:risk-gate:contract:smoke`
   - `pnpm --filter api run workflow:has-risk-summary:smoke`
   - `pnpm --filter api run test:e2e:workflow-execution-filters`
   - `pnpm --filter api run test:e2e:workflow-dag`
   - `pnpm --filter api run test:e2e:workflow-debate-execution`
   - `pnpm --filter api run test:e2e:workflow-api-alias`
5. 性能基线：
   - `pnpm workflow:perf:risk-gate`
   - `pnpm workflow:perf:risk-gate:gate`
   - 报告文档：`docs/工作流执行引擎性能基线.md`
6. 报告契约校验/摘要：
   - `pnpm workflow:reports:validate`
   - `pnpm workflow:reports:validate:strict`
   - `pnpm workflow:reports:validate:self-check`
   - `pnpm workflow:reports:summary`
   - `pnpm workflow:reports:summary:self-check`
   - `pnpm workflow:summary:renderers:self-check`
   - `pnpm workflow:summary:self-check:all:self-check`
   - `pnpm workflow:summary:self-check:report:validate`
   - `pnpm workflow:summary:self-check:report:validate:self-check`
   - `pnpm workflow:quality:report:validate`
   - `pnpm workflow:quality:report:validate:self-check`
   - `pnpm workflow:quality:validation:guidance:self-check`
   - `pnpm workflow:summary:self-check:all`
   - `pnpm workflow:summary:self-check:all -- --report-file=logs/workflow-summary-self-check-report.json`
   - `pnpm workflow:summary:self-check:report:validate -- --report-file=logs/workflow-summary-self-check-report.json --summary-json-file=logs/workflow-summary-self-check-validation.json --expected-report-schema-version=1.0`
   - `pnpm workflow:ci:step-summary`
   - `pnpm workflow:ci:step-summary:self-check`
   - `pnpm workflow:ci:step-summary -- --self-check-report-file=logs/workflow-summary-self-check-report.json`
   - `pnpm workflow:ci:step-summary -- --self-check-report-file=logs/workflow-summary-self-check-report.json --self-check-validation-file=logs/workflow-summary-self-check-validation.json`
   - `pnpm workflow:ci:step-summary -- --quality-report-validation-file=logs/workflow-quality-gate-report-validation.json`
   - `pnpm workflow:ci:step-summary -- --quality-report-validation-file=logs/workflow-quality-gate-report-validation.json --failure-index-snapshot-max-chars=200`
   - `pnpm workflow:reports:validate -- --summary-markdown-file=logs/workflow-reports-summary.md`
   - `pnpm workflow:reports:validate -- --summary-json-file=logs/workflow-reports-summary.json`
   - `pnpm workflow:reports:summary -- --summary-json-file=logs/workflow-reports-summary.json`
   - 严格校验示例：`pnpm workflow:reports:validate:strict -- --summary-markdown-file=logs/workflow-reports-summary.md`
   - 严格校验 + JSON 摘要：`pnpm workflow:reports:validate:strict -- --summary-markdown-file=logs/workflow-reports-summary.md --summary-json-file=logs/workflow-reports-summary.json`
   - JSON 摘要 schema 断言：`pnpm workflow:reports:validate -- --summary-json-schema-version=1.0 --summary-json-file=logs/workflow-reports-summary.json`
   - 新鲜度校验示例：`pnpm workflow:reports:validate -- --require-reports-generated-after=2026-02-11T00:00:00.000Z --max-report-age-ms=600000`
   - 质量总报告一致性校验：`pnpm workflow:reports:validate -- --quality-gate-report=logs/workflow-quality-gate-report.json --require-quality-gate-success`
7. 一键质量门禁：
   - `pnpm workflow:quality:gate`
   - `pnpm workflow:quality:gate:self-check`
   - `pnpm workflow:quality:report:validate:self-check`
   - `pnpm workflow:summary:self-check:all`（默认输出：`logs/workflow-summary-self-check-report.json`）
   - `pnpm workflow:summary:self-check:report:validate -- --report-file=logs/workflow-summary-self-check-report.json --summary-json-file=logs/workflow-summary-self-check-validation.json`（默认输出：`logs/workflow-summary-self-check-validation.json`）
   - `pnpm workflow:quality:report:validate -- --report-file=logs/workflow-quality-gate-report.json --summary-json-file=logs/workflow-quality-gate-report-validation.json --expected-report-schema-version=1.0 --require-summary-json-assert`（默认输出：`logs/workflow-quality-gate-report-validation.json`）
   - 允许 report 路径不一致（调试/样本校验场景）：`pnpm workflow:quality:report:validate -- --report-file=logs/workflow-quality-gate-report.json --allow-report-file-path-mismatch`
   - 跳过 options/artifacts 路径对齐校验（迁移旧报告场景）：`pnpm workflow:quality:report:validate -- --report-file=logs/workflow-quality-gate-report.json --skip-artifact-option-path-check`
   - `pnpm workflow:quality:report:summary -- --report-file=logs/workflow-quality-gate-report.json`
   - 默认使用严格校验（要求 smoke 成功、mode=gate、perf 无阈值违规）
   - 默认开启 DB 预检（仅在执行 smoke 时生效），不可达时快速失败并写入质量报告
   - 默认输出：`logs/workflow-quality-gate-report.json`（包含本次绑定的 smoke/perf/summary 报告路径）
   - 默认会将 `--quality-gate-report` 透传到 `workflow:reports:validate`，执行同次路径一致性校验
   - 可选参数：`pnpm workflow:quality:gate -- --summary-markdown-file=logs/custom-workflow-summary.md --summary-json-file=logs/custom-workflow-summary.json --report-file=logs/custom-workflow-quality-gate-report.json --smoke-report-file=logs/custom-smoke-report.json --perf-report-file=apps/api/logs/custom-perf-report.json`
   - 启用 JSON 摘要成功断言：`pnpm workflow:quality:gate -- --require-summary-json-success`
   - 指定 JSON 摘要 schema：`pnpm workflow:quality:gate -- --validate-summary-json-schema-version=1.0`
   - 报告年龄约束：`pnpm workflow:quality:gate -- --validate-max-report-age-ms=600000`
   - 宽松模式（调试场景）：`pnpm workflow:quality:gate -- --relaxed-validate`
   - 跳过 DB 预检（调试用）：`pnpm workflow:quality:gate -- --skip-db-preflight`
   - 自定义预检超时：`pnpm workflow:quality:gate -- --db-preflight-timeout-ms=5000`

### 4.2 冒烟报告参数

1. 自定义报告路径：
   - `pnpm workflow:smoke:gate -- --report-file=logs/custom-workflow-smoke-report.json`
2. 禁用报告输出：
   - `pnpm workflow:smoke:gate -- --no-report`

### 4.3 性能阈值参数

`workflow:perf:risk-gate` 支持按场景配置 P95 上限（超限即失败）：

1. `--max-p95-pass-low-risk=<ms>`
2. `--max-p95-soft-block-high-risk=<ms>`
3. `--max-p95-hard-block-by-rule=<ms>`

示例：

- `pnpm --filter api run workflow:perf:risk-gate -- --max-p95-pass-low-risk=0.03 --max-p95-soft-block-high-risk=0.03 --max-p95-hard-block-by-rule=0.04`

### 4.4 回填

1. Dry-run：
   - `pnpm --filter api run workflow:risk-summary:backfill -- --dry-run --limit=200`
2. 正式回填（仅缺失摘要）：
   - `pnpm --filter api run workflow:risk-summary:backfill -- --limit=2000`
3. 按 ownerUserId 定向回填：
   - `pnpm --filter api run workflow:risk-summary:backfill -- --owner-user-id=<USER_ID> --limit=500`
4. 覆盖回填（高风险，必须显式确认）：
   - `pnpm --filter api run workflow:risk-summary:backfill -- --overwrite --confirm-overwrite --limit=2000`
5. 输出审计报告到文件：
   - `pnpm --filter api run workflow:risk-summary:backfill -- --dry-run --report-file=apps/api/logs/workflow-risk-summary-backfill-report.json`

## 5. 回填参数说明

1. `--dry-run`：仅统计可处理数据，不写库。
2. `--limit`：最多处理的执行实例数量，默认 `2000`。
3. `--batch-size`：每批读取数量，默认 `200`。
4. `--owner-user-id`：仅处理指定用户的流程执行数据。
5. `--overwrite`：覆盖已有摘要。
6. `--confirm-overwrite`：与 `--overwrite` 配套，缺失则脚本会直接报错退出。
7. `--report-file`：可选，输出 JSON 审计报告（包含 runId、耗时、统计、失败样本）。
8. `--max-failure-log`：失败样本最大输出数量，默认 `20`。

## 6. 审计落库

每次回填都会尝试写入 `WorkflowBackfillAudit`，用于后续追踪：

1. `runId` 唯一。
2. `status` 与脚本最终状态一致（`SUCCESS` / `FAILED`）。
3. `optionsSnapshot` / `statsSnapshot` / `samplesSnapshot` 存完整上下文。
4. 若落库失败（例如数据库未执行最新迁移），脚本会给出告警但不影响主流程统计输出。

## 7. 审计报告字段

回填脚本会输出统一结构的审计对象，关键字段如下：

1. `runId`：本次回填唯一标识。
2. `startedAt` / `finishedAt` / `durationMs`：执行时窗和耗时。
3. `mode`：`only-missing` 或 `overwrite`。
4. `options`：本次参数快照（limit、batchSize、dryRun、ownerUserId 等）。
5. `stats`：处理统计（scanned、eligible、updated、failed、batchCount）。
6. `samples.updatedExecutionIds`：更新样本 ID（最多 20 条）。
7. `samples.failures`：失败样本（受 `--max-failure-log` 限制）。
8. `failuresTruncated`：失败样本是否被截断。

## 8. 常见问题

1. 报错 `Can't reach database server`：
   - 检查数据库进程和端口；
   - 检查 `apps/api/.env` 中的 `DATABASE_URL`；
   - 检查本机容器/网络策略是否限制本地端口访问。
2. 回填结果 `scanned=0`：
   - 当前库里没有匹配条件的数据（例如本身无 `risk-gate` 节点执行记录，或已全部有摘要）。
3. 冒烟失败且涉及布尔筛选：
   - 先执行 `pnpm --filter @packages/types build`，确保 API 使用最新 types 产物。
4. 需要核对风险闸门字段语义时：
   - 参考 `docs/工作流节点契约-riskgate.md`。
5. CI 失败需下载报告定位时：
   - 在 `Workflow Smoke` 的 artifact 中下载 `workflow-reports`，查看 `logs/workflow-quality-gate-report.json`、`logs/workflow-quality-gate-report-validation*.json`、`logs/workflow-summary-self-check-report*.json`、`logs/workflow-summary-self-check-validation*.json`、`logs/workflow-smoke-gate-report*.json`、`apps/api/logs/workflow-perf-risk-gate-baseline*.json`、`logs/workflow-reports-summary*.md`、`logs/workflow-reports-summary*.json`；
   - 优先阅读 `workflow-quality-gate-report.json.summary.failedStepIds`，可快速定位失败步骤。
   - `Workflow Smoke` 的 Step Summary 会展示自检套件摘要、自检报告校验状态、runId、failedStepIds、耗时、smoke/perf/summary 报告文件名，以及 `summary-json-assert` 的状态/原因码/schema 对比。
   - quality report 校验块会额外提供 `First Failure Reason Code`、`Failure Reason Source`、`Guidance Version`、`First Validation Error`、`Suggested Action`、`Suggested Command`、`Failure Index Snapshot` 及 diagnostics 统计（`Reason Code/Source Counts`、`Snapshot Truncated Count`、`Diagnostics Consistency Status`），优先执行首修命令。
6. `workflow:reports:validate` 失败：
   - 检查报告是否由最新版脚本生成（`schemaVersion` 字段是否存在）；
   - 若开启了严格校验参数，确认 smoke/perf 结果是否满足成功条件；
   - 若包含新鲜度约束（`--require-reports-generated-after` / `--max-report-age-ms`），确认报告时间是否在窗口内；
   - 若 CI 中报告文件缺失，先定位上游 step 失败原因，再重新执行门禁。
7. 本地 `workflow:quality:gate` 失败：
   - 查看 `logs/workflow-quality-gate-report.json` 中 `summary.failedStepIds`；
   - 再按失败 step 分别执行对应命令（`workflow:smoke:gate` / `workflow:perf:risk-gate:gate` / `workflow:reports:validate`）。
8. 本地质量门禁快速失败（`db-preflight`）：
   - 说明数据库端口不可达或 `DATABASE_URL` 异常；
   - 先修复连接后再执行，必要时临时使用 `--skip-db-preflight` 进行非 smoke 调试。
9. `workflow:reports:validate:self-check` 失败：
   - 自检脚本会在系统临时目录输出 case 数据；失败时会打印 `temp root preserved for debugging`；
   - 优先查看对应 case 的 `summary.json` 中 `validationErrors`，再对照修复校验器逻辑。
10. `workflow:quality:gate` 在 `summary-json-assert` 失败：

- 先查看 `logs/workflow-quality-gate-report.json` 中 `steps[id=summary-json-assert].outputTail`；
- 优先查看 `logs/workflow-quality-gate-report.json` 中 `summary.summaryJsonAssert`（结构化字段）；
- 若提示 schema mismatch，校验 `--validate-summary-json-schema-version` 与摘要内 `schemaVersion` 是否一致；
- 若提示 status/validationErrors 异常，先修复上游 `report-validate` 失败原因。

11. `workflow:quality:gate:self-check` 失败：

- 关注输出中的 case 名称与失败断言，定位是成功路径回归还是失败路径回归；
- 若脚本提示保留了 `temp root`，直接检查临时目录里的 `quality-report.json` 与 `summary.json`。

12. `workflow:quality:report:summary` 输出字段为 `N/A`：

- 常见于旧版质量报告（尚未包含 `summary.summaryJsonAssert` 结构化字段）；
- 重新执行一次 `workflow:quality:gate` 生成最新报告后再查看。

13. `workflow:reports:summary` / `workflow:reports:summary:self-check` 失败：

- 先确认 `logs/workflow-reports-summary.json` 存在且为合法 JSON；
- 若是 CI 失败，先看上游 `workflow:reports:validate` 是否成功产出了 JSON 摘要；
- 自检失败时按提示 case 检查临时目录样本与脚本输出差异。

14. `workflow:ci:step-summary` / `workflow:ci:step-summary:self-check` 失败：

- 检查质量报告、markdown 摘要、json 摘要路径是否与命令参数一致；
- 若 CI 中仅部分文件缺失，脚本会输出 `file not found` 提示而非中断，优先回溯缺失文件的上游步骤。

15. `workflow:reports:summary` 与 `workflow:ci:step-summary` 输出字段不一致：

- 两个脚本已统一复用 `scripts/workflow-summary-renderers.mjs`，优先检查该文件字段映射是否被修改；
- 先后执行 `pnpm workflow:reports:summary:self-check`、`pnpm workflow:ci:step-summary:self-check`，确认渲染层回归后再跑 `pnpm workflow:quality:gate`。

16. `workflow:summary:renderers:self-check` 失败：

- 说明共享渲染器的 fallback/裁剪/字段映射行为发生回归；
- 优先修复 `scripts/workflow-summary-renderers.mjs`，再依次执行 `workflow:reports:summary:self-check` 与 `workflow:ci:step-summary:self-check` 做链路回归。

17. `workflow:summary:self-check:all` 失败：

- 聚合自检会在首个失败步骤中断，并打印 `failed steps`（step id）；
- 优先读取输出中的 `quick locate: rerun ...` 与 `quick locate: first failed output: ...`，先按建议命令单步复现；
- 先查看 `logs/workflow-summary-self-check-report.json` 中 `summary.failedStepIds`、`summary.failureFingerprint` 与对应 step `outputTail`；
- 再单独执行对应子命令定位（例如 `workflow:reports:validate:self-check`），修复后回到聚合命令复测。

18. `workflow:ci:step-summary` 中缺少 “Workflow Summary Self-Check Suite” 区块：

- 优先确认 `workflow:summary:self-check:all` 是否按同一路径输出了 `--report-file`；
- 再确认 `workflow:ci:step-summary` 是否传入了同一 `--self-check-report-file`。

19. `workflow:summary:self-check:all:self-check` 失败：

- 说明聚合自检脚本自身契约回归（常见：失败路径未落盘报告、failed step 结构变化）；
- 优先修复 `scripts/workflow-summary-self-check-all.mjs`，再执行 `workflow:summary:self-check:all:self-check` 与 `workflow:summary:self-check:all`。

20. `workflow:summary:self-check:report:validate` 或 `workflow:summary:self-check:report:validate:self-check` 失败：

- 先查看 `logs/workflow-summary-self-check-validation.json` 中 `validationErrors` 与 `report.*` 诊断字段；
- 若为 schemaVersion 不匹配，统一 `--expected-report-schema-version` 与生成脚本输出版本；
- 若为 steps/summary 结构错误，优先修复 `scripts/workflow-summary-self-check-all.mjs` 后重跑校验。

21. `workflow:quality:report:validate` 或 `workflow:quality:report:validate:self-check` 失败：

- 先查看 `logs/workflow-quality-gate-report-validation.json` 中 `validationErrors`、`report.failedStepIds` 与 `report.hasSummaryJsonAssert`；
- 若为 schemaVersion 不匹配，统一 `--expected-report-schema-version` 与 `workflow-quality-gate-runner` 输出版本；
- 若提示 summary/steps 计数不一致，优先修复 `scripts/workflow-quality-gate-runner.mjs` 的 `finalizeSummary` 与步骤落盘逻辑后重跑。

22. `workflow:quality:report:validate` 报 `report path mismatch` 或 `options/artifacts path mismatch`：

- 先确认校验命令 `--report-file` 与质量门禁产物 `artifacts.qualityGateReportFile` 是否是同一路径；
- 对旧样本做离线验证可临时使用 `--allow-report-file-path-mismatch`；
- 若报告来自历史脚本且路径字段不可对齐，可临时加 `--skip-artifact-option-path-check`，但发布门禁不建议关闭该校验。

23. `workflow:quality:report:validate` 失败但不确定先修什么：

- 先查看 `logs/workflow-quality-gate-report-validation.json.failureIndex`；
- 按 `failureIndex.reasonCode` 分流修复，再执行 `failureIndex.suggestedCommand`（若为空再看 `suggestedAction`）；
- 若 `failureIndex` 为空但状态失败，说明是旧报告或摘要字段缺失，优先升级到最新脚本重跑质量门禁后再校验。

24. `Suggested Command` 执行后仍失败：

- 对照 `failureIndex.reasonCode` 是否变化，优先处理新的首个 reasonCode；
- 若 reasonCode 不变，说明根因未修复，按 `validationErrors[0]` 精确比对输入路径/schema 参数后再重跑。

25. `workflow:quality:validation:guidance:self-check` 失败：

- 说明 quality report 校验的 reasonCode 分类或 `suggestedAction/suggestedCommand` 映射发生回归；
- 优先检查 `scripts/workflow-quality-gate-validation-guidance.mjs`，保证 `workflow-quality-gate-report-validate` 与 `workflow-summary-renderers` 使用同一套映射规则；
- 修复后至少回归 `workflow:summary:renderers:self-check`、`workflow:quality:report:validate:self-check` 与 `workflow:summary:self-check:all:self-check`。

26. quality report 校验块中的 `Failure Reason Source` 与预期不一致：

- `EXPLICIT_FAILURE_REASON_CODE`：来自报告中的结构化 `failureIndex.reasonCode`；
- `CLASSIFIED_FROM_VALIDATION_ERROR`：由 `firstValidationError` 规则分类得到；
- 若为 `N/A`，表示当前校验成功或无可分类失败信号。

27. `Failure Index Snapshot` 被截断或信息不完整：

- CI 摘要中的 snapshot 为限长单行诊断片段，超长会以 `...` 截断；
- 可结合 `Failure Index Snapshot Raw Length`、`Failure Index Snapshot Max Chars`、`Failure Index Snapshot Truncated` 判断是否需要提高长度上限；
- 需要完整字段时，直接查看 `logs/workflow-quality-gate-report-validation.json.failureIndex`；
- 若 snapshot 与 `failureIndex` 不一致，优先检查 `workflow-summary-renderers.mjs` 的字段映射与裁剪逻辑。

28. 需要调整 CI 中 `Failure Index Snapshot` 长度：

- 在 `workflow:ci:step-summary` 增加 `--failure-index-snapshot-max-chars=<N>`；
- 推荐范围 `160~320`（过小会损失上下文，过大可能影响 Step Summary 可读性）。

29. quality report 校验块 diagnostics 统计与 `validationErrors` 不一致：

- 先查看 `logs/workflow-quality-gate-report-validation.json.failureIndexDiagnostics`，核对 `reasonCodeCountTotal` 是否等于 `validationErrors.length`；
- 再查看 `Diagnostics Reason Code Counts` / `Diagnostics Reason Source Counts` 是否符合当前首个失败类型；
- 若统计缺失或漂移，优先回归 `pnpm workflow:quality:report:validate:self-check` 与 `pnpm workflow:summary:renderers:self-check`，修复 validator/renderers 的字段映射版本差异。

30. quality report 校验块 `Diagnostics Consistency Status` 为 `FAILED`：

- 先查看 `logs/workflow-quality-gate-report-validation.json.failureIndexDiagnostics.consistency.mismatchReasons`；
- 按 mismatchReasons 修复 total/map/snapshot 契约不一致项（常见是手工编辑摘要或混用旧脚本产物）；
- 修复后重跑 `pnpm workflow:quality:report:validate`，并回归 `pnpm workflow:summary:renderers:self-check` 与 `pnpm workflow:ci:step-summary:self-check`。

31. `workflow:summary:self-check:all` 失败但不知道先看哪个脚本：

- 先看 stderr 的 `quick locate: rerun ...`，按建议命令重跑对应自检；
- 再看 `quick locate: first failed output: ...` 首行错误，快速判断是环境问题（如 `spawn ... ENOENT`）还是脚本断言回归；
- 若失败步骤是 `quality-gate-report-validate-self-check`，额外检查 `logs/workflow-quality-gate-report-validation.json.failureIndexDiagnostics.consistency.mismatchReasons`。

32. `workflow:summary:self-check:report:validate` 提示 `failureFingerprint` 不一致或缺失：

- 先重跑 `pnpm workflow:summary:self-check:all -- --report-file=logs/workflow-summary-self-check-report.json`，确保报告由最新脚本生成；
- 再核对 `logs/workflow-summary-self-check-report.json.summary.failureFingerprint` 与首个失败 step 是否一致（`stepId/command/firstOutputLine/hash`）；
- 最后执行 `pnpm workflow:summary:self-check:report:validate` 与 `pnpm workflow:ci:step-summary:self-check` 回归展示链路。

33. Workflow Smoke 页面太长，无法第一时间看到失败指纹：

- 优先查看 Step Summary 顶部 `Workflow Quick Locate Index` 区块；
- 关注 `Self-Check Failure Fingerprint Hash`、`Quality Validation Reason Code`、`Quality Validation Suggested Command` 三行，先定位再下钻；
- 若 `Self-Check Failure Fingerprint Hash=N/A` 且自检失败，回查 `logs/workflow-summary-self-check-report.json.summary.failureFingerprint` 并重跑聚合自检。

34. Quick Locate 中 `Self-Check Suggested Command` 或 `Self-Check First Failed Output` 为 `N/A`，但 self-check 明显失败：

- 先确认是否是 legacy 报告：`logs/workflow-summary-self-check-report.json.summary.failureFingerprint` 可能为 `null`；
- 新版脚本会从 `steps` 中首个 `status=FAILED` 的 step 自动回退计算 quick locate（`source=COMPUTED`）；
- 若仍为 `N/A`，直接查看 `logs/workflow-summary-self-check-report.json.steps`，提取首个失败 step 的 `command + args` 与 `outputTail` 首行进行复现定位。

35. Quick Locate 中 `Quality Validation Suggested Command` 为 `N/A`，但 quality gate 失败：

- 优先查看 `Quality Gate Suggested Command`，该字段会在 validation 命令缺失时回退到 quality report 首个失败 step 的命令；
- 结合 `Quality Gate First Failed Output` 判断是 schema/path/环境类问题，再执行对应命令复现；
- 若两个字段都为 `N/A`，回查 `logs/workflow-quality-gate-report.json.steps` 与 `logs/workflow-quality-gate-report-validation.json.failureIndex`，确认是否使用了旧版/不完整报告。

36. Quick Locate 中 `Quality Failure Fingerprint Source/Step/Hash` 为 `N/A` 或与预期不一致：

- 先看 `Quality Failure Fingerprint Source`：`SUMMARY` 代表来自 `logs/workflow-quality-gate-report.json.summary.failureFingerprint`，`COMPUTED` 代表由首个失败 step 计算，`N/A` 代表当前无法提取失败指纹；
- `Source=SUMMARY` 时，核对 `summary.failureFingerprint.stepId/hash/command/firstOutputLine` 是否完整；`Source=COMPUTED` 时，核对 `steps` 中首个 `status=FAILED` 的 step 是否存在有效 `command/outputTail`；
- 若 quality gate 已失败但三项仍为 `N/A`，先重跑 `pnpm workflow:summary:renderers:self-check` 与 `pnpm workflow:ci:step-summary:self-check`，再回归 `pnpm workflow:summary:self-check:all:self-check`。

37. Quick Locate 中建议命令存在，但不确定应该先执行哪条定位路径：

- 先看 `Quality Gate Suggested Command Source` 与 `Self-Check Suggested Command Source`；
- `VALIDATION_FAILURE_INDEX`：命令来自 quality report validation 的 `failureIndex.suggestedCommand`，优先修复校验输入/路径/schema；
- `FAILURE_FINGERPRINT`：命令来自失败指纹（summary 或 computed），优先按该命令复现并结合指纹 hash 锁定同类失败；
- `FAILED_STEP`：命令来自首个失败 step 回退，直接执行该 step 命令并查看首行输出；
- `N/A`：说明暂无可执行命令，回查报告 `steps` 与 `failureIndex` 原始字段后再定位。

38. 团队排障时对来源优先顺序有分歧，导致来回切命令：

- 优先查看 `Quality Gate Suggested Command Source Priority` 与 `Self-Check Suggested Command Source Priority`；
- quality 默认优先级：`VALIDATION_FAILURE_INDEX > FAILURE_FINGERPRINT > FAILED_STEP > N/A`；
- self-check 默认优先级：`FAILURE_FINGERPRINT > FAILED_STEP > N/A`；
- 若当前来源不在优先级首位，先修首位来源对应问题，再回看下一层来源，避免并行改动导致噪声。

39. Quick Locate 已给出建议命令，但仍不确定“第一步先修什么”：

- 先看 `Quality Gate First Fix Route` 与 `Self-Check First Fix Route`；
- quality 路由语义：`RUN_QUALITY_VALIDATION_SUGGESTED_COMMAND`（优先执行 validation 的 suggestedCommand）/`RUN_QUALITY_FINGERPRINT_COMMAND`（执行 failure fingerprint 命令）/`RUN_QUALITY_FAILED_STEP_COMMAND`（执行首个失败 step 命令）/`INSPECT_QUALITY_REPORT_STEPS_AND_FAILURE_INDEX`（无命令可执行时回查报告）；
- self-check 路由语义：`RUN_SELF_CHECK_FINGERPRINT_COMMAND` / `RUN_SELF_CHECK_FAILED_STEP_COMMAND` / `INSPECT_SELF_CHECK_REPORT_STEPS`；
- 若 route 为 `INSPECT_*`，先查看对应报告原始字段（quality: `logs/workflow-quality-gate-report.json.steps` + `logs/workflow-quality-gate-report-validation.json.failureIndex`；self-check: `logs/workflow-summary-self-check-report.json.steps`），再决定复现命令。

40. `workflow:summary:self-check:all` 失败时 `quick locate` 已给出重跑命令，但仍不确定该命令是不是“最高优先级”：

- 先看 stderr 的 `quick locate: command source priority`、`quick locate: command source`、`quick locate: first fix route`；
- 当前聚合优先级固定为 `STEP_OVERRIDE > FAILED_STEP > N/A`；
- `command source=STEP_OVERRIDE` 且 `first fix route=RERUN_QUICK_LOCATE_COMMAND`：直接执行 `quick locate: rerun ...`；
- `command source=FAILED_STEP` 且 `first fix route=RERUN_FAILED_STEP_COMMAND`：执行首个失败 step 的原始 `command + args`；
- `command source=N/A` 且 `first fix route=INSPECT_SELF_CHECK_REPORT_STEPS`：回查 `logs/workflow-summary-self-check-report.json.summary.failedStepIds` 与 `steps[*].outputTail`，再决定复现路径。

41. CI 摘要里的 `Workflow Summary Self-Check Suite` 与聚合自检 stderr 的 quick locate 信息不一致：

- 优先检查 `logs/workflow-summary-self-check-report.json.summary` 是否包含 `quickLocateCommandSourcePriority/quickLocateCommandSource/quickLocateFirstFixRoute/quickLocateCommand/quickLocateFirstFailedOutput`；
- 若字段存在，CI 摘要应原样展示这些结构化值；若字段缺失，才回退到 legacy 规则（`STEP_OVERRIDE > FAILED_STEP > N/A`）；
- 当 `quickLocateCommandSource=FAILED_STEP` 时，`Quick Locate Suggested Command` 应为失败 step 原命令，不应被 override 命令覆盖；
- 修复后回归：`pnpm workflow:summary:renderers:self-check`、`pnpm workflow:ci:step-summary:self-check`、`pnpm workflow:summary:self-check:all:self-check`。

42. `workflow:summary:self-check:report:validate` 报 `quickLocateFirstFixRoute must be RERUN_FAILED_STEP_COMMAND` 或 `quickLocateCommand mismatch`：

- 先确认 `logs/workflow-summary-self-check-report.json.summary.quickLocateCommandSource` 是否为 `FAILED_STEP`；若是，`quickLocateFirstFixRoute` 必须是 `RERUN_FAILED_STEP_COMMAND`；
- `quickLocateCommand` 必须与首个失败 step 的 `command + args` 完全一致，`quickLocateFirstFailedOutput` 必须等于该 step `outputTail` 首行；
- 不要手工只改一半字段（如仅改 source 不改 route/command），否则 validator 会按契约报错；
- 修复后依次回归：`pnpm workflow:summary:self-check:report:validate:self-check`、`pnpm workflow:summary:renderers:self-check`、`pnpm workflow:ci:step-summary:self-check`。
