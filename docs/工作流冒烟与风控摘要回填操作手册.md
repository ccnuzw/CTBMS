# 工作流冒烟与风控摘要回填操作手册

## 1. 目标
用于统一执行以下两类操作：

1. 工作流核心能力冒烟回归（`risk-gate`、`hasRiskSummary` 及筛选组合回归）。
2. 历史执行实例 `outputSnapshot.riskGate` 摘要回填。

## 2. 前置条件

1. 已完成依赖安装：`pnpm install`。
2. API 可连接数据库（默认 `apps/api/.env` 的 `DATABASE_URL`）。
3. 已执行数据库迁移（若环境是新库）：`pnpm --filter api exec prisma migrate deploy`。
4. 回填审计表 `WorkflowBackfillAudit` 已存在（由迁移 `20260210233000_add_workflow_backfill_audit` 创建）。

## 3. 推荐执行顺序

1. 先跑扩展一键冒烟（含 types 构建）：
   - `pnpm workflow:smoke:extended`
2. 运行发布前门禁（扩展冒烟 + 执行筛选 e2e）：
   - `pnpm workflow:smoke:gate`
3. 如需快速回归，仅执行基础冒烟：
   - `pnpm workflow:smoke`
4. 再跑回填 dry-run（仅统计，不写库）：
   - `pnpm workflow:backfill:risk-summary:dry-run`
5. 评估 dry-run 输出后，执行正式回填：
   - `pnpm --filter api run workflow:risk-summary:backfill -- --limit=2000`

## 4. 命令清单

### 4.1 冒烟

1. 根命令（推荐）：
   - `pnpm workflow:smoke`
2. 根命令（扩展筛选组合回归）：
   - `pnpm workflow:smoke:extended`
3. 根命令（发布前门禁，含执行筛选 e2e）：
   - `pnpm workflow:smoke:gate`
4. API 子命令：
   - `pnpm --filter api run workflow:smoke`
   - `pnpm --filter api run workflow:smoke:extended`
   - `pnpm --filter api run workflow:execution-filters:smoke`
   - `pnpm --filter api run workflow:risk-gate:smoke`
   - `pnpm --filter api run workflow:has-risk-summary:smoke`
   - `pnpm --filter api run test:e2e:workflow-execution-filters`

### 4.2 回填

1. Dry-run：
   - `pnpm --filter api run workflow:risk-summary:backfill -- --dry-run --limit=200`
2. 正式回填（仅缺失摘要）：
   - `pnpm --filter api run workflow:risk-summary:backfill -- --limit=2000`
3. 按 ownerUserId 定向回填：
   - `pnpm --filter api run workflow:risk-summary:backfill -- --owner-user-id=<USER_ID> --limit=500`
4. 覆盖回填（高风险，必须显式确认）：
   - `pnpm --filter api run workflow:risk-summary:backfill -- --overwrite --confirm-overwrite --limit=2000`
5. 输出审计报告到文件：
   - `pnpm --filter api run workflow:risk-summary:backfill -- --dry-run --report-file=apps/api/logs/workflow-risk-summary-backfill-report.json`

## 5. 回填参数说明

1. `--dry-run`：仅统计可处理数据，不写库。
2. `--limit`：最多处理的执行实例数量，默认 `2000`。
3. `--batch-size`：每批读取数量，默认 `200`。
4. `--owner-user-id`：仅处理指定用户的流程执行数据。
5. `--overwrite`：覆盖已有摘要。
6. `--confirm-overwrite`：与 `--overwrite` 配套，缺失则脚本会直接报错退出。
7. `--report-file`：可选，输出 JSON 审计报告（包含 runId、耗时、统计、失败样本）。
8. `--max-failure-log`：失败样本最大输出数量，默认 `20`。

## 6. 审计落库

每次回填都会尝试写入 `WorkflowBackfillAudit`，用于后续追踪：

1. `runId` 唯一。
2. `status` 与脚本最终状态一致（`SUCCESS` / `FAILED`）。
3. `optionsSnapshot` / `statsSnapshot` / `samplesSnapshot` 存完整上下文。
4. 若落库失败（例如数据库未执行最新迁移），脚本会给出告警但不影响主流程统计输出。

## 7. 审计报告字段

回填脚本会输出统一结构的审计对象，关键字段如下：

1. `runId`：本次回填唯一标识。
2. `startedAt` / `finishedAt` / `durationMs`：执行时窗和耗时。
3. `mode`：`only-missing` 或 `overwrite`。
4. `options`：本次参数快照（limit、batchSize、dryRun、ownerUserId 等）。
5. `stats`：处理统计（scanned、eligible、updated、failed、batchCount）。
6. `samples.updatedExecutionIds`：更新样本 ID（最多 20 条）。
7. `samples.failures`：失败样本（受 `--max-failure-log` 限制）。
8. `failuresTruncated`：失败样本是否被截断。

## 8. 常见问题

1. 报错 `Can't reach database server`：
   - 检查数据库进程和端口；
   - 检查 `apps/api/.env` 中的 `DATABASE_URL`；
   - 检查本机容器/网络策略是否限制本地端口访问。
2. 回填结果 `scanned=0`：
   - 当前库里没有匹配条件的数据（例如本身无 `risk-gate` 节点执行记录，或已全部有摘要）。
3. 冒烟失败且涉及布尔筛选：
   - 先执行 `pnpm --filter @packages/types build`，确保 API 使用最新 types 产物。
