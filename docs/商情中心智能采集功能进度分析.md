# 商情中心智能采集功能 - 进度分析报告

> **分析日期**: 2026-01-19
> **模块路径**: `apps/web/src/features/market-intel` (前端) / `apps/api/src/modules/market-intel` (后端)

---

## 📊 总体完成度评估

| 功能域 | 完成度 | 状态 |
| :--- | :---: | :--- |
| **数据模型 (Prisma Schema)** | 100% | ✅ 完成 |
| **后端 API 接口** | 90% | ✅ 基本完成 |
| **前端 API Hooks** | 95% | ✅ 完成 |
| **UI 组件** | 85% | 🔵 进行中 |
| **AI 智能分析** | 40% | 🟡 演示模式 |
| **文档采集 (OCR)** | 20% | 🔴 待实现 |
| **语音采集** | 10% | 🔴 待实现 |
| **自动化任务调度** | 60% | 🔵 基础完成 |

---

## ✅ 已实现功能

### 1. 数据模型 (Schema)

完整的 Prisma Schema 已定义，包含以下核心表：

| 模型 | 说明 | 位置 |
| :--- | :--- | :--- |
| `MarketIntel` | 商情情报主表 | [schema.prisma](file:///Users/mac/Progame/CTBMS/apps/api/prisma/schema.prisma#L399-L445) |
| `PriceData` | A类：结构化价格数据 | [schema.prisma](file:///Users/mac/Progame/CTBMS/apps/api/prisma/schema.prisma#L466-L500) |
| `IntelAttachment` | C类：文档附件存储 | [schema.prisma](file:///Users/mac/Progame/CTBMS/apps/api/prisma/schema.prisma#L505-L524) |
| `IntelEntityLink` | D类：情报-企业关联 | [schema.prisma](file:///Users/mac/Progame/CTBMS/apps/api/prisma/schema.prisma#L537-L553) |
| `IntelTask` | 采集任务调度 | [schema.prisma](file:///Users/mac/Progame/CTBMS/apps/api/prisma/schema.prisma#L573-L597) |
| `UserIntelStats` | 情报员统计数据 | [schema.prisma](file:///Users/mac/Progame/CTBMS/apps/api/prisma/schema.prisma#L448-L461) |

**情报分类枚举**:
```
IntelCategory:
  A_STRUCTURED      - 标准化硬数据 (价格/库存)
  B_SEMI_STRUCTURED - 半结构化情报 (心态/事件)
  C_DOCUMENT        - 文档与图表 (研报/政策)
  D_ENTITY          - 实体档案 (企业画像)
```

---

### 2. 后端 API (NestJS)

#### 已实现的 Service 层

| 服务 | 职责 | 文件 |
| :--- | :--- | :--- |
| `MarketIntelService` | 情报 CRUD、统计、排行榜 | [market-intel.service.ts](file:///Users/mac/Progame/CTBMS/apps/api/src/modules/market-intel/market-intel.service.ts) |
| `PriceDataService` | 价格数据管理、趋势分析、热力图 | [price-data.service.ts](file:///Users/mac/Progame/CTBMS/apps/api/src/modules/market-intel/price-data.service.ts) |
| `IntelTaskService` | 采集任务创建、分配、完成 | [intel-task.service.ts](file:///Users/mac/Progame/CTBMS/apps/api/src/modules/market-intel/intel-task.service.ts) |
| `IntelAttachmentService` | 附件管理、OCR 文本搜索 | [intel-attachment.service.ts](file:///Users/mac/Progame/CTBMS/apps/api/src/modules/market-intel/intel-attachment.service.ts) |
| `IntelEntityService` | 情报-企业关联、时间线 | [intel-entity.service.ts](file:///Users/mac/Progame/CTBMS/apps/api/src/modules/market-intel/intel-entity.service.ts) |
| `AIService` | AI 内容分析（当前为演示模式） | [ai.service.ts](file:///Users/mac/Progame/CTBMS/apps/api/src/modules/ai/ai.service.ts) |

#### 已暴露的 API 端点

| 端点 | 方法 | 功能 |
| :--- | :--- | :--- |
| `/market-intel` | POST | 创建情报 |
| `/market-intel` | GET | 查询情报列表（分页） |
| `/market-intel/:id` | GET/PUT/DELETE | 单条情报 CRUD |
| `/market-intel/stats` | GET | 获取统计数据 |
| `/market-intel/leaderboard` | GET | 情报员排行榜 |
| `/market-intel/analyze` | POST | AI 内容分析 |
| `/market-intel/price-data` | POST/GET | 价格数据管理 |
| `/market-intel/price-data/trend` | GET | 价格趋势 |
| `/market-intel/price-data/heatmap` | GET | 价格热力图 |
| `/market-intel/tasks` | POST/GET | 任务管理 |
| `/market-intel/tasks/my` | GET | 我的待办任务 |
| `/market-intel/tasks/:id/complete` | POST | 完成任务 |
| `/market-intel/attachments/search` | GET | OCR 文本搜索 |
| `/market-intel/enterprises/:id/intels` | GET | 企业关联情报 |
| `/market-intel/enterprises/:id/timeline` | GET | 企业情报时间线 |

---

### 3. 前端 React Hooks

[hooks.ts](file:///Users/mac/Progame/CTBMS/apps/web/src/features/market-intel/api/hooks.ts) 已实现完整的 TanStack Query 封装：

| Hook | 功能 |
| :--- | :--- |
| `useMarketIntels` | 情报列表查询 |
| `useMarketIntel` | 单条情报详情 |
| `useCreateMarketIntel` | 创建情报 |
| `useUpdateMarketIntel` | 更新情报 |
| `useDeleteMarketIntel` | 删除情报 |
| `useMarketIntelStats` | 统计数据（30s 自动刷新） |
| `useLeaderboard` | 排行榜 |
| `useAnalyzeContent` | AI 分析 |
| `usePriceData` | 价格数据列表 |
| `usePriceTrend` | 价格趋势 |
| `usePriceHeatmap` | 价格热力图 |
| `useIntelTasks` | 任务列表 |
| `useMyTasks` | 我的任务（1min 刷新） |
| `useCreateIntelTask` | 创建任务 |
| `useCompleteTask` | 完成任务 |
| `useSearchAttachments` | 附件搜索 |
| `useEnterpriseIntels` | 企业关联情报 |
| `useEnterpriseTimeline` | 企业时间线 |

---

### 4. UI 组件

| 组件 | 功能 | 完成度 |
| :--- | :--- | :---: |
| [SuperDashboard.tsx](file:///Users/mac/Progame/CTBMS/apps/web/src/features/market-intel/components/SuperDashboard.tsx) | 总览仪表盘 | ✅ |
| [Dashboard.tsx](file:///Users/mac/Progame/CTBMS/apps/web/src/features/market-intel/components/Dashboard.tsx) | 标准仪表盘 | ✅ |
| [DataEntry.tsx](file:///Users/mac/Progame/CTBMS/apps/web/src/features/market-intel/components/DataEntry.tsx) | 信息录入（核心采集入口） | ✅ |
| [OperationalWorkbench.tsx](file:///Users/mac/Progame/CTBMS/apps/web/src/features/market-intel/components/OperationalWorkbench.tsx) | 运营工作台 | ✅ |
| [UniversalSearch.tsx](file:///Users/mac/Progame/CTBMS/apps/web/src/features/market-intel/components/UniversalSearch.tsx) | 统一搜索 | ✅ |
| [IntelligenceFeed.tsx](file:///Users/mac/Progame/CTBMS/apps/web/src/features/market-intel/components/IntelligenceFeed.tsx) | 情报流 | ✅ |
| [MarketData.tsx](file:///Users/mac/Progame/CTBMS/apps/web/src/features/market-intel/components/MarketData.tsx) | 市场数据展示 | ✅ |
| [KnowledgeBase.tsx](file:///Users/mac/Progame/CTBMS/apps/web/src/features/market-intel/components/KnowledgeBase.tsx) | 知识库 | ✅ |
| [EntityProfile.tsx](file:///Users/mac/Progame/CTBMS/apps/web/src/features/market-intel/components/EntityProfile.tsx) | 实体档案 | ✅ |
| [Leaderboard.tsx](file:///Users/mac/Progame/CTBMS/apps/web/src/features/market-intel/components/Leaderboard.tsx) | 情报员排行榜 | ✅ |

**路由配置**: [routes/index.tsx](file:///Users/mac/Progame/CTBMS/apps/web/src/routes/index.tsx#L78-L90)
- `/intel` - 总览仪表盘
- `/intel/workbench` - 运营工作台
- `/intel/entry` - 数据录入
- `/intel/search` - 统一搜索
- 以及其他子路由...

---

## 🔵 进行中 / 部分完成

### 1. AI 智能分析

- [x] **框架搭建**: `AIService` 已创建
- [x] **演示模式**: 模拟 AI 分析结果
- [x] **前端集成**: `useAnalyzeContent` hook 已实现
- [ ] **真实 API 集成**: 需配置 GEMINI_API_KEY

当前 [ai.service.ts](file:///Users/mac/Progame/CTBMS/apps/api/src/modules/ai/ai.service.ts#L30-L38) 中有 TODO 标记：

```typescript
// TODO: 集成真实的 Gemini API 调用
// 当前返回模拟数据，后续可替换为真实实现
return this.getMockAnalysis(content, category);
```

### 2. 任务调度系统

- [x] **基础 CRUD**: 任务的创建、查询、更新、删除
- [x] **任务完成流程**: `/tasks/:id/complete` 已实现
- [x] **超时检测**: `checkOverdueTasks()` 已实现
- [ ] **定时任务触发**: 需要 cron job 自动执行
- [ ] **每日自动派发**: `createDailyTasks()` 方法存在但未自动调用

---

## 🔴 待实现功能

### 1. 智能采集核心能力

| 功能 | 描述 | 优先级 |
| :--- | :--- | :---: |
| **OCR 文档识别** | 上传图片/PDF 自动提取文字 | 🔴 高 |
| **语音采集** | 语音转文字，支持现场采集 | 🟡 中 |
| **GPS 围栏验证** | 验证采集位置真实性 | 🟡 中 |
| **自动价格提取** | 从文本中智能识别价格数据 | 🔴 高 |

### 2. 数据采集扩展

| 功能 | 描述 | 优先级 |
| :--- | :--- | :---: |
| **批量导入** | Excel/CSV 批量导入价格数据 | 🟡 中 |
| **爬虫采集** | 定时抓取公开数据源 | 🟢 低 |
| **API 对接** | 第三方数据源接入 | 🟢 低 |

### 3. 运营增强

| 功能 | 描述 | 优先级 |
| :--- | :--- | :---: |
| **积分激励系统** | 情报员积分详细规则 | 🟡 中 |
| **数据质量校验** | 异常数据自动标记 | 🔴 高 |
| **竞对情报分析** | 竞争对手动态追踪 | 🟡 中 |

---

## 📁 关键文件索引

```
商情中心智能采集模块
├── 后端 (apps/api/src/modules/market-intel/)
│   ├── market-intel.controller.ts  # API 路由
│   ├── market-intel.service.ts     # 核心业务逻辑
│   ├── price-data.service.ts       # 价格数据服务
│   ├── intel-task.service.ts       # 任务调度服务
│   ├── intel-attachment.service.ts # 附件管理
│   └── intel-entity.service.ts     # 实体关联
│
├── AI 服务 (apps/api/src/modules/ai/)
│   └── ai.service.ts               # AI 分析（演示模式）
│
├── 前端 (apps/web/src/features/market-intel/)
│   ├── api/hooks.ts                # React Query Hooks
│   ├── components/                 # UI 组件
│   │   ├── DataEntry.tsx           # 核心采集入口
│   │   ├── OperationalWorkbench.tsx
│   │   └── ...
│   ├── types.ts                    # 类型导出
│   └── constants.ts                # 常量定义
│
├── 共享类型 (packages/types/src/modules/)
│   └── market-intel.ts             # Zod Schema & Types
│
└── 数据库模型 (apps/api/prisma/)
    └── schema.prisma               # Prisma Schema
```

---

## 🚀 下一步建议

> [!IMPORTANT]
> 以下是推荐的功能扩展优先级

### 短期 (1-2 周)

1. **集成真实 AI API**
   - 配置 Gemini API Key
   - 实现真正的内容分析和实体提取

2. **完善 OCR 能力**
   - 集成 OCR 服务（如 Google Vision API）
   - 在 `IntelAttachmentService` 中实现图片文字提取

3. **自动化任务派发**
   - 添加定时任务（使用 `@nestjs/schedule`）
   - 每日自动创建价格上报任务

### 中期 (3-4 周)

4. **移动端适配**
   - 优化 DataEntry 组件的移动端体验
   - 添加 GPS 定位采集能力

5. **数据质量校验**
   - 价格异常自动检测
   - 历史数据对比告警

### 长期规划

6. **语音采集**
   - 集成语音识别 API
   - 现场快速录入支持

7. **爬虫采集**
   - 定时抓取公开价格数据
   - 数据清洗管道

---

*报告生成时间: 2026-01-19 09:28*
