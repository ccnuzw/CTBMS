# 商情中心任务分配模块说明

> 适用范围：商情中心（Market Intel）任务分配与管理模块  
> 版本日期：2026-01-25  
> 说明：本文档覆盖实现逻辑、功能介绍与使用说明。若与实现有差异，以代码为准。

---

## 1. 模块目标与边界

**目标**
- 提供统一的任务分配能力：单次任务、周期任务（模板化）
- 支持自然周/自然月的周期任务分发与截止管理
- 支持多维度筛选、统计与看板视图
- 为后续通知系统、绩效考核与审计扩展打基础

**当前边界**
- 任务通知配置已支持写入，但**消息系统尚未接入**（后续可扩展）
- 任务创建仅支持**单次任务**，周期任务统一在模板中配置
- 权限体系、登录态仍为系统占位（后续接入）

---

## 2. 核心数据结构（简要）

### 2.1 任务（IntelTask）
用于记录具体的任务实例（单次/周期分发后的任务）。

核心字段（简要）：
- `title`：任务标题
- `type`：任务类型（日报/周报/采集等）
- `priority`：优先级（低/中/高/紧急）
- `deadline`：截止时间（历史字段）
- `dueAt`：周期截止时间（优先使用）
- `periodStart/periodEnd/periodKey`：周期归属
- `assigneeId`：执行人
- `assigneeOrgId/assigneeDeptId`：组织快照
- `status`：PENDING / COMPLETED / OVERDUE
- `isLate`：逾期完成标记
- `requirements`：任务要求
- `attachmentUrls`：任务附件（链接数组）
- `notifyConfig`：通知配置（methods/userIds）
- `templateId`：关联模板（可选）

### 2.2 任务模板（IntelTaskTemplate）
用于配置周期任务的分发规则与截止规则。

核心字段（简要）：
- `cycleType`：DAILY / WEEKLY / MONTHLY / ONE_TIME
- `runAtMinute`：分发时间（分钟）
- `runDayOfWeek/runDayOfMonth`：分发日
- `dueAtMinute`：截止时间（分钟）
- `dueDayOfWeek/dueDayOfMonth`：截止日
- `activeFrom/activeUntil`：生效与停止时间
- `allowLate`：允许补报
- `maxBackfillPeriods`：最大补发期数
- `assigneeMode/assigneeIds/departmentIds/organizationIds`：分配规则

---

## 3. 关键业务逻辑

### 3.1 单次任务创建
代码入口：
- 前端：`CreateTaskModal`  
- 后端：`POST /intel-tasks`

流程：
1) 用户填写标题/类型/截止时间/优先级/指派人  
2) 提交创建任务  
3) 任务进入列表、日历、看板  

### 3.2 周期任务分发
代码入口：
- 前端：任务模板管理  
- 后端：`IntelTaskSchedulerService` 轮询调度

流程：
1) 模板配置周期、分发时间、截止时间  
2) 调度器计算 `nextRunAt`  
3) 触发分发，写入任务实例  

### 3.3 截止与逾期
- `dueAt` 优先于 `deadline`
- 逾期任务标记 `OVERDUE`
- 完成时间晚于截止时间，标记 `isLate = true`

### 3.4 补发策略
- `maxBackfillPeriods` 限制补发量  
- ONE_TIME 模板执行后自动停用  

---

## 4. 功能介绍

### 4.1 任务模板管理
功能点：
- 新建/编辑模板  
- 周期配置（每日/周/月/一次）  
- 分发时间、截止时间  
- 生效与停止时间  
- 分配规则（手动/组织/部门/全员）  
- 预览未来分发时间  

### 4.2 任务管理
功能点：
- 任务列表  
- 多维筛选（类型/状态/优先级/周期/组织/部门/人员）  
- KPI 统计（全量与当前页）  
- 组织/部门报表  

### 4.3 任务日历
功能点：
- 月历展示  
- 日维度任务数量统计  
- 组织/部门/人员过滤  
- 类型/状态/优先级过滤  
- 日任务抽屉查看  

### 4.4 我的任务看板
功能点：
- 按人员切换  
- 状态分组（待办/超时/完成）  
- 完成任务操作  

---

## 5. 使用说明（快速上手）

### 5.1 创建单次任务
入口：任务分发 → 创建任务  
步骤：
1) 填写标题、类型、截止时间  
2) 指派执行人  
3) 填写描述/要求/附件（可选）  
4) 提交  

### 5.2 创建周期任务
入口：任务分发 → 任务模板  
步骤：
1) 新建模板  
2) 配置周期与分发规则  
3) 配置截止时间与有效期  
4) 保存模板  

### 5.3 任务分发（模板）
入口：模板列表 → 分发按钮  
说明：模板可自动分发，也可手动触发  

### 5.4 KPI 统计范围
入口：任务管理页  
说明：可选择统计范围，并保存自定义快捷项  

---

## 6. 接口说明（简要）

### 任务接口
- `POST /intel-tasks` 新建单次任务
- `GET /intel-tasks` 查询任务列表
- `POST /intel-tasks/:id/complete` 完成任务
- `POST /intel-tasks/check-overdue` 标记超时任务

### 模板接口
- `POST /intel-tasks/templates` 新建模板  
- `GET /intel-tasks/templates` 模板列表  
- `PUT /intel-tasks/templates/:id` 更新模板  
- `DELETE /intel-tasks/templates/:id` 删除模板  
- `POST /intel-tasks/distribute` 手动分发  

### 统计接口
- `GET /intel-tasks/metrics` KPI 汇总  
- `GET /intel-tasks/metrics/org` 组织维度统计  
- `GET /intel-tasks/metrics/dept` 部门维度统计  

---

## 7. 运维与配置

### 7.1 调度配置
环境变量：
- `TASK_SCHEDULER_INTERVAL_MS` 任务调度轮询间隔（默认 300000 ms）

### 7.2 数据迁移
相关迁移：
- `20260125210000_task_schedule_enhancements`  
- `20260125213000_add_task_template_run_days`  
- `20260125223000_add_task_requirements_attachments`  
- `20260125224000_add_task_notify_config`  

---

## 8. 当前已知限制与待办
- 通知系统未接入  
- 权限与登录上下文暂未对接  
- KPI 管理暂为本地偏好  

---

## 9. 当前开发进展
**已完成**
- 模板化周期任务：分发时间/截止时间/有效期/分发规则/预览  
- 调度器：自动分发、补发控制、ONE_TIME 停用  
- 任务管理：列表/日历/看板/筛选/统计  
- 组织与部门维度统计报表  
- 单次任务创建弹窗与真实人员指派  

**进行中/待完善**
- 通知系统接入与消息投递  
- 权限与登录上下文  
- 任务审计与过程留痕  

---

## 10. 快速排查
常见问题：
- 任务未分发：检查模板 `activeFrom/activeUntil/nextRunAt`  
- 任务未显示：检查筛选条件（组织/部门/时间范围）  
- KPI 不准确：确认统计范围过滤  

---

## 11. 代码入口索引
后端：
- `apps/api/src/modules/intel-task/*`
前端：
- `apps/web/src/features/market-intel/components/task-distribution/*`
类型：
- `packages/types/src/modules/market-intel.ts`
