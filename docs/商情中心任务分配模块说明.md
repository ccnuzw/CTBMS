
# 商情中心任务分配模块说明（重规划草案）

> 适用范围：商情中心（Market Intel）任务分配与管理模块  
> 版本日期：2026-02-06  
> 说明：本文档为整体设计稿，用于评审后落地。若与实现有差异，以代码为准。

---

## 1. 目标与定位

**目标**
- 提供灵活、可组合的任务分配与监控机制，覆盖“采集类/内容类/调研类”等多场景。
- 支持“采集点/组织/部门/人员/角色/标签/动态条件”等多维分配。
- 支持“多频率、多规则、分组完成策略”的复杂需求。
- 打通采集全流程闭环：采集点配置 → 采集点-员工匹配 → 任务模板 → 任务分发 → 采集填报 → 任务监控 → 绩效评分。

**定位**
- 任务类型 = 分类 + 强绑定表单/审核流程（定义是否绑定采集点、审核链路、默认 SLA）。
- 任务模板 = 任务定义 + 多条分配规则（规则可独立频率/范围/策略）。
- 任务分配为全局能力，可复用到其他领域（非仅商情中心）。

---

## 2. 当前实现边界（简述）
- 任务模板仅支持单一周期与单一分配规则。
- 采集点分配支持按类型或指定采集点，无法对不同采集点设置不同频率。
- 人员/采集点选择为全量多选，下拉在大规模下体验不佳。
- 按部门/组织分配为“每人一任务”，没有“任一人完成即组完成”的逻辑。

---

## 3. 新设计概览

### 3.1 核心概念
- **任务类型（TaskType）**：定义流程、默认表单与约束（是否绑定采集点/是否审核）。
- **任务模板（Template）**：周期任务的顶层配置与描述。
- **分配规则（Rule）**：模板下的多条规则，分别定义范围、频率、分配策略与完成策略。
- **任务组（TaskGroup，可选）**：用于协作/合并完成的任务策略。

### 3.2 规则驱动
一个模板可包含多条规则，每条规则可独立配置：
- **目标范围**：采集点/人员/部门/组织/角色/标签/动态条件
- **分配策略**：采集点负责人、主负责人、轮转、负载均衡
- **频率策略**：日/周/月/自定义（支持周一三五等）
- **完成策略**：每人一任务或协作任务

### 3.3 任务类型强绑定表单/审核
- 每个任务类型必须绑定一个“表单 + 审核流程”。
- 创建/分发任务时必须引用该类型对应的表单与流程配置。
- 审核节点由任务类型驱动，不再由模板自由定义。

### 3.4 全流程闭环总览
闭环包含 7 个关键环节：
1) 采集点配置  
2) 采集点-员工匹配  
3) 任务模板设置（规则与频率）  
4) 任务分发（自动/手动）  
5) 采集信息填报（表单与审核）  
6) 任务监控（覆盖率/负载/时效）  
7) 绩效评分（完成率/准时率/质量）

---

## 4. 数据模型（概念层）

### 4.1 任务类型（TaskType）
- `code/name/domain`
- `bindFormId`（绑定表单）
- `bindWorkflowId`（绑定审核流程）
- `requiresCollectionPoint`（是否绑定采集点）
- `defaultSla`（默认截止策略）

### 4.2 任务模板（Template）
- `name/description/taskType/priority/domain`
- `isActive/activeFrom/activeUntil`
- `rules[]`（一对多）

### 4.3 分配规则（Rule）
- `scopeType`：POINT / USER / DEPARTMENT / ORGANIZATION / ROLE / QUERY
- `scopeQuery`：结构化条件（类型/区域/标签/关键词）
- `frequency`：日/周/月/自定义表达（如周一三五）
- `dispatchTime`：分发时刻（分钟或时分）
- `duePolicy`：截止规则（固定时间、偏移、SLA）
- `assigneeStrategy`：负责人/主负责人/轮转/负载
- `completionPolicy`：EACH / ANY_ONE / QUORUM / ALL
- `grouping`：是否生成任务组

### 4.4 任务组（可选）
用于协作任务或“一人完成即组完成”场景：
- `groupId/templateId/ruleId`
- `status`：PENDING / COMPLETED / OVERDUE
- `memberTasks[]`

---

## 5. 频率与周期设计

### 5.1 支持的频率
- 每日：固定时刻
- 每周：可多选周几
- 每月：可多选日期或月末
- 自定义：间隔天数或 Cron 子集（仅内部）

### 5.2 采集点差异化频率（已确定）
- **采集频率默认放在采集点配置**，作为采集类任务的主频率来源。  
- 采集类模板提供 **“继承/覆盖”开关**：
  - **继承采集点频率（默认）**：按采集点频率与下发时间分发任务。
  - **模板覆盖频率**：忽略采集点频率，完全以模板周期 + 下发时间 + 截止日/时间为准。

---

## 6. 分配与完成策略

### 6.1 分配策略（以到人为主）
- **到人分配**：任务最终必须落到具体人员。
- **采集点负责人**：按采集点负责人派发（主负责人为默认）。
- **筛选池**：部门/组织/角色仅作为“人员筛选条件”，不会生成组织级任务。
- **轮转/负载**：作为可选策略在人员池内执行。

### 6.2 完成策略（Completion Policy）
- `EACH`：每人一任务（默认，当前逻辑）
- `ANY_ONE`：任一人完成即组完成
- `QUORUM(N)`：N 人完成即组完成
- `ALL`：全员完成才算组完成

---

## 7. 大规模选择与动态人群

### 7.1 远程搜索
- 人员/采集点选择统一改为远程搜索 + 分页 + 虚拟列表。
- 支持按条件筛选后“全选当前筛选结果”。

### 7.2 动态人群/采集点池
- 支持保存查询条件为“动态池”，运行时解析为实际成员。
- 条件示例：`采集点类型=港口 AND 区域=辽宁 AND 标签=重点`。

---

## 8. 任务监控与治理

### 8.1 覆盖率监控
- 采集点覆盖率（有无负责人/有无任务）。
- 频率覆盖率（是否按频率生成任务）。

### 8.2 负载与效率
- 人员负载分布、逾期率、完成率。
- 模板维度与规则维度统计。

### 8.3 异常与缺口
- 未分配负责人采集点、无任务周期。
- 超期未完成与高风险模板告警。

---

## 9. 全流程设计（采集闭环）

### 9.1 采集点配置
- 定义采集点基础信息、类型、区域、品种、频率与班次。
- 支持“采集频率/班次”作为分发依据（已确认使用采集点内置频率）。

### 9.2 采集点-员工匹配
- 采集点分配到人（主负责人为默认，可扩展为多负责人）。
- 支持按品种/采集子类型的细粒度责任配置。

### 9.3 任务模板设置
- 模板绑定任务类型（表单+审核流程）。
- 模板下多规则：范围、频率、到人策略、完成策略。
- 采集类模板新增“频率来源”：默认继承采集点频率，必要时可覆盖。

### 9.4 任务分发
- 自动调度：
  - 继承采集点频率：按采集点频率/下发时间生成任务。
  - 模板覆盖频率：按模板周期/下发时间生成任务。
- 手动触发：支持补发、重发、跨周期。

### 9.5 采集信息填报
- 任务进入“填报”态，按任务类型绑定表单提交结构化数据。
- 支持提交/审核/驳回闭环。

### 9.6 任务监控
- 覆盖率：采集点是否有任务、是否有人负责、是否按频率完成。
- 负载：人员任务量、逾期、完成率。
- 时效：逾期率、补交率。

### 9.7 绩效评分
- 评分维度：完成率、准时率、质量评分、数据有效率。
- 评分对象：个人/团队/组织。
- 支持按模板与采集点维度出报表。

---

## 10. 兼容与迁移策略（建议）

### 9.1 兼容当前模板
- 原模板自动映射为单条规则的模板。
- 原分配模式映射为 Rule 的 `scopeType + assigneeStrategy`。

### 9.2 渐进式改造
- 先引入 Rule 配置与远程选择器。
- 再引入“完成策略/任务组”。
- 最后引入“动态池/负载均衡”。

---

## 11. 已确认项
- 采集点频率配置采用“采集点内置”。
- 采集点负责人分配策略以“到人”为主，默认主负责人。
- 任务类型强绑定表单/审核流程。

## 12. 字典调整（简化）
- 任务类型字典做最小化，保留“基础通用类型 + 可扩展项”。
- 任务类型作为全局字典，支持其他领域复用。
- 建议码表：`COLLECTION`、`REPORT`、`RESEARCH`、`VERIFICATION`、`OTHER`。

---

## 13. 代码入口（当前）
- 后端：`apps/api/src/modules/intel-task/*`
- 前端：`apps/web/src/features/market-intel/components/task-distribution/*`
- 类型：`packages/types/src/modules/market-intel.ts`

---

## 14. 落地实施清单（详细）

### 14.1 数据模型与字典
- 新增/调整字段（采集点）
  - `frequency`（日/周/月/自定义）
  - `weekdays`（周一三五）
  - `monthDays`（1-31/0=月末）
  - `shift`（班次/时段）
- 新增任务类型绑定
  - TaskType 增加 `bindFormId`、`bindWorkflowId`、`requiresCollectionPoint`、`defaultSla`
- 分配规则表（如新增 `intel_task_rule`）
  - `templateId`、`scopeType`、`scopeQuery`、`frequency`、`dispatchTime`
  - `assigneeStrategy`、`completionPolicy`、`grouping`
- 任务组（可选）
  - `taskGroup`（groupId/templateId/ruleId/status）

### 14.2 任务分发引擎
- 采集点内置频率解析
  - 从采集点配置读取频率与班次 → 生成任务时间点
- 分配策略
  - 默认按主负责人到人
  - 支持轮转/负载均衡的策略扩展
- 补发/重发
  - 支持跨周期补发与手动触发

### 14.3 采集填报与审核
- 任务类型绑定表单与审核流程
  - 分发任务时自动绑定表单实例
  - 提交 → 审核 → 通过/驳回闭环
- 采集填报数据结构统一
  - 价格/库存/报告等按类型渲染不同表单

### 14.4 API 接口清单（建议）
- 采集点配置
  - `GET/POST/PATCH /collection-points`
  - `PATCH /collection-points/:id/frequency`
- 采集点-员工匹配
  - `GET/POST /collection-point-allocations`
- 任务模板与规则
  - `POST /intel-task-templates`
  - `POST /intel-task-templates/:id/rules`
  - `GET /intel-task-templates/:id/preview`
- 任务分发
  - `POST /intel-task-distribute`
  - `POST /intel-task-distribute/preview`
- 任务填报与审核
  - `POST /intel-task/:id/submit`
  - `POST /intel-task/:id/review`
- 绩效评分
  - `GET /intel-task/metrics/performance`

### 14.5 前端页面清单（建议）
- 采集点配置页
  - 频率/班次编辑
- 采集点分配中心
  - 到人分配、品种维度责任
- 任务模板管理
  - 模板基本信息 + 多规则编辑器
- 任务分发预览
  - 采集点覆盖、预计任务量
- 任务填报页
  - 按类型加载表单
- 任务监控页
  - 覆盖率、负载、时效
- 绩效评分页
  - 个人/团队/组织维度

### 14.6 迁移与灰度
- 旧模板映射为单规则模板
- 频率默认回填（无配置时沿用模板周期）
- 逐步启用规则引擎与绩效评分

### 14.7 测试与验收
- 规则分发与频率生成单测
- 大规模人员/采集点选择性能测试
- 绩效评分与监控报表验收
