# 智能体工作流编排平台开发落地方案（实施版 v1.0）

## 文档信息
| 字段 | 内容 |
|---|---|
| 文档名称 | 智能体工作流编排平台开发落地方案 |
| 版本 | v1.0（实施基线） |
| 编制日期 | 2026-02-10 |
| 依据文档 | `docs/智能体工作流编排平台设计方案.md`（v2.6） |
| 适用仓库 | `CTBMS`（Turborepo + pnpm） |
| 目标读者 | 产品负责人、技术负责人、后端/前端/测试/运维 |

---

## 1. 背景与目标

### 1.1 背景
设计方案已经完成架构、数据模型、节点契约、DSL、参数体系和页面定义，但内容规模大、实施周期长，需要转化为可执行的分阶段研发计划和验收门禁。

### 1.2 总体目标
1. 在不推翻现有系统的前提下，构建统一的智能体工作流编排中枢。
2. 首期同时交付“策略设计编排端 + 运行回放分析端”。
3. 支持 `LINEAR`、`DAG`、`DEBATE` 三种编排模式和 `HEADLESS`、`COPILOT`、`ON_DEMAND` 三种使用方式。
4. 完成参数、规则、Agent、流程、执行实例的版本化与可追溯治理。
5. 首版满足玉米交易决策支持场景（建议系统，不直接自动下单）。

### 1.3 范围边界（本方案）
1. 包含：P0/P1/P2/P2+ 分阶段实施路径、模块拆分、里程碑、验收标准、风险台账。
2. 不包含：具体 UI 视觉稿、第三方期货数据供应商采购细则、生产部署拓扑细节。

### 1.4 冻结约束（直接承接设计稿）
1. P0 默认不强制审批节点（保留能力）。
2. 用户隔离为“个人私有 + 公共模板只读引用”，暂不启用团队共享。
3. Debate 默认手工触发，必须可回放逐轮过程。
4. 证据链必须覆盖：原文片段、指标快照、规则命中。
5. A/B 灰度首版必须可用，自动止损阈值默认 `badCaseThreshold=0.2`。
6. 运费数据 P0 采用手工维护（周更）+ 回退策略。

---

## 2. 现状基线与差距映射

| 领域 | 已有能力（可复用） | 关键差距 | 本方案动作 |
|---|---|---|---|
| AI 与 Prompt | `AIModelConfig`、`PromptTemplate`、`AIService` | 缺 Agent 专用配置和提示词隔离 | 新增 `AgentProfile`、`AgentPromptTemplate` |
| 商情数据 | `MarketIntel`、`PriceData`、`ResearchReport`、`KnowledgeItem` | 缺统一数据接入抽象 | 新增 `DataConnector` 注册表与执行器 |
| 调度能力 | `IntelTaskTemplate`、`IntelTaskRule` | 与新工作流目标不同 | 明确与 `IntelTask` 解耦，建立独立 workflow 体系 |
| 规则能力 | `ExtractionRule`、`MarketAlertRule` 等 | 缺决策规则包和统一优先级 | 新增 `DecisionRulePack/DecisionRule` |
| 前端能力 | AntD + React + 路由体系成熟 | 缺流程画布、运行回放、参数中心联动 | 新建工作流相关 feature 集群 |

---

## 3. 实施方法与工程原则

### 3.1 核心方法
1. 采用“垂直切片”推进，每个切片必须可演示、可测试、可回归。
2. 每个切片都覆盖 `packages/types -> apps/api -> apps/web` 全链路，不做长期半成品层开发。
3. 严格执行共享类型单一事实源：前后端 DTO/类型仅来自 `@packages/types`。

### 3.2 工程原则
1. 一类能力一个 Nest 模块，避免“超级模块”。
2. 流程定义与执行实例分离，执行必须绑定精确版本（`WorkflowVersion`）。
3. 运行期所有关键输入必须快照化（参数、规则、模型、Prompt、节点输入输出）。
4. 先做可观测性再做规模化，默认把回放和审计作为一等功能。
5. 所有阈值参数禁止硬编码，统一进入参数中心。

### 3.3 默认节奏
1. 迭代周期：2 周一个 Sprint。
2. 里程碑周期：4 周一个阶段评审（含演示与复盘）。
3. 每阶段出口必须通过 `pnpm lint`、`pnpm type-check` 和阶段验收清单。

---

## 4. 分阶段路线图（建议 27 周）

> 计划起点按 2026-02-16（周一）计算，可整体平移。

| 阶段 | 时间窗口 | 目标 | 关键交付 | 阶段出口（必须满足） |
|---|---|---|---|---|
| Phase 0 启动与冻结 | 2026-02-16 ~ 2026-02-27 | 冻结范围与技术基线 | 需求冻结单、模块蓝图、技术 Spike 结论 | 架构评审通过，待确认项形成决策草案 |
| Phase 1 P0 数据与契约 | 2026-03-02 ~ 2026-03-27 | 打通最小闭环数据层 | P0 模型迁移、`packages/types` 新增 workflow 类型、基础 CRUD API | 可创建流程定义/版本并保存 DSL 快照 |
| Phase 2 线性模式闭环 | 2026-03-30 ~ 2026-04-24 | 跑通 `LINEAR + COPILOT` | 执行引擎 v1、线性流程执行、回放页 v1、证据链校验 v1 | 线性流程可从手工触发到结果回放 |
| Phase 3 DAG 与参数规则中心 | 2026-04-27 ~ 2026-05-22 | 跑通并行能力与参数治理 | `join` 策略、参数中心 v1、规则包绑定、DAG 发布校验 | DAG 流程可发布并稳定执行 |
| Phase 4 Debate 与导出 | 2026-05-25 ~ 2026-06-26 | 跑通辩论流程与报告能力 | `DebateRoundTrace`、辩论回放、PDF/Word 导出、Judge 裁决链路 | Debate 场景端到端可演示 |
| Phase 5 触发与灰度治理 | 2026-06-29 ~ 2026-07-24 | 支持 `ON_DEMAND` 与 A/B | `api-trigger`、鉴权限流、实验配置与指标看板 | On-Demand P95 <= 30s，A/B 可并行 |
| Phase 6 期货与模拟增强 | 2026-07-27 ~ 2026-08-21 | 完成 P2+ 关键增强 | 期货连接器、虚拟持仓与流水、沙盘流程 | 期货模拟流程可回放与评估 |

---

## 5. 里程碑交付清单（按仓库目录落位）

### 5.1 共享类型层（`packages/types`）
1. 新增 `packages/types/src/modules/workflow.ts`：DSL、节点配置、校验错误码类型。
2. 新增 `packages/types/src/modules/agent-workflow.ts`：`AgentProfile`、`AgentPromptTemplate`、`DebateTrace` 类型。
3. 新增 `packages/types/src/modules/parameter-rule.ts`：`ParameterSet/Item`、`DecisionRulePack` 类型。
4. 更新 `packages/types/src/index.ts`：统一导出。
5. 每阶段必须 `pnpm --filter types build` 通过。

### 5.2 后端层（`apps/api`）
1. `apps/api/prisma/schema.prisma` 新增 P0/P1/P2/P2+ 模型。
2. 新增模块建议（按一功能一模块）：
   - `apps/api/src/modules/workflow-definition`
   - `apps/api/src/modules/workflow-execution`
   - `apps/api/src/modules/agent-profile`
   - `apps/api/src/modules/parameter-center`
   - `apps/api/src/modules/decision-rule`
   - `apps/api/src/modules/data-connector`
   - `apps/api/src/modules/decision-record`
   - `apps/api/src/modules/workflow-experiment`（P1）
   - `apps/api/src/modules/debate-trace`（P2）
   - `apps/api/src/modules/futures-sim`（P2+）
3. 执行器层建议：
   - `apps/api/src/modules/workflow-execution/engine/*`：节点执行器、连线调度器、运行上下文。
   - `apps/api/src/modules/workflow-execution/validators/*`：WF001~WF306 规则实现。

### 5.3 前端层（`apps/web`）
1. 新增 feature 目录建议：
   - `apps/web/src/features/workflow-studio`
   - `apps/web/src/features/workflow-runtime`
   - `apps/web/src/features/agent-center`
   - `apps/web/src/features/parameter-center`
   - `apps/web/src/features/rule-center`
   - `apps/web/src/features/trigger-gateway`
   - `apps/web/src/features/replay-evaluation`
2. 路由接入：`apps/web/src/routes/index.tsx` 新增工作流相关路由。
3. UI 关键能力优先级：
   - P0：流程列表、属性面板、线性链路编辑、手工触发、运行日志。
   - P1：并行分支可视化、版本 diff、参数覆盖对比。
   - P2：辩论时间线回放、裁决依据展示、报告导出。

---

## 6. 垂直切片开发计划（执行级）

| 切片 | 目标 | 主要工作 | 依赖 | DoD |
|---|---|---|---|---|
| Slice 0 工程脚手架 | 搭建工作流最小骨架 | 新增 types 文件、API 模块壳、前端路由占位 | 无 | 可编译、可访问占位页 |
| Slice 1 流程定义管理 | 可创建/保存/版本化流程 | `WorkflowDefinition/Version` 模型 + CRUD + 草稿机制 | Slice 0 | 可保存 DSL 快照并查询版本历史 |
| Slice 2 DSL 校验引擎 | 发布前自动门禁 | 实现 WF001~WF105 + 基础前端错误提示 | Slice 1 | 违规 DSL 无法发布 |
| Slice 3 线性执行与回放 | 跑通最小闭环 | 执行实例、节点日志、证据链输出、回放页 | Slice 2 | 线性流程可触发、可回放 |
| Slice 4 参数与规则中心 | 参数外置和规则绑定 | `ParameterSet/Item`、`DecisionRulePack`、覆盖优先级解析 | Slice 3 | 流程运行可读取版本化参数与规则 |
| Slice 5 DAG 并行 | 支持并行/汇聚 | `parallel-split/join` 执行器，`joinPolicy` 策略 | Slice 4 | DAG 发布和运行成功率达标 |
| Slice 6 Agent 中心 | Agent 可配置化 | `AgentProfile`、`AgentPromptTemplate`、输出 schema 约束 | Slice 3 | 可配置并在节点中绑定 Agent |
| Slice 7 Debate 模式 | 多 Agent 辩论闭环 | `debate-round`、`judge-agent`、轮次回放 | Slice 6 | Debate 流程可逐轮重演 |
| Slice 8 On-Demand 能力 | API 按需触发 | `api-trigger`、鉴权、限流、超时控制 | Slice 5 | API 返回标准字段并可追踪 |
| Slice 9 A/B 灰度 | 同策略多版本并行 | `WorkflowExperiment/Run`、指标采集、自动止损 | Slice 8 | A/B 可运行并产出评估结果 |
| Slice 10 期货与模拟 | P2+ 增强能力 | 期货 Connector、虚拟持仓/流水、沙盘流程 | Slice 9 | 沙盘流程可回放和风险分析 |

---

## 7. 数据模型实施策略

### 7.1 P0 首批模型（必须先落地）
1. `WorkflowDefinition`
2. `WorkflowVersion`
3. `WorkflowExecution`
4. `NodeExecution`
5. `AgentProfile`
6. `AgentPromptTemplate`
7. `ParameterSet`
8. `ParameterItem`
9. `DecisionRulePack` / `DecisionRule`
10. `DecisionRecord`
11. `DataConnector`

### 7.2 分批迁移原则
1. 每次迁移只引入一个切片必要字段，避免大爆炸迁移。
2. 通过 `status`、`isActive`、`version` 做前向兼容，不做破坏性回写。
3. 大表（`NodeExecution`）上线即配置保留策略：在线 90 天 + 冷存归档。
4. 所有运行快照字段统一用 JSON 结构保存，并附 schemaVersion。

### 7.3 历史系统解耦策略
1. `Workflow*` 与 `IntelTask*` 严格分离，不共享表不共享流程状态机。
2. 只通过输入数据实体（如 `MarketIntel`、`PriceData`）做证据引用。
3. API 命名空间隔离，避免误调用旧任务接口。

---

## 8. API 与执行引擎落地蓝图

### 8.1 核心 API 分组
1. `/workflow-definitions`：流程元信息与版本管理。
2. `/workflow-validations`：保存前/发布前校验。
3. `/workflow-executions`：触发执行、实例查询、重跑。
4. `/workflow-replays`：节点快照、变量血缘、辩论轨迹。
5. `/agent-profiles`、`/agent-prompts`：Agent 管理。
6. `/parameter-sets`、`/decision-rule-packs`：参数规则管理。
7. `/data-connectors`：连接器注册与健康检查。
8. `/workflow-experiments`：A/B 灰度与指标。

### 8.2 执行引擎关键组件
1. `ExecutionPlanner`：根据 DSL 生成执行计划（线性/DAG/Debate）。
2. `NodeExecutorRegistry`：按 `nodeType` 分派执行器。
3. `RuntimeContext`：管理参数解析、变量映射、证据缓存、traceId。
4. `PolicyGuard`：超时、重试、降级、风控阻断。
5. `EvidenceCollector`：汇总三类证据并执行白名单校验。
6. `ReplayAssembler`：构建回放视图数据。

---

## 9. 前端实施蓝图（双端并行）

### 9.1 策略设计编排端（Studio）
1. 流程列表 + 版本管理 + 发布。
2. 画布编辑 + 节点属性面板 + 表单联动规则。
3. 参数映射与表达式配置。
4. 版本 diff 与模板复制。

### 9.2 运行回放分析端（Runtime/Replay）
1. 运行列表、状态监控、失败重跑。
2. 节点级输入输出快照。
3. 辩论逐轮回放（发言、质询、裁决）。
4. 报告导出（PDF/Word）。

### 9.3 页面上线顺序建议
1. P0：流程列表、线性编辑页、运行详情页。
2. P1：参数中心、规则中心、并行流程编辑能力。
3. P2：辩论回放页、导出中心、评估看板。

---

## 10. 测试与质量门禁

### 10.1 测试分层
1. 单元测试：节点执行器、参数解析器、DSL 校验器。
2. 集成测试：流程发布 -> 触发执行 -> 回放查询链路。
3. E2E（关键路径）：`LINEAR`、`DAG`、`DEBATE` 各至少 1 条冒烟流程。
4. 性能测试：`ON_DEMAND` P95 延迟、并行流程吞吐。

### 10.2 必过门禁
1. 代码门禁：`pnpm lint`、`pnpm type-check`。
2. 契约门禁：`packages/types` 与后端 DTO 编译一致。
3. 发布门禁：WF301~WF306 通过。
4. 隔离门禁：跨用户越权读写测试通过。

### 10.3 SLA 与指标
1. `ON_DEMAND`：P95 <= 30s。
2. 运行成功率：线性 >= 99%，DAG >= 98%。
3. 回放可用率：>= 99.5%。
4. 证据链完整率：生产发布建议 100% 满足三类证据配置。

---

## 11. 发布与运维策略

### 11.1 环境策略
1. `dev`：快速迭代和功能验证。
2. `staging`：灰度演练、性能压测、回放核验。
3. `prod`：分批放量，优先 `LINEAR` 后 `DAG` 再 `DEBATE`。

### 11.2 灰度与回滚
1. 流程版本灰度发布，保持旧版本可回放可切换。
2. A/B 失败自动止损：`badCaseThreshold=0.2`。
3. 回滚优先顺序：配置回滚 > 流程版本回滚 > 模块级回滚。

### 11.3 可观测性
1. 指标：运行耗时、节点失败率、模型超时率、证据缺失率。
2. 日志：流程级/节点级/Agent 轮次级统一 traceId。
3. 告警：SLA 超时、失败重试耗尽、外部连接器降级、风险阻断异常激增。

---

## 12. 角色分工（RACI 建议）

| 工作项 | 产品 | 架构/后端 | 前端 | 测试 | 运维/数据 |
|---|---|---|---|---|---|
| 范围冻结与优先级 | A | R | C | C | C |
| 数据模型与迁移 | C | A/R | I | C | C |
| 执行引擎与校验器 | C | A/R | C | C | I |
| Studio 与 Runtime 页面 | C | C | A/R | C | I |
| 连接器接入 | C | A/R | I | C | R |
| A/B 与指标看板 | C | R | R | C | A |
| 上线门禁与回滚 | I | R | C | C | A |

说明：`A=Accountable`，`R=Responsible`，`C=Consulted`，`I=Informed`。

---

## 13. 风险台账（首版）

| 风险 | 影响 | 概率 | 触发信号 | 缓解动作 | 责任方 |
|---|---|---|---|---|---|
| 需求范围持续膨胀 | 周期失控 | 高 | 单 Sprint 新增需求 > 20% | 设立变更评审会，冻结当期范围 | 产品/技术负责人 |
| DSL 与执行器语义不一致 | 发布失败或误执行 | 中 | 同 DSL 在不同环境结果不一致 | 统一校验器实现与契约测试 | 后端 |
| 证据链不完整 | 建议不可用 | 中 | 发布校验失败率升高 | 强制 EvidenceCollector 门禁 | 后端/测试 |
| 多租户隔离漏洞 | 数据安全风险 | 中 | 越权访问告警 | ownerUserId 全链路校验 + 安全测试 | 后端/测试 |
| 外部数据源不稳定 | 流程时延与失败升高 | 中 | 连接器超时率上升 | fallback connector + 缓存降级 | 后端/运维 |
| 回放数据量过大 | 存储成本与查询变慢 | 高 | NodeExecution 激增 | 90 天在线保留 + 冷存归档 + 索引优化 | 后端/运维 |

---

## 14. 待确认项与默认建议（用于 Phase 0 冻结）

| 待确认项 | 默认建议（若业务未在 Phase 0 前拍板） |
|---|---|
| 首批上线 5 条流程 | `晨间线性决策`、`全天候套利猎手`、`基差套利与套保建议`、`政策冲击辩论`、`下单前智能风险评估` |
| 首个期货数据源类型 | 先接“延时行情 REST API”，稳定后再接实时网关 |
| 实时与延时读取优先级 | `实时优先 -> 延时回退` |
| 虚拟持仓初始规则 | `单策略单账户 + 固定初始资金` |

---

## 15. 阶段验收模板（可复制到每次里程碑评审）

### 15.1 里程碑信息
1. 里程碑名称：
2. 时间范围：
3. 负责人：

### 15.2 交付核对
1. 功能清单是否全部完成（是/否）：
2. 是否通过 lint/type-check（是/否）：
3. 是否通过关键 E2E（是/否）：
4. 是否完成文档与 runbook 更新（是/否）：

### 15.3 指标结果
1. 执行成功率：
2. On-Demand P95：
3. 回放可用率：
4. 证据链完整率：

### 15.4 风险与改进行动
1. 本阶段主要风险：
2. 下阶段纠偏动作：
3. 需管理层决策事项：

---

## 16. 最终发布定义（Definition of Launch）

满足以下条件方可进入“首版对外可用”：
1. 三种编排模式至少各 1 条流程在生产可用并可回放。
2. 三种使用方式均可配置并通过联调验证。
3. 参数、规则、Agent、流程均支持版本化发布与追溯。
4. 用户隔离与权限策略通过安全测试。
5. A/B 灰度可执行并可自动止损。
6. 报告导出（PDF/Word）可用于 Debate 结果页。
7. 关键 SLA 达标并接入告警。

---

## 17. 执行建议（管理动作）

1. 本周启动 `Phase 0`，召开 1 次 2 小时冻结会，确认第 14 节待确认项。
2. 冻结后立即按 Slice 0~2 开工，优先跑通“可保存、可校验、可发布”主链路。
3. 从 Phase 1 起每两周做一次可运行演示，不以“代码完成”替代“流程可跑通”。

