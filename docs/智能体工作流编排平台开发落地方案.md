# 智能体工作流编排平台开发落地方案（实施版 v1.0）

## 文档信息
| 字段 | 内容 |
|---|---|
| 文档名称 | 智能体工作流编排平台开发落地方案 |
| 版本 | v1.0（实施基线） |
| 编制日期 | 2026-02-10 |
| 依据文档 | `docs/智能体工作流编排平台设计方案.md`（v2.6） |
| 适用仓库 | `CTBMS`（Turborepo + pnpm） |
| 目标读者 | 产品负责人、技术负责人、后端/前端/测试/运维 |

---

## 1. 背景与目标

### 1.1 背景
设计方案已经完成架构、数据模型、节点契约、DSL、参数体系和页面定义，但内容规模大、实施周期长，需要转化为可执行的分阶段研发计划和验收门禁。

### 1.2 总体目标
1. 在不推翻现有系统的前提下，构建统一的智能体工作流编排中枢。
2. 首期同时交付“策略设计编排端 + 运行回放分析端”。
3. 支持 `LINEAR`、`DAG`、`DEBATE` 三种编排模式和 `HEADLESS`、`COPILOT`、`ON_DEMAND` 三种使用方式。
4. 完成参数、规则、Agent、流程、执行实例的版本化与可追溯治理。
5. 首版满足玉米交易决策支持场景（建议系统，不直接自动下单）。

### 1.3 范围边界（本方案）
1. 包含：P0/P1/P2/P2+ 分阶段实施路径、模块拆分、里程碑、验收标准、风险台账。
2. 不包含：具体 UI 视觉稿、第三方期货数据供应商采购细则、生产部署拓扑细节。

### 1.4 冻结约束（直接承接设计稿）
1. P0 默认不强制审批节点（保留能力）。
2. 用户隔离为“个人私有 + 公共模板只读引用”，暂不启用团队共享。
3. Debate 默认手工触发，必须可回放逐轮过程。
4. 证据链必须覆盖：原文片段、指标快照、规则命中。
5. A/B 灰度首版必须可用，自动止损阈值默认 `badCaseThreshold=0.2`。
6. 运费数据 P0 采用手工维护（周更）+ 回退策略。

---

## 2. 现状基线与差距映射

| 领域 | 已有能力（可复用） | 关键差距 | 本方案动作 |
|---|---|---|---|
| AI 与 Prompt | `AIModelConfig`、`PromptTemplate`、`AIService` | 缺 Agent 专用配置和提示词隔离 | 新增 `AgentProfile`、`AgentPromptTemplate` |
| 商情数据 | `MarketIntel`、`PriceData`、`ResearchReport`、`KnowledgeItem` | 缺统一数据接入抽象 | 新增 `DataConnector` 注册表与执行器 |
| 调度能力 | `IntelTaskTemplate`、`IntelTaskRule` | 与新工作流目标不同 | 明确与 `IntelTask` 解耦，建立独立 workflow 体系 |
| 规则能力 | `ExtractionRule`、`MarketAlertRule` 等 | 缺决策规则包和统一优先级 | 新增 `DecisionRulePack/DecisionRule` |
| 前端能力 | AntD + React + 路由体系成熟 | 缺流程画布、运行回放、参数中心联动 | 新建工作流相关 feature 集群 |

---

## 3. 实施方法与工程原则

### 3.1 核心方法
1. 采用“垂直切片”推进，每个切片必须可演示、可测试、可回归。
2. 每个切片都覆盖 `packages/types -> apps/api -> apps/web` 全链路，不做长期半成品层开发。
3. 严格执行共享类型单一事实源：前后端 DTO/类型仅来自 `@packages/types`。

### 3.2 工程原则
1. 一类能力一个 Nest 模块，避免“超级模块”。
2. 流程定义与执行实例分离，执行必须绑定精确版本（`WorkflowVersion`）。
3. 运行期所有关键输入必须快照化（参数、规则、模型、Prompt、节点输入输出）。
4. 先做可观测性再做规模化，默认把回放和审计作为一等功能。
5. 所有阈值参数禁止硬编码，统一进入参数中心。

### 3.3 默认节奏
1. 迭代周期：2 周一个 Sprint。
2. 里程碑周期：4 周一个阶段评审（含演示与复盘）。
3. 每阶段出口必须通过 `pnpm lint`、`pnpm type-check` 和阶段验收清单。

---

## 4. 分阶段路线图（建议 27 周）

> 计划起点按 2026-02-16（周一）计算，可整体平移。

| 阶段 | 时间窗口 | 目标 | 关键交付 | 阶段出口（必须满足） |
|---|---|---|---|---|
| Phase 0 启动与冻结 | 2026-02-16 ~ 2026-02-27 | 冻结范围与技术基线 | 需求冻结单、模块蓝图、技术 Spike 结论 | 架构评审通过，待确认项形成决策草案 |
| Phase 1 P0 数据与契约 | 2026-03-02 ~ 2026-03-27 | 打通最小闭环数据层 | P0 模型迁移、`packages/types` 新增 workflow 类型、基础 CRUD API | 可创建流程定义/版本并保存 DSL 快照 |
| Phase 2 线性模式闭环 | 2026-03-30 ~ 2026-04-24 | 跑通 `LINEAR + COPILOT` | 执行引擎 v1、线性流程执行、回放页 v1、证据链校验 v1 | 线性流程可从手工触发到结果回放 |
| Phase 3 DAG 与参数规则中心 | 2026-04-27 ~ 2026-05-22 | 跑通并行能力与参数治理 | `join` 策略、参数中心 v1、规则包绑定、DAG 发布校验 | DAG 流程可发布并稳定执行 |
| Phase 4 Debate 与导出 | 2026-05-25 ~ 2026-06-26 | 跑通辩论流程与报告能力 | `DebateRoundTrace`、辩论回放、PDF/Word 导出、Judge 裁决链路 | Debate 场景端到端可演示 |
| Phase 5 触发与灰度治理 | 2026-06-29 ~ 2026-07-24 | 支持 `ON_DEMAND` 与 A/B | `api-trigger`、鉴权限流、实验配置与指标看板 | On-Demand P95 <= 30s，A/B 可并行 |
| Phase 6 期货与模拟增强 | 2026-07-27 ~ 2026-08-21 | 完成 P2+ 关键增强 | 期货连接器、虚拟持仓与流水、沙盘流程 | 期货模拟流程可回放与评估 |

---

## 5. 里程碑交付清单（按仓库目录落位）

### 5.1 共享类型层（`packages/types`）
1. 新增 `packages/types/src/modules/workflow.ts`：DSL、节点配置、校验错误码类型。
2. 新增 `packages/types/src/modules/agent-workflow.ts`：`AgentProfile`、`AgentPromptTemplate`、`DebateTrace` 类型。
3. 新增 `packages/types/src/modules/parameter-rule.ts`：`ParameterSet/Item`、`DecisionRulePack` 类型。
4. 更新 `packages/types/src/index.ts`：统一导出。
5. 每阶段必须 `pnpm --filter types build` 通过。

### 5.2 后端层（`apps/api`）
1. `apps/api/prisma/schema.prisma` 新增 P0/P1/P2/P2+ 模型。
2. 新增模块建议（按一功能一模块）：
   - `apps/api/src/modules/workflow-definition`
   - `apps/api/src/modules/workflow-execution`
   - `apps/api/src/modules/agent-profile`
   - `apps/api/src/modules/parameter-center`
   - `apps/api/src/modules/decision-rule`
   - `apps/api/src/modules/data-connector`
   - `apps/api/src/modules/decision-record`
   - `apps/api/src/modules/workflow-experiment`（P1）
   - `apps/api/src/modules/debate-trace`（P2）
   - `apps/api/src/modules/futures-sim`（P2+）
3. 执行器层建议：
   - `apps/api/src/modules/workflow-execution/engine/*`：节点执行器、连线调度器、运行上下文。
   - `apps/api/src/modules/workflow-execution/validators/*`：WF001~WF306 规则实现。

### 5.3 前端层（`apps/web`）
1. 新增 feature 目录建议：
   - `apps/web/src/features/workflow-studio`
   - `apps/web/src/features/workflow-runtime`
   - `apps/web/src/features/agent-center`
   - `apps/web/src/features/parameter-center`
   - `apps/web/src/features/rule-center`
   - `apps/web/src/features/trigger-gateway`
   - `apps/web/src/features/replay-evaluation`
2. 路由接入：`apps/web/src/routes/index.tsx` 新增工作流相关路由。
3. UI 关键能力优先级：
   - P0：流程列表、属性面板、线性链路编辑、手工触发、运行日志。
   - P1：并行分支可视化、版本 diff、参数覆盖对比。
   - P2：辩论时间线回放、裁决依据展示、报告导出。

---

## 6. 垂直切片开发计划（执行级）

| 切片 | 目标 | 主要工作 | 依赖 | DoD |
|---|---|---|---|---|
| Slice 0 工程脚手架 | 搭建工作流最小骨架 | 新增 types 文件、API 模块壳、前端路由占位 | 无 | 可编译、可访问占位页 |
| Slice 1 流程定义管理 | 可创建/保存/版本化流程 | `WorkflowDefinition/Version` 模型 + CRUD + 草稿机制 | Slice 0 | 可保存 DSL 快照并查询版本历史 |
| Slice 2 DSL 校验引擎 | 发布前自动门禁 | 实现 WF001~WF105 + 基础前端错误提示 | Slice 1 | 违规 DSL 无法发布 |
| Slice 3 线性执行与回放 | 跑通最小闭环 | 执行实例、节点日志、证据链输出、回放页 | Slice 2 | 线性流程可触发、可回放 |
| Slice 4 参数与规则中心 | 参数外置和规则绑定 | `ParameterSet/Item`、`DecisionRulePack`、覆盖优先级解析 | Slice 3 | 流程运行可读取版本化参数与规则 |
| Slice 5 DAG 并行 | 支持并行/汇聚 | `parallel-split/join` 执行器，`joinPolicy` 策略 | Slice 4 | DAG 发布和运行成功率达标 |
| Slice 6 Agent 中心 | Agent 可配置化 | `AgentProfile`、`AgentPromptTemplate`、输出 schema 约束 | Slice 3 | 可配置并在节点中绑定 Agent |
| Slice 7 Debate 模式 | 多 Agent 辩论闭环 | `debate-round`、`judge-agent`、轮次回放 | Slice 6 | Debate 流程可逐轮重演 |
| Slice 8 On-Demand 能力 | API 按需触发 | `api-trigger`、鉴权、限流、超时控制 | Slice 5 | API 返回标准字段并可追踪 |
| Slice 9 A/B 灰度 | 同策略多版本并行 | `WorkflowExperiment/Run`、指标采集、自动止损 | Slice 8 | A/B 可运行并产出评估结果 |
| Slice 10 期货与模拟 | P2+ 增强能力 | 期货 Connector、虚拟持仓/流水、沙盘流程 | Slice 9 | 沙盘流程可回放和风险分析 |

---

## 7. 数据模型实施策略

### 7.1 P0 首批模型（必须先落地）
1. `WorkflowDefinition`
2. `WorkflowVersion`
3. `WorkflowExecution`
4. `NodeExecution`
5. `AgentProfile`
6. `AgentPromptTemplate`
7. `ParameterSet`
8. `ParameterItem`
9. `DecisionRulePack` / `DecisionRule`
10. `DecisionRecord`
11. `DataConnector`

### 7.2 分批迁移原则
1. 每次迁移只引入一个切片必要字段，避免大爆炸迁移。
2. 通过 `status`、`isActive`、`version` 做前向兼容，不做破坏性回写。
3. 大表（`NodeExecution`）上线即配置保留策略：在线 90 天 + 冷存归档。
4. 所有运行快照字段统一用 JSON 结构保存，并附 schemaVersion。

### 7.3 历史系统解耦策略
1. `Workflow*` 与 `IntelTask*` 严格分离，不共享表不共享流程状态机。
2. 只通过输入数据实体（如 `MarketIntel`、`PriceData`）做证据引用。
3. API 命名空间隔离，避免误调用旧任务接口。

---

## 8. API 与执行引擎落地蓝图

### 8.1 核心 API 分组
1. `/workflow-definitions`：流程元信息与版本管理。
2. `/workflow-validations`：保存前/发布前校验。
3. `/workflow-executions`：触发执行、实例查询、重跑。
4. `/workflow-replays`：节点快照、变量血缘、辩论轨迹。
5. `/agent-profiles`、`/agent-prompts`：Agent 管理。
6. `/parameter-sets`、`/decision-rule-packs`：参数规则管理。
7. `/data-connectors`：连接器注册与健康检查。
8. `/workflow-experiments`：A/B 灰度与指标。

### 8.2 执行引擎关键组件
1. `ExecutionPlanner`：根据 DSL 生成执行计划（线性/DAG/Debate）。
2. `NodeExecutorRegistry`：按 `nodeType` 分派执行器。
3. `RuntimeContext`：管理参数解析、变量映射、证据缓存、traceId。
4. `PolicyGuard`：超时、重试、降级、风控阻断。
5. `EvidenceCollector`：汇总三类证据并执行白名单校验。
6. `ReplayAssembler`：构建回放视图数据。

---

## 9. 前端实施蓝图（双端并行）

### 9.1 策略设计编排端（Studio）
1. 流程列表 + 版本管理 + 发布。
2. 画布编辑 + 节点属性面板 + 表单联动规则。
3. 参数映射与表达式配置。
4. 版本 diff 与模板复制。

### 9.2 运行回放分析端（Runtime/Replay）
1. 运行列表、状态监控、失败重跑。
2. 节点级输入输出快照。
3. 辩论逐轮回放（发言、质询、裁决）。
4. 报告导出（PDF/Word）。

### 9.3 页面上线顺序建议
1. P0：流程列表、线性编辑页、运行详情页。
2. P1：参数中心、规则中心、并行流程编辑能力。
3. P2：辩论回放页、导出中心、评估看板。

---

## 10. 测试与质量门禁

### 10.1 测试分层
1. 单元测试：节点执行器、参数解析器、DSL 校验器。
2. 集成测试：流程发布 -> 触发执行 -> 回放查询链路。
3. E2E（关键路径）：`LINEAR`、`DAG`、`DEBATE` 各至少 1 条冒烟流程。
4. 性能测试：`ON_DEMAND` P95 延迟、并行流程吞吐。

### 10.2 必过门禁
1. 代码门禁：`pnpm lint`、`pnpm type-check`。
2. 契约门禁：`packages/types` 与后端 DTO 编译一致。
3. 发布门禁：WF301~WF306 通过。
4. 隔离门禁：跨用户越权读写测试通过。

### 10.3 SLA 与指标
1. `ON_DEMAND`：P95 <= 30s。
2. 运行成功率：线性 >= 99%，DAG >= 98%。
3. 回放可用率：>= 99.5%。
4. 证据链完整率：生产发布建议 100% 满足三类证据配置。

### 10.4 工作流专项回归（新增）
1. 本地/预发环境在提测前执行：`pnpm workflow:smoke`；涉及筛选组合改动时执行：`pnpm workflow:smoke:extended`。
2. 涉及历史数据修复时，先执行：`pnpm workflow:backfill:risk-summary:dry-run`。
3. 回填操作统一遵循 `docs/工作流冒烟与风控摘要回填操作手册.md`。

---

## 11. 发布与运维策略

### 11.1 环境策略
1. `dev`：快速迭代和功能验证。
2. `staging`：灰度演练、性能压测、回放核验。
3. `prod`：分批放量，优先 `LINEAR` 后 `DAG` 再 `DEBATE`。

### 11.2 灰度与回滚
1. 流程版本灰度发布，保持旧版本可回放可切换。
2. A/B 失败自动止损：`badCaseThreshold=0.2`。
3. 回滚优先顺序：配置回滚 > 流程版本回滚 > 模块级回滚。

### 11.3 可观测性
1. 指标：运行耗时、节点失败率、模型超时率、证据缺失率。
2. 日志：流程级/节点级/Agent 轮次级统一 traceId。
3. 告警：SLA 超时、失败重试耗尽、外部连接器降级、风险阻断异常激增。

---

## 12. 角色分工（RACI 建议）

| 工作项 | 产品 | 架构/后端 | 前端 | 测试 | 运维/数据 |
|---|---|---|---|---|---|
| 范围冻结与优先级 | A | R | C | C | C |
| 数据模型与迁移 | C | A/R | I | C | C |
| 执行引擎与校验器 | C | A/R | C | C | I |
| Studio 与 Runtime 页面 | C | C | A/R | C | I |
| 连接器接入 | C | A/R | I | C | R |
| A/B 与指标看板 | C | R | R | C | A |
| 上线门禁与回滚 | I | R | C | C | A |

说明：`A=Accountable`，`R=Responsible`，`C=Consulted`，`I=Informed`。

---

## 13. 风险台账（首版）

| 风险 | 影响 | 概率 | 触发信号 | 缓解动作 | 责任方 |
|---|---|---|---|---|---|
| 需求范围持续膨胀 | 周期失控 | 高 | 单 Sprint 新增需求 > 20% | 设立变更评审会，冻结当期范围 | 产品/技术负责人 |
| DSL 与执行器语义不一致 | 发布失败或误执行 | 中 | 同 DSL 在不同环境结果不一致 | 统一校验器实现与契约测试 | 后端 |
| 证据链不完整 | 建议不可用 | 中 | 发布校验失败率升高 | 强制 EvidenceCollector 门禁 | 后端/测试 |
| 多租户隔离漏洞 | 数据安全风险 | 中 | 越权访问告警 | ownerUserId 全链路校验 + 安全测试 | 后端/测试 |
| 外部数据源不稳定 | 流程时延与失败升高 | 中 | 连接器超时率上升 | fallback connector + 缓存降级 | 后端/运维 |
| 回放数据量过大 | 存储成本与查询变慢 | 高 | NodeExecution 激增 | 90 天在线保留 + 冷存归档 + 索引优化 | 后端/运维 |

---

## 14. 待确认项与默认建议（用于 Phase 0 冻结）

| 待确认项 | 默认建议（若业务未在 Phase 0 前拍板） |
|---|---|
| 首批上线 5 条流程 | `晨间线性决策`、`全天候套利猎手`、`基差套利与套保建议`、`政策冲击辩论`、`下单前智能风险评估` |
| 首个期货数据源类型 | 先接“延时行情 REST API”，稳定后再接实时网关 |
| 实时与延时读取优先级 | `实时优先 -> 延时回退` |
| 虚拟持仓初始规则 | `单策略单账户 + 固定初始资金` |

---

## 15. 阶段验收模板（可复制到每次里程碑评审）

### 15.1 里程碑信息
1. 里程碑名称：
2. 时间范围：
3. 负责人：

### 15.2 交付核对
1. 功能清单是否全部完成（是/否）：
2. 是否通过 lint/type-check（是/否）：
3. 是否通过关键 E2E（是/否）：
4. 是否完成文档与 runbook 更新（是/否）：

### 15.3 指标结果
1. 执行成功率：
2. On-Demand P95：
3. 回放可用率：
4. 证据链完整率：

### 15.4 风险与改进行动
1. 本阶段主要风险：
2. 下阶段纠偏动作：
3. 需管理层决策事项：

---

## 16. 最终发布定义（Definition of Launch）

满足以下条件方可进入“首版对外可用”：
1. 三种编排模式至少各 1 条流程在生产可用并可回放。
2. 三种使用方式均可配置并通过联调验证。
3. 参数、规则、Agent、流程均支持版本化发布与追溯。
4. 用户隔离与权限策略通过安全测试。
5. A/B 灰度可执行并可自动止损。
6. 报告导出（PDF/Word）可用于 Debate 结果页。
7. 关键 SLA 达标并接入告警。

---

## 17. 执行建议（管理动作）

1. 本周启动 `Phase 0`，召开 1 次 2 小时冻结会，确认第 14 节待确认项。
2. 冻结后立即按 Slice 0~2 开工，优先跑通“可保存、可校验、可发布”主链路。
3. 从 Phase 1 起每两周做一次可运行演示，不以“代码完成”替代“流程可跑通”。

---

## 18. 下一批小任务排期（滚动执行）

> 原则：每个小任务都要满足“可验证 + 可回滚 + 可交接”。

### 18.1 批次 A（本周，已落地/收口中）

| 任务ID | 小任务 | 输出物 | 验证命令 | 状态 |
|---|---|---|---|---|
| A-01 | 风控摘要筛选冒烟扩展（`hasRiskSummary + riskLevel/degradeAction`） | `apps/api/src/scripts/workflow-execution-has-risk-summary-smoke.ts` | `pnpm --filter api run workflow:has-risk-summary:smoke` | 已完成 |
| A-02 | 工作流专项 PR 模板门禁 | `.github/pull_request_template.md` | 提交 PR 时模板自动加载 | 已完成 |
| A-03 | 一键冒烟 CI（含 Postgres） | `.github/workflows/workflow-smoke.yml` | GitHub Actions `Workflow Smoke` | 已完成 |
| A-04 | 回填安全开关（`--overwrite` 双确认） | `backfill-workflow-risk-summary.ts` | `pnpm --filter api run workflow:risk-summary:backfill -- --overwrite`（预期报错） | 已完成 |
| A-05 | 执行筛选组合回归冒烟（扩展门禁） | `apps/api/src/scripts/workflow-execution-filters-smoke.ts`、`workflow:smoke:extended` | `pnpm workflow:smoke:extended` | 已完成 |
| A-06 | 回填审计增强（runId/批次进度/报告落盘） | `apps/api/src/scripts/backfill-workflow-risk-summary.ts` | `pnpm --filter api run workflow:risk-summary:backfill -- --dry-run --report-file=apps/api/logs/workflow-risk-summary-backfill-report.json` | 已完成 |

### 18.2 批次 B（下一步优先执行）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| B-01 | 执行列表筛选 E2E（集成门禁） | `apps/api/test/workflow-execution-filters.e2e-spec.ts` | 覆盖 `hasRiskSummary/hasRiskGateNode/riskLevel/degradeAction` 组合筛选并接入 CI | 已完成 |
| B-02 | 运行列表筛选 UI 对齐收口 | `apps/web/src/features/workflow-runtime/**` | 前端筛选项与 API 参数 1:1 映射，无硬编码，并支持 URL 参数回放 | 已完成 |
| B-03 | 回填审计结果落库（可检索） | `apps/api/prisma/*`、`apps/api/src/scripts/backfill-workflow-risk-summary.ts` | 回填批次可在数据库检索（非仅日志/JSON） | 已完成 |
| B-04 | 失败案例样本库 | `docs/workflow-smoke-cases.md` | 至少沉淀 10 条失败样本与处理方式 | 已完成 |

### 18.3 批次 C（并行准备）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| C-01 | 执行引擎关键路径性能基线 | `apps/api/test/perf/risk-gate-baseline.ts`、`docs/工作流执行引擎性能基线.md` | 提供基线数据（P50/P95）并记录环境配置 | 已完成 |
| C-02 | 风险闸门节点契约文档固化 | `docs/工作流节点契约-riskgate.md` | 输入/输出字段、默认值、异常路径完整 | 已完成 |
| C-03 | 发布前回归命令聚合 | 根 `package.json`（`workflow:smoke:gate`） | `pnpm workflow:smoke` + 关键业务回归可一键执行 | 已完成 |

### 18.4 批次 D（持续收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| D-01 | 冒烟执行器报告化 | `scripts/workflow-smoke-runner.mjs`、`logs/workflow-smoke-*.json` | `pnpm workflow:smoke:gate` 自动生成步骤级报告（含耗时/重试/失败摘要） | 已完成 |
| D-02 | 风险闸门契约回归增强 | `apps/api/src/scripts/risk-gate-contract-smoke.ts` | 覆盖阈值优先级、中文/数字风险等级、`hardBlock/degradeAction` 组合 | 已完成 |
| D-03 | 性能阈值门禁 | `apps/api/test/perf/risk-gate-baseline.ts`（阈值校验增强） | 支持基线阈值超限自动失败（P95 guardrail） | 已完成 |
| D-04 | CI 报告工件上传 | `.github/workflows/workflow-smoke.yml` | CI 失败时可下载 smoke/perf 报告进行定位 | 已完成 |
| D-05 | 运行手册收口 | `docs/工作流冒烟与风控摘要回填操作手册.md` | 门禁、报告、性能基线、排障流程统一对齐 | 已完成 |

### 18.5 批次 E（质量门禁增强）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| E-01 | 冒烟 gate 覆盖补齐（含 `has-risk-summary`） | `scripts/workflow-smoke-runner.mjs` | `pnpm workflow:smoke:gate` 包含 `has-risk-summary` 回归 | 已完成 |
| E-02 | 报告契约校验器 | `scripts/workflow-report-validate.mjs`、根 `package.json` | `pnpm workflow:reports:validate` 可校验 smoke/perf 报告结构并输出摘要 | 已完成 |
| E-03 | CI 报告汇总与结果延迟判定 | `.github/workflows/workflow-smoke.yml` | CI 在上传 artifact 与 summary 后再统一 fail/pass，定位信息完整 | 已完成 |
| E-04 | 文档对齐收口（二次） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md`、`docs/工作流执行引擎性能基线.md` | 命令、案例、基线字段与当前脚本行为一致 | 已完成 |

### 18.6 批次 F（本地门禁编排增强）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| F-01 | 本地质量门禁编排器 | `scripts/workflow-quality-gate-runner.mjs` | `workflow:quality:gate` 失败时仍完成全部步骤并生成统一报告 | 已完成 |
| F-02 | 质量门禁命令收口 | 根 `package.json` | `workflow:quality:gate` 切换为编排脚本入口，支持自定义摘要/报告路径 | 已完成 |
| F-03 | 操作手册与案例同步 | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 补充质量门禁报告路径与排障指引 | 已完成 |

### 18.7 批次 G（报告校验语义增强）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| G-01 | 报告校验严格模式 | `scripts/workflow-report-validate.mjs` | 支持 `--require-smoke-success/--require-smoke-mode/--require-perf-no-violations`，并在失败时仍产出 summary | 已完成 |
| G-02 | 本地质量门禁默认严格校验 | `scripts/workflow-quality-gate-runner.mjs` | 默认严格校验；支持 `--relaxed-validate` 调试降级 | 已完成 |
| G-03 | CI 严格报告校验对齐 | `.github/workflows/workflow-smoke.yml` | CI 报告校验步骤使用严格参数并保留 artifact/summary | 已完成 |
| G-04 | 文档与失败案例同步（三次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 严格校验参数、失败路径、排障动作与脚本一致 | 已完成 |

### 18.8 批次 H（门禁可靠性收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| H-01 | 同次运行报告绑定 | `scripts/workflow-quality-gate-runner.mjs` | quality gate 显式绑定本次 smoke/perf 报告路径并传递给校验步骤 | 已完成 |
| H-02 | 报告新鲜度校验 | `scripts/workflow-report-validate.mjs` | 支持 `--require-reports-generated-after` / `--max-report-age-ms`，并在失败时仍落盘 summary | 已完成 |
| H-03 | CI 质量门禁总报告上传 | `.github/workflows/workflow-smoke.yml` | 上传 `workflow-quality-gate-report`，Step Summary 展示 `failedStepIds` | 已完成 |
| H-04 | 质量门禁 DB 预检 | `scripts/workflow-quality-gate-runner.mjs` | smoke 启用时先做 DB 端口可达性检查，失败快速返回并落盘报告 | 已完成 |
| H-05 | perf 报告参数覆盖修复 | `apps/api/test/perf/risk-gate-baseline.ts` | CLI 参数按“后者覆盖前者”解析，quality gate 自定义报告路径可生效 | 已完成 |
| H-06 | 文档与排障同步（四次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 新鲜度参数、同次绑定、CI 报告定位路径一致 | 已完成 |

### 18.9 批次 I（持续优化，下一步）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| I-01 | 质量门禁校验参数透传增强 | `scripts/workflow-quality-gate-runner.mjs` | 支持将 `max-report-age-ms` 透传到报告校验步骤，防止旧报告混入 | 已完成 |
| I-02 | 质量报告一致性校验 | `scripts/workflow-report-validate.mjs` | 可选校验质量门禁总报告与 smoke/perf 报告的路径一致性 | 已完成 |
| I-03 | CI 质量报告可视化增强 | `.github/workflows/workflow-smoke.yml` | Step Summary 增加 smoke/perf 报告文件名与耗时摘要 | 已完成 |
| I-04 | 操作手册与案例补充（五次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 新增 I-01~I-03 的参数/失败路径/定位动作 | 已完成 |

### 18.10 批次 J（报告可追溯增强）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| J-01 | 质量门禁运行中预写报告 + 默认一致性透传 | `scripts/workflow-quality-gate-runner.mjs` | `report-validate` 默认携带 `--quality-gate-report` 且运行前存在质量报告文件 | 已完成 |
| J-02 | 报告校验 JSON 摘要输出 | `scripts/workflow-report-validate.mjs` | 支持 `--summary-json-file`，失败时仍落盘 JSON 摘要（含 validationErrors） | 已完成 |
| J-03 | CI JSON 摘要可视化与归档 | `.github/workflows/workflow-smoke.yml` | Step Summary 展示 JSON 校验状态/计数，artifact 上传 `workflow-reports-summary*.json` | 已完成 |
| J-04 | 文档与失败案例同步（六次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 新增 JSON 摘要参数、CI 定位路径、失败案例 | 已完成 |

### 18.11 批次 K（校验回归防护）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| K-01 | summary-json 路径一致性校验补齐 | `scripts/workflow-report-validate.mjs` | 当传入 `--summary-json-file` 且与质量总报告不一致时，校验失败并输出明确错误 | 已完成 |
| K-02 | 报告校验器脚本自检 | `scripts/workflow-report-validate-self-check.mjs`、根 `package.json` | 一键自检覆盖“成功/路径不一致失败/失败仍写摘要”三类场景 | 已完成 |
| K-03 | 文档与失败案例同步（七次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 增加 `workflow:reports:validate:self-check` 命令与故障定位说明 | 已完成 |

### 18.12 批次 L（门禁前置与摘要强校验）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| L-01 | 报告摘要 schema 版本断言 | `scripts/workflow-report-validate.mjs` | 支持 `--summary-json-schema-version`，不匹配时失败且仍落盘摘要 | 已完成 |
| L-02 | 质量门禁摘要成功断言 | `scripts/workflow-quality-gate-runner.mjs` | 支持 `--require-summary-json-success`，并在 `summary-json-assert` 步骤输出明确失败原因 | 已完成 |
| L-03 | CI 增加校验器自检预检 | `.github/workflows/workflow-smoke.yml` | 进入 DB/质量门禁前执行 `workflow:reports:validate:self-check`，失败立即阻断 | 已完成 |
| L-04 | 文档与失败案例同步（八次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 新增 schema 参数、`summary-json-assert` 失败路径与定位动作 | 已完成 |

### 18.13 批次 M（质量门禁自检与可观测性）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| M-01 | 质量门禁自检脚本 | `scripts/workflow-quality-gate-self-check.mjs`、根 `package.json` | 一键自检覆盖 `require-summary-json-success` 成功/失败（schema mismatch）路径 | 已完成 |
| M-02 | CI 质量门禁自检预检 | `.github/workflows/workflow-smoke.yml` | CI 在业务门禁前执行 `workflow:quality:gate:self-check`，回归时提前失败 | 已完成 |
| M-03 | CI Summary 增强（summary-json-assert） | `.github/workflows/workflow-smoke.yml` | Step Summary 展示 `summary-json-assert` 状态与失败原因摘要 | 已完成 |
| M-04 | 文档与失败案例同步（九次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 新增 `quality:gate:self-check` 命令与案例 `WF-SMOKE-022` | 已完成 |

### 18.14 批次 N（结构化断言收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| N-01 | 质量报告结构化 summary-json 断言 | `scripts/workflow-quality-gate-runner.mjs` | `summary.summaryJsonAssert` 固化 `status/reasonCode/reason/expected/actual` 字段 | 已完成 |
| N-02 | 质量门禁自检契约增强 | `scripts/workflow-quality-gate-self-check.mjs` | 自检明确断言 `summary.summaryJsonAssert` 成功/失败场景字段值 | 已完成 |
| N-03 | CI 结构化展示对齐 | `.github/workflows/workflow-smoke.yml` | Step Summary 优先读取结构化断言字段并展示 code/schema/输入状态 | 已完成 |
| N-04 | 文档与失败案例同步（十次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 新增结构化字段定位说明与案例 `WF-SMOKE-023` | 已完成 |

### 18.15 批次 O（报告摘要脚本化）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| O-01 | 质量门禁摘要渲染脚本 | `scripts/workflow-quality-gate-report-summary.mjs`、根 `package.json` | `workflow:quality:report:summary` 可输出统一 markdown 摘要，支持结构化断言字段 | 已完成 |
| O-02 | CI 摘要生成逻辑收口 | `.github/workflows/workflow-smoke.yml` | `Publish workflow report summary` 使用脚本代替内联 Node 片段 | 已完成 |
| O-03 | 文档与失败案例同步（十一次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 新增 summary 命令与案例 `WF-SMOKE-024` | 已完成 |

### 18.16 批次 P（报告摘要脚本全收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| P-01 | report-summary 脚本与自检 | `scripts/workflow-report-summary.mjs`、`scripts/workflow-report-summary-self-check.mjs`、根 `package.json` | `workflow:reports:summary`/`self-check` 可稳定输出 JSON 摘要视图 | 已完成 |
| P-02 | CI JSON 摘要内联逻辑脚本化 | `.github/workflows/workflow-smoke.yml` | `Publish workflow report summary` 使用 `workflow-report-summary.mjs`，移除内联 Node 片段 | 已完成 |
| P-03 | 文档与失败案例同步（十二次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 新增 summary 命令、自检命令与案例 `WF-SMOKE-025` | 已完成 |

### 18.17 批次 Q（CI 摘要聚合脚本化）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| Q-01 | CI 摘要聚合脚本 | `scripts/workflow-ci-step-summary.mjs`、根 `package.json` | 单脚本聚合 quality report + markdown summary + json summary，支持缺失文件提示 | 已完成 |
| Q-02 | CI 聚合脚本自检 | `scripts/workflow-ci-step-summary-self-check.mjs` | 覆盖“全文件存在”与“全部缺失”场景，输出稳定 | 已完成 |
| Q-03 | Workflow Smoke 摘要步骤收口 | `.github/workflows/workflow-smoke.yml` | `Publish workflow report summary` 改为调用 `workflow-ci-step-summary.mjs` 单命令 | 已完成 |
| Q-04 | 文档与失败案例同步（十三次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 新增 `workflow:ci:step-summary` 命令与案例 `WF-SMOKE-026` | 已完成 |

### 18.18 批次 R（摘要渲染共享层收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| R-01 | 提取共享摘要渲染器 | `scripts/workflow-summary-renderers.mjs` | 统一输出 quality gate 与 report validation markdown，字段映射单点维护 | 已完成 |
| R-02 | report-summary 接入共享渲染器 | `scripts/workflow-report-summary.mjs` | `workflow:reports:summary` 仅负责参数与 IO，渲染逻辑复用共享模块 | 已完成 |
| R-03 | CI 聚合脚本接入共享渲染器 | `scripts/workflow-ci-step-summary.mjs` | quality/json 摘要段复用共享模块并保持现有 self-check 通过 | 已完成 |
| R-04 | 文档与失败案例同步（十四次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 新增共享渲染器排障说明与案例 `WF-SMOKE-027` | 已完成 |

### 18.19 批次 S（共享渲染器回归门禁）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| S-01 | 共享渲染器自检脚本 | `scripts/workflow-summary-renderers-self-check.mjs`、根 `package.json` | 直接覆盖 `extract/render` 的 fallback、裁剪和 top-items 行为 | 已完成 |
| S-02 | CI 预检接入渲染器自检 | `.github/workflows/workflow-smoke.yml` | `Workflow Smoke` 在业务门禁前执行 `workflow:summary:renderers:self-check` | 已完成 |
| S-03 | CI 触发路径补齐 | `.github/workflows/workflow-smoke.yml` | 修改 `workflow-summary-renderers*.mjs` 时自动触发 smoke workflow | 已完成 |
| S-04 | 文档与失败案例同步（十五次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 新增渲染器自检命令与案例 `WF-SMOKE-028` | 已完成 |

### 18.20 批次 T（聚合自检入口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| T-01 | 聚合自检脚本 | `scripts/workflow-summary-self-check-all.mjs` | 顺序执行 report-validate/renderers/report-summary/ci-summary/quality-gate 五类自检，失败时输出失败 step id | 已完成 |
| T-02 | 根命令接入 | 根 `package.json` | 新增 `workflow:summary:self-check:all` 命令，供本地与 CI 统一调用 | 已完成 |

### 18.21 批次 U（CI 自检步骤收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| U-01 | CI 预检步骤合并 | `.github/workflows/workflow-smoke.yml` | 原多个 self-check step 合并为 `workflow:summary:self-check:all` 单 step，行为等价 | 已完成 |
| U-02 | CI 触发路径补齐 | `.github/workflows/workflow-smoke.yml` | 修改 `workflow-summary-self-check-all.mjs` 时自动触发 Workflow Smoke | 已完成 |

### 18.22 批次 V（文档与案例收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| V-01 | 手册补充聚合自检命令 | `docs/工作流冒烟与风控摘要回填操作手册.md` | 报告命令清单包含 `workflow:summary:self-check:all` | 已完成 |
| V-02 | 聚合自检排障说明 | `docs/工作流冒烟与风控摘要回填操作手册.md` | 常见问题新增聚合自检失败定位路径 | 已完成 |
| V-03 | 失败案例新增（十六次收口） | `docs/workflow-smoke-cases.md` | 新增案例 `WF-SMOKE-029` | 已完成 |

### 18.23 批次 W（聚合自检可观测增强）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| W-01 | 聚合自检报告落盘 | `scripts/workflow-summary-self-check-all.mjs` | 支持 `--report-file` 并默认输出 `logs/workflow-summary-self-check-report.json`，成功/失败均落盘 | 已完成 |
| W-02 | CI Step Summary 接入自检报告 | `scripts/workflow-ci-step-summary.mjs`、`scripts/workflow-summary-renderers.mjs` | Step Summary 新增 “Workflow Summary Self-Check Suite” 区块，支持缺失文件提示 | 已完成 |
| W-03 | CI 摘要脚本自检扩展 | `scripts/workflow-ci-step-summary-self-check.mjs`、`scripts/workflow-summary-renderers-self-check.mjs` | 覆盖自检报告存在/缺失与渲染契约，防止字段漂移 | 已完成 |
| W-04 | Workflow Smoke 路径与归档补齐 | `.github/workflows/workflow-smoke.yml` | 自检套件写入 report-file，Step Summary 透传 self-check-report-file，artifact 上传该报告 | 已完成 |
| W-05 | 文档与失败案例同步（十七次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 新增报告路径说明与案例 `WF-SMOKE-030` | 已完成 |

### 18.24 批次 X（聚合自检脚本自检闭环）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| X-01 | 聚合自检脚本自检 | `scripts/workflow-summary-self-check-all-self-check.mjs`、根 `package.json` | 覆盖“成功落盘报告 + 失败仍落盘且包含 failedStepIds/outputTail”场景 | 已完成 |
| X-02 | CI 预检接入聚合自检脚本自检 | `.github/workflows/workflow-smoke.yml` | 业务门禁前新增 `workflow:summary:self-check:all:self-check`，避免聚合脚本回归漏检 | 已完成 |
| X-03 | 文档与失败案例同步（十八次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 新增命令与案例 `WF-SMOKE-031` | 已完成 |

### 18.25 批次 Y（失败优先定位索引）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| Y-01 | 自检摘要增加首个失败索引 | `scripts/workflow-summary-renderers.mjs` | 输出 `First Failed Step/Command/Suggested Action`，默认 `N/A` | 已完成 |
| Y-02 | 摘要脚本回归断言增强 | `scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | 覆盖失败索引字段渲染，防止字段回退 | 已完成 |
| Y-03 | 手册定位路径增强（十九次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md` | 常见问题优先引导读取失败索引字段并执行建议动作 | 已完成 |

### 18.26 批次 Z（自检报告 schema 校验）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| Z-01 | 自检报告校验脚本 | `scripts/workflow-summary-self-check-report-validate.mjs`、根 `package.json` | 校验 `workflow-summary-self-check-report.json` 核心字段与 schemaVersion，失败仍输出校验摘要 JSON | 已完成 |
| Z-02 | 校验脚本自检 | `scripts/workflow-summary-self-check-report-validate-self-check.mjs` | 覆盖“成功/版本不匹配/结构错误”场景，确保失败路径可诊断 | 已完成 |
| Z-03 | CI 预检接入报告校验 | `.github/workflows/workflow-smoke.yml` | 业务门禁前执行 `workflow:summary:self-check:report:validate`，阻断无效自检报告进入后续流程 | 已完成 |

### 18.27 批次 AA（校验状态可视化收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AA-01 | CI 摘要接入报告校验块 | `scripts/workflow-ci-step-summary.mjs`、`scripts/workflow-summary-renderers.mjs` | Step Summary 增加 “Workflow Summary Self-Check Report Validation” 区块 | 已完成 |
| AA-02 | 摘要渲染与聚合自检回归 | `scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | 覆盖校验状态字段与缺失文件提示，防止展示层漂移 | 已完成 |
| AA-03 | 文档与失败案例同步（二十次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 新增校验命令、CI 定位路径与案例 `WF-SMOKE-032` | 已完成 |

### 18.28 批次 AB（质量门禁报告 schema 校验）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AB-01 | 质量门禁报告校验脚本 | `scripts/workflow-quality-gate-report-validate.mjs`、根 `package.json` | 校验 `workflow-quality-gate-report.json` 关键结构与 schemaVersion，失败仍输出校验摘要 JSON | 已完成 |
| AB-02 | 校验脚本自检 | `scripts/workflow-quality-gate-report-validate-self-check.mjs` | 覆盖“成功/版本不匹配/summary 结构错误”场景，确保失败路径可诊断 | 已完成 |
| AB-03 | 聚合自检入口纳管 | `scripts/workflow-summary-self-check-all.mjs`、`scripts/workflow-summary-self-check-all-self-check.mjs` | `workflow:summary:self-check:all` 覆盖 quality report 校验自检步骤并通过回归断言 | 已完成 |

### 18.29 批次 AC（质量门禁报告校验可视化收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AC-01 | CI 摘要接入 quality report 校验块 | `scripts/workflow-ci-step-summary.mjs`、`scripts/workflow-summary-renderers.mjs` | Step Summary 增加 “Workflow Quality Gate Report Validation” 区块并支持缺失文件提示 | 已完成 |
| AC-02 | 渲染与摘要自检扩展 | `scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | 覆盖 quality report 校验字段展示、top-items 裁剪与缺失 fallback | 已完成 |
| AC-03 | Workflow Smoke 收口 | `.github/workflows/workflow-smoke.yml` | CI 增加 quality report 校验自检、正式校验 step、artifact 归档与最终门禁阻断 | 已完成 |

### 18.30 批次 AD（文档与案例收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AD-01 | 手册补充 quality report 校验命令 | `docs/工作流冒烟与风控摘要回填操作手册.md` | 命令清单覆盖 `workflow:quality:report:validate` / `:self-check` 与 CI summary 参数 | 已完成 |
| AD-02 | 失败案例新增（二十一次收口） | `docs/workflow-smoke-cases.md` | 新增案例 `WF-SMOKE-033`，覆盖 quality gate report 校验失败定位 | 已完成 |

### 18.31 批次 AE（质量报告一致性校验增强）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AE-01 | 报告路径一致性校验 | `scripts/workflow-quality-gate-report-validate.mjs` | 增加 input report 与 `artifacts.qualityGateReportFile` 一致性校验，支持 `--allow-report-file-path-mismatch` 放宽 | 已完成 |
| AE-02 | options/artifacts 路径对齐校验 | `scripts/workflow-quality-gate-report-validate.mjs` | 增加 `options.*` 与 `artifacts.*` 路径匹配断言，支持 `--skip-artifact-option-path-check` 放宽 | 已完成 |
| AE-03 | 校验摘要失败索引增强 | `scripts/workflow-quality-gate-report-validate.mjs` | 输出 `firstValidationError`、`validationErrorCount`、`warningCount` 与路径校验统计，便于 CI 快速定位 | 已完成 |

### 18.32 批次 AF（可视化与自检收口增强）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AF-01 | CI 摘要展示一致性校验细节 | `scripts/workflow-summary-renderers.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | Quality report 校验块展示路径一致性字段、首条错误和建议动作 | 已完成 |
| AF-02 | 渲染器回归断言扩展 | `scripts/workflow-summary-renderers-self-check.mjs` | 覆盖新增字段（path match/mismatch count/first error/suggested action）渲染契约 | 已完成 |
| AF-03 | 校验器自检扩展 | `scripts/workflow-quality-gate-report-validate-self-check.mjs` | 覆盖“路径不一致失败/允许放宽通过/require-summary-json-assert 缺失失败”场景 | 已完成 |
| AF-04 | 文档与失败案例同步（二十二次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充新参数与排障路径，新增案例 `WF-SMOKE-034` | 已完成 |

### 18.33 批次 AG（质量校验失败索引结构化）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AG-01 | 校验器失败索引结构化输出 | `scripts/workflow-quality-gate-report-validate.mjs` | 校验摘要新增 `failureIndex.reasonCode/message/suggestedAction`，成功场景为 `null` | 已完成 |
| AG-02 | reasonCode 分类规则落地 | `scripts/workflow-quality-gate-report-validate.mjs` | 覆盖 schema/path/summaryJsonAssert/计数漂移/读取失败等高频失败类型 | 已完成 |
| AG-03 | 渲染器优先消费结构化索引 | `scripts/workflow-summary-renderers.mjs` | Quality report 校验块优先展示 `failureIndex`，并新增 `First Failure Reason Code` | 已完成 |
| AG-04 | 自检回归扩展 | `scripts/workflow-quality-gate-report-validate-self-check.mjs`、`scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | 覆盖 `failureIndex` reasonCode 断言，成功场景 `Suggested Action` 输出 `N/A` | 已完成 |
| AG-05 | 文档与失败案例同步（二十三次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 新增 `failureIndex` 排障说明与案例 `WF-SMOKE-035` | 已完成 |

### 18.34 批次 AH（首修命令结构化收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AH-01 | failureIndex 增加首修命令 | `scripts/workflow-quality-gate-report-validate.mjs` | `failureIndex` 增加 `suggestedCommand`，按 reasonCode 输出可直接执行命令 | 已完成 |
| AH-02 | 渲染层展示首修命令 | `scripts/workflow-summary-renderers.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | Quality report 校验块新增 `Suggested Command`，成功场景展示 `N/A` | 已完成 |
| AH-03 | 自检回归补齐 | `scripts/workflow-quality-gate-report-validate-self-check.mjs`、`scripts/workflow-summary-renderers-self-check.mjs` | 断言 schema/path/summary-json-assert/summary-counter 场景的 `suggestedCommand` 分类正确 | 已完成 |
| AH-04 | 文档与失败案例同步（二十四次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充首修命令使用方式，新增案例 `WF-SMOKE-036` | 已完成 |

### 18.35 批次 AI（校验引导共享层收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AI-01 | 提取 quality report 校验引导共享模块 | `scripts/workflow-quality-gate-validation-guidance.mjs` | 统一 `reasonCode -> suggestedAction/suggestedCommand` 映射，供 validator 与 renderer 复用 | 已完成 |
| AI-02 | 校验器/渲染器接入共享引导层 | `scripts/workflow-quality-gate-report-validate.mjs`、`scripts/workflow-summary-renderers.mjs` | 去重本地分支逻辑，failureIndex 与 fallback 引导保持一致 | 已完成 |
| AI-03 | 共享引导层自检与聚合纳管 | `scripts/workflow-quality-gate-validation-guidance-self-check.mjs`、`scripts/workflow-summary-self-check-all.mjs`、`scripts/workflow-summary-self-check-all-self-check.mjs`、根 `package.json` | 新增 guidance 自检命令并纳入聚合自检，聚合总步数断言同步 | 已完成 |
| AI-04 | 文档与失败案例同步（二十五次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 guidance 自检排障与命令，新增案例 `WF-SMOKE-037` | 已完成 |

### 18.36 批次 AJ（引导可观测元信息收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AJ-01 | failureIndex 元信息增强 | `scripts/workflow-quality-gate-validation-guidance.mjs`、`scripts/workflow-quality-gate-report-validate.mjs` | `failureIndex` 增加 `reasonCodeSource/guidanceVersion`，并复用共享 guidance 生成 | 已完成 |
| AJ-02 | 渲染层展示引导来源与版本 | `scripts/workflow-summary-renderers.mjs`、`scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | quality report 校验块新增 `Failure Reason Source`、`Guidance Version`，成功场景显示 `N/A` | 已完成 |
| AJ-03 | 校验器与 guidance 自检补齐 | `scripts/workflow-quality-gate-report-validate-self-check.mjs`、`scripts/workflow-quality-gate-validation-guidance-self-check.mjs` | 断言 `reasonCodeSource/guidanceVersion` 在分类与失败摘要场景下输出正确 | 已完成 |
| AJ-04 | 文档与失败案例同步（二十六次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 source 语义，新增案例 `WF-SMOKE-038` | 已完成 |

### 18.37 批次 AK（失败索引快照可视化收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AK-01 | quality report 校验块增加快照字段 | `scripts/workflow-summary-renderers.mjs` | 新增 `Failure Index Snapshot` 单行紧凑 JSON 展示，成功场景 `N/A`，长文本自动裁剪 | 已完成 |
| AK-02 | CI 摘要与渲染器兼容性自检扩展 | `scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | 覆盖正常 failureIndex、fallback 分类、legacy failureIndex（缺 source/version）三类场景 | 已完成 |
| AK-03 | 文档与失败案例同步（二十七次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 snapshot 语义与截断说明，新增案例 `WF-SMOKE-039` | 已完成 |

### 18.38 批次 AL（快照长度参数化收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AL-01 | CI summary 支持快照长度参数 | `scripts/workflow-ci-step-summary.mjs`、`.github/workflows/workflow-smoke.yml` | 支持 `--failure-index-snapshot-max-chars` 并透传到 quality report 校验块渲染，Workflow Smoke 默认传入 `200` | 已完成 |
| AL-02 | 截断行为自检扩展 | `scripts/workflow-ci-step-summary-self-check.mjs` | 覆盖 snapshot 截断场景，断言按设定长度输出并带 `...` 后缀 | 已完成 |
| AL-03 | 文档与失败案例同步（二十八次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充参数示例，新增案例 `WF-SMOKE-040` | 已完成 |

### 18.39 批次 AM（失败索引诊断统计收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AM-01 | 校验摘要增加 diagnostics 统计 | `scripts/workflow-quality-gate-report-validate.mjs`、`scripts/workflow-quality-gate-validation-guidance.mjs` | 输出 `failureIndexDiagnostics`（reasonCode/source/snapshot 计数与快照长度信息），成功场景可稳定回退默认值 | 已完成 |
| AM-02 | 渲染层展示 diagnostics 字段 | `scripts/workflow-summary-renderers.mjs` | quality report 校验块新增 diagnostics 统计行（含 snapshot raw/max/truncated 与 reasonCode/source map） | 已完成 |
| AM-03 | diagnostics 回归自检补齐 | `scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs`、`scripts/workflow-quality-gate-report-validate-self-check.mjs`、`scripts/workflow-quality-gate-validation-guidance-self-check.mjs` | 覆盖截断/计数/legacy 回退场景，防止统计字段回退或语义漂移 | 已完成 |
| AM-04 | 文档与失败案例同步（二十九次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 diagnostics 字段定位方式，新增案例 `WF-SMOKE-041` | 已完成 |

### 18.40 批次 AN（diagnostics 一致性契约收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AN-01 | 校验摘要增加 diagnostics consistency 契约 | `scripts/workflow-quality-gate-report-validate.mjs` | `failureIndexDiagnostics` 增加 `consistency.status/mismatchCount/mismatchReasons`，并对 count/map/snapshot 合法性做 PASS/FAILED 判定 | 已完成 |
| AN-02 | 渲染层展示 consistency 状态 | `scripts/workflow-summary-renderers.mjs` | quality report 校验块新增 `Diagnostics Consistency` 字段与 snapshot 契约行，缺失 consistency 时自动 fallback 计算 | 已完成 |
| AN-03 | consistency 回归自检补齐 | `scripts/workflow-quality-gate-report-validate-self-check.mjs`、`scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | 覆盖 success/failure/legacy/截断场景，断言 consistency 为 PASS 且 mismatchCount=0 | 已完成 |
| AN-04 | 文档与失败案例同步（三十次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 consistency 排障路径，新增案例 `WF-SMOKE-042` | 已完成 |

### 18.41 批次 AO（一致性失败样例与聚合快定位收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AO-01 | consistency=FAILED 显式样例自检 | `scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | 覆盖 `Diagnostics Consistency Status=FAILED` 与 `mismatchReasons` 展示断言，避免仅验证 PASS 路径 | 已完成 |
| AO-02 | 聚合自检快速定位提示 | `scripts/workflow-summary-self-check-all.mjs`、`scripts/workflow-summary-self-check-all-self-check.mjs` | 失败时输出 `quick locate`（建议重跑命令 + 首行错误）；聚合自检脚本自检断言通过 | 已完成 |
| AO-03 | 文档与失败案例同步（三十一次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 quick locate 使用方式，新增案例 `WF-SMOKE-043` | 已完成 |

### 18.42 批次 AP（聚合失败指纹契约收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AP-01 | 聚合自检报告增加失败指纹 | `scripts/workflow-summary-self-check-all.mjs`、`scripts/workflow-summary-self-check-all-self-check.mjs` | `summary.failureFingerprint` 输出 `stepId/command/exitCode/firstOutputLine/signature/hash`，失败日志带 fingerprint hash | 已完成 |
| AP-02 | 自检报告校验器接入指纹契约 | `scripts/workflow-summary-self-check-report-validate.mjs`、`scripts/workflow-summary-self-check-report-validate-self-check.mjs` | 校验 `failureFingerprint` 结构、hash 与 failed step 一致性；失败报告缺失指纹可被拦截 | 已完成 |
| AP-03 | 摘要渲染与 CI 视图接入指纹字段 | `scripts/workflow-summary-renderers.mjs`、`scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | Step Summary 展示 Failure Fingerprint 来源/步骤/哈希/签名；相关自检断言通过 | 已完成 |
| AP-04 | 文档与失败案例同步（三十二次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 failureFingerprint 排障路径，新增案例 `WF-SMOKE-044` | 已完成 |

### 18.43 批次 AQ（CI 首屏快定位索引收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AQ-01 | 新增 Quick Locate Index 渲染块 | `scripts/workflow-summary-renderers.mjs`、`scripts/workflow-summary-renderers-self-check.mjs` | 输出 `Workflow Quick Locate Index`，聚合 quality/self-check 的首屏定位字段（含 failure fingerprint hash） | 已完成 |
| AQ-02 | CI Step Summary 接入快定位索引 | `scripts/workflow-ci-step-summary.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | `workflow-ci-step-summary` 顶部固定输出 quick index，覆盖成功/缺失/自检失败指纹三类场景 | 已完成 |
| AQ-03 | 文档与失败案例同步（三十三次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 quick index 使用方式，新增案例 `WF-SMOKE-045` | 已完成 |

### 18.44 批次 AR（Quick Locate 自检回退与首修命令收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AR-01 | Quick Locate 新增自检首修字段 | `scripts/workflow-summary-renderers.mjs` | `Workflow Quick Locate Index` 新增 `Self-Check Suggested Command` 与 `Self-Check First Failed Output` 两行，失败时可直接复现 | 已完成 |
| AR-02 | 自检失败指纹缺失时的兼容回退 | `scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | legacy 报告 `summary.failureFingerprint=null` 且存在 failed step 时，Quick Locate 自动计算 `source=COMPUTED` 且输出 hash/command/首行错误 | 已完成 |
| AR-03 | 文档与失败案例同步（三十四次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 quick locate 新字段使用方式，新增案例 `WF-SMOKE-046` | 已完成 |

### 18.45 批次 AS（Quick Locate 质量门禁回退定位收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AS-01 | Quick Locate 增加质量门禁回退定位字段 | `scripts/workflow-summary-renderers.mjs` | 新增 `Quality Gate Suggested Command`、`Quality Gate First Failed Output`，在 quality validation 命令缺失时自动回退到 failed step 命令 | 已完成 |
| AS-02 | 质量回退定位自检扩展 | `scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | 覆盖“validation command 优先 + failed step 回退 + 缺失文件 N/A”三类场景，聚合自检链路通过 | 已完成 |
| AS-03 | 文档与失败案例同步（三十五次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 quality quick locate 回退定位说明，新增案例 `WF-SMOKE-047` | 已完成 |

### 18.46 批次 AT（Quick Locate 质量失败指纹收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AT-01 | Quick Locate 增加质量失败指纹字段 | `scripts/workflow-summary-renderers.mjs` | `Workflow Quick Locate Index` 新增 `Quality Failure Fingerprint Source/Step/Hash`，优先使用 `qualityReport.summary.failureFingerprint`，缺失时回退 failed step 计算 | 已完成 |
| AT-02 | 质量失败指纹自检扩展 | `scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | 覆盖 `SUMMARY/COMPUTED/N/A` 三类来源；失败 step 存在时断言 hash 非 `N/A`；聚合自检链路通过 | 已完成 |
| AT-03 | 文档与失败案例同步（三十六次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 quality failure fingerprint 排障路径，新增案例 `WF-SMOKE-048` | 已完成 |

### 18.47 批次 AU（Quick Locate 建议命令来源可视化收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AU-01 | Quick Locate 建议命令来源字段 | `scripts/workflow-summary-renderers.mjs` | 新增 `Quality Gate Suggested Command Source` 与 `Self-Check Suggested Command Source`，标记 `VALIDATION_FAILURE_INDEX/FAILURE_FINGERPRINT/FAILED_STEP/N/A` 来源 | 已完成 |
| AU-02 | 命令来源回归自检补齐 | `scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | 覆盖 validation 优先、failure fingerprint 回退、failed-step 回退、缺失文件四类来源路径 | 已完成 |
| AU-03 | 文档与失败案例同步（三十七次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 suggested command source 排障说明，新增案例 `WF-SMOKE-049` | 已完成 |

### 18.48 批次 AV（来源契约与优先级说明收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AV-01 | 建议命令来源枚举常量收口 | `scripts/workflow-summary-renderers.mjs` | 新增并导出 quality/self-check 的 suggested command source 常量与优先级常量，渲染与解析统一复用，避免字符串漂移 | 已完成 |
| AV-02 | 来源契约与优先级自检扩展 | `scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | 增加枚举契约断言；Quick Locate 输出来源优先级说明行，CI 场景断言覆盖通过 | 已完成 |
| AV-03 | 文档与失败案例同步（三十八次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 suggested command source priority 排障路径，新增案例 `WF-SMOKE-050` | 已完成 |

### 18.49 批次 AW（Quick Locate 首修路径标识收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AW-01 | Quick Locate 增加首修路径标识 | `scripts/workflow-summary-renderers.mjs` | `Workflow Quick Locate Index` 新增 `Quality Gate First Fix Route` 与 `Self-Check First Fix Route`，并按 `Suggested Command Source` 稳定映射首修路径常量 | 已完成 |
| AW-02 | 首修路径回归自检补齐 | `scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | 覆盖 `VALIDATION_FAILURE_INDEX/FAILURE_FINGERPRINT/FAILED_STEP/N/A` 主要路径，断言 route 与 source 一一对应 | 已完成 |
| AW-03 | 文档与失败案例同步（三十九次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 first-fix-route 排障规范，新增案例 `WF-SMOKE-051` | 已完成 |

### 18.50 批次 AX（聚合自检 quick locate 路径标识收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AX-01 | 聚合自检 quick locate 增加路径标识 | `scripts/workflow-summary-self-check-all.mjs` | 失败日志新增 `command source priority`、`command source`、`first fix route`，并按 `STEP_OVERRIDE > FAILED_STEP > N/A` 映射稳定输出 | 已完成 |
| AX-02 | 聚合自检契约回归补齐 | `scripts/workflow-summary-self-check-all-self-check.mjs` | 失败场景断言新增 quick locate source/route 字段，确保 stderr 契约不回退 | 已完成 |
| AX-03 | 文档与失败案例同步（四十次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充聚合 quick locate 首修路径说明，新增案例 `WF-SMOKE-052` | 已完成 |

### 18.51 批次 AY（聚合 quick locate 结构化透出收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AY-01 | 聚合报告写入 quick locate 结构化字段 | `scripts/workflow-summary-self-check-all.mjs` | `summary` 增加 `quickLocateCommandSourcePriority/source/firstFixRoute/command/firstFailedOutput`，失败与成功场景均有稳定默认值 | 已完成 |
| AY-02 | 聚合自检补 `FAILED_STEP` 来源用例 | `scripts/workflow-summary-self-check-all-self-check.mjs` | 新增禁用 override 的失败场景，断言 `command source=FAILED_STEP`、`first fix route=RERUN_FAILED_STEP_COMMAND` 且报告字段一致 | 已完成 |
| AY-03 | CI 摘要消费结构化 quick locate | `scripts/workflow-summary-renderers.mjs`、`scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | `Workflow Summary Self-Check Suite` 展示 quick locate source/route/command/first-output；有结构化字段时优先消费，无字段时保持 legacy 回退 | 已完成 |
| AY-04 | 文档与失败案例同步（四十一次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 summary quick locate 结构化字段排障说明，新增案例 `WF-SMOKE-053` | 已完成 |

### 18.52 批次 AZ（self-check report quick locate 契约收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| AZ-01 | self-check report 校验器补 quick locate 契约与透出 | `scripts/workflow-summary-self-check-report-validate.mjs`、`scripts/workflow-summary-self-check-report-validate-self-check.mjs` | 校验器验证 `summary.quickLocate*` 的 source/route/command 一致性，并在 validation summary `report` 中结构化输出 | 已完成 |
| AZ-02 | self-check report validation 块展示 quick locate 字段 | `scripts/workflow-summary-renderers.mjs`、`scripts/workflow-summary-renderers-self-check.mjs`、`scripts/workflow-ci-step-summary-self-check.mjs` | `Workflow Summary Self-Check Report Validation` 新增 `Report Quick Locate *` 行；自检覆盖 `N/A` 默认值与 `FAILED_STEP` 显式值 | 已完成 |
| AZ-03 | 文档与失败案例同步（四十二次收口） | `docs/工作流冒烟与风控摘要回填操作手册.md`、`docs/workflow-smoke-cases.md` | 手册补充 quick locate route/source 不一致排障说明，新增案例 `WF-SMOKE-054` | 已完成 |

### 18.53 执行机制

1. 每次最多并行 2~3 个小任务，避免上下游冲突。
2. 每完成一批次，必须更新本节“状态”和“验收结果”。
3. 阻塞超过半天（环境、依赖、数据）即升级为风险项，进入第 13 节台账。

## 19. 大批次推进计划（重排）

为解决“小任务推进慢、主链路收敛慢”问题，后续按“纵向可验收能力”分批交付，不再以脚本微调为主线。

### 19.1 批次 P1（后端主链路 MVP）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| P1-01 | 流程发布后自动草稿版本策略 | `apps/api/src/modules/workflow-definition/workflow-definition.service.ts` | 发布 `PUBLISHED` 版本后自动创建下一草稿版本，并更新 `WorkflowDefinition.latestVersionCode` | 已完成 |
| P1-02 | 发布审计模型与查询接口 | `apps/api/prisma/schema.prisma`、`apps/api/prisma/migrations/20260211160000_add_workflow_publish_audit_and_runtime_events/migration.sql`、`apps/api/src/modules/workflow-definition/**` | 新增 `WorkflowPublishAudit` 并提供 `GET /workflow-definitions/:id/publish-audits` | 已完成 |
| P1-03 | 运行时事件时间线模型与接口 | `apps/api/prisma/schema.prisma`、`apps/api/src/modules/workflow-execution/**` | 新增 `WorkflowRuntimeEvent`，执行链路写入事件；支持 `GET /workflow-executions/:id/timeline` | 已完成 |
| P1-04 | 类型契约扩展（定义/执行） | `packages/types/src/modules/workflow.ts`、`apps/api/src/modules/**/dto/*` | 新增 publish-audit/runtime-event 相关 schema 与 query/page dto，API 统一走 `@packages/types` | 已完成 |
| P1-05 | 主链路 e2e 回归 | `apps/api/test/workflow-p1-core.e2e-spec.ts`、`apps/api/package.json` | 覆盖“定义->新版本->发布->审计->执行->时间线”链路，测试通过 | 已完成 |

### 19.2 批次 P2（执行可靠性与控制）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| P2-01 | 执行取消能力（API + 状态流转） | `apps/api/src/modules/workflow-execution/**` | 新增 `POST /workflow-executions/:id/cancel`；支持取消 `RUNNING/PENDING` 实例，并在触发链路中感知取消状态 | 已完成 |
| P2-02 | 幂等触发键与重复执行防护 | `apps/api/prisma/schema.prisma`、`apps/api/src/modules/workflow-execution/**` | `Trigger` 支持 `idempotencyKey`，同 `workflowVersionId + triggerUserId + idempotencyKey` 命中时复用已有执行实例 | 已完成 |
| P2-03 | 节点失败分类与统一错误码 | `apps/api/src/modules/workflow-execution/**`、`packages/types/src/modules/workflow.ts` | `WorkflowExecution/NodeExecution` 增加 `failureCategory/failureCode`，覆盖超时、取消、执行失败分类，并可用于查询过滤 | 已完成 |
| P2-04 | 执行策略可配置化（超时/重试/退避） | `apps/api/src/modules/workflow-definition/**`、`apps/api/src/modules/workflow-execution/**` | 基于 `dsl.runPolicy/node.runtimePolicy` 的透传已生效；下一步补前端配置入口与发布前策略校验 | 进行中 |

### 19.3 批次 P3（前端编排与运行监控 MVP）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| P3-01 | 工作流定义列表与版本管理页 | `apps/web/src/features/workflow-*` | 可查看定义、版本、发布记录 | 未开始 |
| P3-02 | 运行实例列表与时间线回放页 | `apps/web/src/features/workflow-runtime/**` | 可查看运行详情、节点执行、runtime timeline | 未开始 |
| P3-03 | 发布审计与运行筛选联动 | `apps/web/src/features/workflow-*` | 前端筛选项与后端 query 1:1 对齐 | 未开始 |

### 19.4 批次 P4（上线收口）

| 任务ID | 小任务 | 输出物 | 验收标准 | 状态 |
|---|---|---|---|---|
| P4-01 | 权限与审计收口 | `apps/api/src/modules/*`、`apps/web/src/features/*` | 发布/执行/回放权限边界清晰，审计字段完整 | 未开始 |
| P4-02 | 观测指标与告警基线 | `scripts/*`、`docs/*` | 成功率/失败率/耗时可监控，异常可告警 | 未开始 |
| P4-03 | 部署与回滚 Runbook 收口 | `DEPLOYMENT.md`、`docs/*` | 支持灰度发布与快速回滚演练 | 未开始 |
