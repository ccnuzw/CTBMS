# 工作流执行引擎性能基线

## 1. 目的

建立 `risk-gate` 关键执行路径的性能基线，作为后续优化与回归对比的统一基准。

## 2. 基线脚本

1. 脚本：`apps/api/test/perf/risk-gate-baseline.ts`
2. 命令：`pnpm --filter api run workflow:perf:risk-gate`
3. 门禁命令（含阈值）：`pnpm --filter api run workflow:perf:risk-gate:gate`
4. 报告文件：`apps/api/logs/workflow-perf-risk-gate-baseline.json`

## 3. 测试环境

1. 采样时间（UTC）：`2026-02-10T17:47:07.759Z`
2. Node：`v22.20.0`
3. 平台：`darwin x64`
4. 采样参数：`iterations=2000`、`warmup=200`
5. 报告 schema：`schemaVersion=1.0`

## 4. 结果（P50/P95）

| 场景                   | 描述                         | P50(ms) | P95(ms) | P99(ms) | Avg(ms) |
| ---------------------- | ---------------------------- | ------: | ------: | ------: | ------: |
| `pass-low-risk`        | 低风险通过（无 blocker）     |  0.0032 |  0.0044 |  0.0083 |  0.0036 |
| `soft-block-high-risk` | 高风险阻断（soft block）     |  0.0036 |  0.0047 |  0.0092 |  0.0050 |
| `hard-block-by-rule`   | 规则命中硬阻断（hard block） |  0.0055 |  0.0069 |  0.0220 |  0.0061 |

## 5. 观察与结论

1. 常规决策路径（通过/软阻断）P95 稳定在 `0.0044~0.0047ms`。
2. 软阻断场景出现单点长尾（max `2.2358ms`），但 P95/P99 仍稳定在阈值以内。
3. 硬阻断场景 P95 `0.0069ms`，max `0.1301ms`，整体低于当前 guardrail。
4. 作为当前版本基线，可用阈值建议：
   - 常规路径：P95 不高于 `0.03ms`
   - 硬阻断路径：P95 不高于 `0.04ms`
5. 当前门禁阈值检查结果：全部通过（`thresholdCheck.violations = []`）。

## 6. 使用建议

1. 每次修改 `risk-gate` 逻辑后执行 `pnpm workflow:perf:risk-gate`。
2. 若 P95 超过基线阈值，需在 PR 描述中给出原因与优化策略。
3. 与功能门禁配合执行：`pnpm workflow:smoke:gate`。
4. 每次门禁后执行报告契约校验：`pnpm workflow:reports:validate`。

## 7. 扩展基线（ON_DEMAND / DAG）

在保留 `risk-gate` 微基线的同时，新增执行实例维度的专项门禁：

1. On-Demand 基线：`pnpm workflow:execution:baseline:on-demand`。
2. On-Demand 门禁：`pnpm workflow:execution:baseline:on-demand:gate`。
3. DAG 基线：`pnpm workflow:execution:baseline:dag`。
4. DAG 门禁：`pnpm workflow:execution:baseline:dag:gate`。

说明：以上命令基于 `workflow-execution-baseline.ts` 的筛选参数（`--trigger-type`、`--mode`、`--usage-method`）实现，报告在“无样本窗口”下会输出 warnings 并避免误报阻断。
