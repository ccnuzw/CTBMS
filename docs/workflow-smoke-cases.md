# Workflow Smoke Failure Cases

## 1. Purpose
This document records common workflow smoke failure cases and their handling playbook.

## 2. Failure Samples

| Case ID | Symptom | Typical Root Cause | Verify Command | Handling |
|---|---|---|---|---|
| WF-SMOKE-001 | `PrismaClientInitializationError: Can't reach database server` | Local Postgres is not running or `DATABASE_URL` points to wrong host/port | `pnpm --filter api exec prisma migrate status` | Start Postgres, verify `apps/api/.env`, then rerun smoke |
| WF-SMOKE-002 | `P3005` / migration pending during smoke | Current DB schema is behind code migration | `pnpm --filter api exec prisma migrate deploy` | Apply migrations before running smoke/e2e |
| WF-SMOKE-003 | `Execution with summary must not be returned when hasRiskSummary=false` assertion failed | `buildAccessibleWhere` hasRiskSummary condition changed incorrectly | `pnpm --filter api run workflow:has-risk-summary:smoke` | Check `workflow-execution.service.ts` JSON path filter logic |
| WF-SMOKE-004 | `hasRiskGateNode=false` still returns risk node executions | Node type storage changed (not `risk-gate`) or filter clause regressed | `pnpm --filter api run workflow:execution-filters:smoke` | Verify node type constants and `nodeExecutions.none` condition |
| WF-SMOKE-005 | `riskLevel=HIGH` query returns empty | `riskGate.riskLevel` not written to `outputSnapshot` or fallback node query broken | `pnpm --filter api run workflow:execution-filters:smoke` | Validate execution snapshot and node snapshot fields |
| WF-SMOKE-006 | `degradeAction=HOLD` query mismatch | Degrade action enum changed without query/schema alignment | `pnpm --filter api run workflow:execution-filters:smoke` | Align `@packages/types` enum and backend query conditions |
| WF-SMOKE-007 | `startedAtFrom 不能晚于 startedAtTo` | Invalid query parameters in UI or test data | `pnpm --filter api run workflow:execution-filters:smoke` | Correct query param order and add UI guard |
| WF-SMOKE-008 | `UnauthorizedException: User not authenticated` in API tests | Missing `x-virtual-user-id` header in test request | `pnpm --filter api run test:e2e:workflow-execution-filters` | Add header in test helper or middleware chain |
| WF-SMOKE-009 | `runId already exists` while persisting backfill audit | Reused runId in custom scripts or manual insert conflict | `pnpm --filter api run workflow:risk-summary:backfill -- --dry-run` | Ensure runId is generated per run and avoid manual duplicates |
| WF-SMOKE-010 | Backfill report shows `eligible > 0` but `updated = 0` unexpectedly | Missing `--overwrite` for existing summary or summary extraction failed | `pnpm --filter api run workflow:risk-summary:backfill -- --dry-run --limit=200` | Check mode (`only-missing` vs `overwrite`) and inspect failure samples |
| WF-SMOKE-011 | `workflow-report-validate` reports missing/invalid `schemaVersion` | Smoke/perf report generated by旧脚本或文件被手工修改 | `pnpm workflow:reports:validate` | 重新执行 `pnpm workflow:quality:gate` 生成新报告并重试校验 |
| WF-SMOKE-012 | `RiskGate perf threshold exceeded` | 风险闸门逻辑回归或机器负载异常导致 P95 超阈值 | `pnpm workflow:perf:risk-gate:gate` | 先复测，若稳定超阈值则分析 `apps/api/logs/workflow-perf-risk-gate-baseline.json` 并优化路径 |
| WF-SMOKE-013 | `workflow:quality:gate` fails with `failed steps: ...` | One or more downstream gates failed; aggregated runner keeps execution but returns final fail | `pnpm workflow:quality:gate` + `cat logs/workflow-quality-gate-report.json` | Read `summary.failedStepIds`, then rerun failed steps individually for targeted fix |
| WF-SMOKE-014 | `workflow-report-validate` strict mode fails (`Smoke report status must be SUCCESS`) | Latest smoke gate failed or report file is stale from previous failed run | `pnpm workflow:reports:validate:strict` | Rerun smoke/perf gates first, then rerun strict report validation |
| WF-SMOKE-015 | `workflow-report-validate` reports stale report timestamp | Validation enabled freshness constraints and loaded report is older than required boundary | `pnpm workflow:reports:validate -- --require-reports-generated-after=<ISO>` | Regenerate reports in the same run (recommended: `pnpm workflow:quality:gate`) and retry validation |
| WF-SMOKE-016 | `workflow:quality:gate` fails on `db-preflight` | Database host/port unreachable or `DATABASE_URL` malformed before smoke starts | `pnpm workflow:quality:gate -- --skip-perf --skip-validate` | Fix DB connectivity first; keep preflight enabled in normal runs |
| WF-SMOKE-017 | `workflow-report-validate` reports quality-gate path mismatch | Quality gate report references different smoke/perf summary file than current validation inputs | `pnpm workflow:reports:validate -- --quality-gate-report=logs/workflow-quality-gate-report.json --require-quality-gate-success` | Use reports from the same run, or rerun `workflow:quality:gate` to regenerate a consistent report set |
| WF-SMOKE-018 | `workflow-reports-summary.json` status is `FAILED` with validationErrors > 0 | Strict validator hit stale/missing/mismatch report constraints, but still wrote JSON summary for diagnosis | `pnpm workflow:reports:validate:strict -- --summary-json-file=logs/workflow-reports-summary.json` | Open JSON and inspect `validationErrors`; fix upstream smoke/perf/report path, then rerun quality gate |
| WF-SMOKE-019 | `workflow:reports:validate:self-check` fails | Report validator behavior regressed (e.g., mismatch detection lost or failure path not writing summaries) | `pnpm workflow:reports:validate:self-check` | Inspect failing case under printed temp root, fix validator logic, rerun self-check then quality gate |
| WF-SMOKE-020 | `workflow:quality:gate` fails with `summary-json-assert` | JSON summary status/schema invalid, or validator produced non-success summary under strict gate | `pnpm workflow:quality:gate -- --require-summary-json-success` | Open `logs/workflow-quality-gate-report.json`, inspect `summary-json-assert` step outputTail, then fix validator input/constraints |
| WF-SMOKE-021 | `Summary json schema version mismatch: expected X, actual Y` | `--summary-json-schema-version` / `--validate-summary-json-schema-version` uses wrong expected value | `pnpm workflow:reports:validate -- --summary-json-schema-version=1.0 --summary-json-file=logs/workflow-reports-summary.json` | Align expected schema version with current validator output, then rerun self-check and quality gate |
| WF-SMOKE-022 | `workflow:quality:gate:self-check` fails | Quality gate runner behavior regressed (e.g., no `summary-json-assert`, or mismatch path no longer fails) | `pnpm workflow:quality:gate:self-check` | Inspect reported failing case and temp artifacts, patch runner/validator interaction, rerun both self-check suites |
| WF-SMOKE-023 | `summary.summaryJsonAssert` missing or malformed in quality report | Runner/report schema drift causes CI summary parser to lose structured assert diagnostics | `pnpm workflow:quality:gate:self-check` + `cat logs/workflow-quality-gate-report.json` | Ensure `summary.summaryJsonAssert` includes status/reasonCode/expectedSchemaVersion/actualSchemaVersion and rerun gate |
| WF-SMOKE-024 | `workflow:quality:report:summary` fails to render quality report | Report file path wrong, JSON damaged, or report produced by unexpected script version | `pnpm workflow:quality:report:summary -- --report-file=logs/workflow-quality-gate-report.json` | Verify report path/content first; regenerate report via `workflow:quality:gate` and rerun summary command |
| WF-SMOKE-025 | `workflow:reports:summary` output missing expected fields | Report summary JSON schema changed or script parsing mismatch | `pnpm workflow:reports:summary:self-check` | Fix `workflow-report-summary.mjs` field mapping, rerun self-check and CI smoke workflow |
| WF-SMOKE-026 | `workflow:ci:step-summary` output lacks one or more blocks | CI aggregation script received wrong file paths or upstream artifacts are missing | `pnpm workflow:ci:step-summary:self-check` | Validate command args and upstream artifact generation; ensure aggregator script is invoked after quality/report steps |
| WF-SMOKE-027 | `workflow:reports:summary` and `workflow:ci:step-summary` render inconsistent fields | Shared markdown mapping drifted between renderer and caller scripts after refactor | `pnpm workflow:reports:summary:self-check` + `pnpm workflow:ci:step-summary:self-check` | Fix `scripts/workflow-summary-renderers.mjs` mapping first, then rerun both self-check suites and quality gate |
| WF-SMOKE-028 | `workflow:summary:renderers:self-check` fails | Shared renderer fallback/truncation contract regressed, causing downstream summary scripts to drift | `pnpm workflow:summary:renderers:self-check` | Fix `scripts/workflow-summary-renderers.mjs`, rerun renderer self-check then rerun report/CI summary self-check suites |
| WF-SMOKE-029 | `workflow:summary:self-check:all` fails before running quality gate | One or more self-check scripts regressed, and aggregate suite stopped at first failed step | `pnpm workflow:summary:self-check:all` | Read failed step id in aggregate output, fix that self-check/script first, then rerun aggregate suite |
| WF-SMOKE-030 | CI Step Summary missing self-check suite block | Self-check report file not generated/collected, or summary script not passed `--self-check-report-file` | `pnpm workflow:summary:self-check:all -- --report-file=logs/workflow-summary-self-check-report.json` + `pnpm workflow:ci:step-summary -- --self-check-report-file=logs/workflow-summary-self-check-report.json` | Ensure aggregate self-check writes report, and keep CI summary command/report path aligned |
| WF-SMOKE-031 | `workflow:summary:self-check:all:self-check` fails | Aggregate self-check contract regressed (e.g., failed path no longer writes report, or failedStepIds missing) | `pnpm workflow:summary:self-check:all:self-check` | Fix `workflow-summary-self-check-all.mjs` report schema/output, then rerun aggregate self-check and full suite |
| WF-SMOKE-032 | `workflow:summary:self-check:report:validate` fails | Self-check report schema drifted (schemaVersion/summary/steps contract changed) or report file path mismatch | `pnpm workflow:summary:self-check:report:validate -- --report-file=logs/workflow-summary-self-check-report.json --summary-json-file=logs/workflow-summary-self-check-validation.json --expected-report-schema-version=1.0` | Inspect `logs/workflow-summary-self-check-validation.json.validationErrors`, fix report producer/inputs, rerun validate and CI summary |
| WF-SMOKE-033 | `workflow:quality:report:validate` fails | Quality gate report schema drifted (summary/steps/artifacts mismatch) or expected schema version mismatch | `pnpm workflow:quality:report:validate -- --report-file=logs/workflow-quality-gate-report.json --summary-json-file=logs/workflow-quality-gate-report-validation.json --expected-report-schema-version=1.0 --require-summary-json-assert` | Inspect `logs/workflow-quality-gate-report-validation.json.validationErrors`, align quality gate report contract and rerun validate + CI summary |
| WF-SMOKE-034 | `workflow:quality:report:validate` reports `report path mismatch` / `options/artifacts path mismatch` | Validation input path differs from report artifact path, or quality report `options.*` and `artifacts.*` path fields are inconsistent | `pnpm workflow:quality:report:validate -- --report-file=logs/workflow-quality-gate-report.json --summary-json-file=logs/workflow-quality-gate-report-validation.json --expected-report-schema-version=1.0 --require-summary-json-assert` | Align validation input with `artifacts.qualityGateReportFile`; for离线旧样本可临时加 `--allow-report-file-path-mismatch` 或 `--skip-artifact-option-path-check` |
| WF-SMOKE-035 | `workflow:quality:report:validate` 失败且定位信息不明确 | 校验摘要缺少统一失败索引，或未优先使用 reasonCode 导航导致排障路径分散 | `cat logs/workflow-quality-gate-report-validation.json`（重点看 `failureIndex.reasonCode/message/suggestedAction`） | 先按 `failureIndex.reasonCode` 分流（schema/path/summaryJsonAssert/summary 计数），执行 `suggestedAction` 后再重跑 validate 与 CI summary |
| WF-SMOKE-036 | `workflow:quality:report:validate` 连续失败，人工排障反复试错 | 未优先执行结构化首修命令，导致每次修复动作与当前首个 reasonCode 不匹配 | `cat logs/workflow-quality-gate-report-validation.json`（重点看 `failureIndex.suggestedCommand`） | 先执行 `failureIndex.suggestedCommand`，再检查 reasonCode 是否变化；若不变，再按 `validationErrors[0]` 精修输入参数 |
| WF-SMOKE-037 | `workflow:quality:validation:guidance:self-check` 失败 | quality report 校验 reasonCode 分类与建议动作/命令映射发生回归，导致 validator 与 renderer 指导不一致 | `pnpm workflow:quality:validation:guidance:self-check` | 优先修复 `scripts/workflow-quality-gate-validation-guidance.mjs` 映射，再回归 `workflow:quality:report:validate:self-check`、`workflow:summary:renderers:self-check`、`workflow:summary:self-check:all:self-check` |
| WF-SMOKE-038 | quality report 校验块 `Failure Reason Source` 异常 | `failureIndex.reasonCode` 与 `validationErrors[0]` 分类结果不一致，或旧报告缺少结构化字段导致 source 漂移 | `cat logs/workflow-quality-gate-report-validation.json`（重点看 `failureIndex.reasonCode/reasonCodeSource/message/guidanceVersion`） | 先确认是否来自旧报告；新报告应优先输出结构化 source，必要时重跑 `pnpm workflow:quality:report:validate` 并回归 renderer/self-check |
| WF-SMOKE-039 | quality report 校验块 `Failure Index Snapshot` 过短或截断 | CI 摘要单行 snapshot 长度受限，长 message/command 被裁剪后难以直接定位 | `cat logs/workflow-quality-gate-report-validation.json`（重点看 `failureIndex` 全量字段） | 先以原始 JSON 为准定位，再按 `failureIndex.suggestedCommand` 执行修复；必要时通过 renderer 自检验证 snapshot 映射是否回归 |
| WF-SMOKE-040 | CI Step Summary 中 `Failure Index Snapshot` 长度不合适 | 默认 snapshot 长度与当前项目输出不匹配，导致信息不足或噪声过多 | `pnpm workflow:ci:step-summary -- --quality-report-validation-file=logs/workflow-quality-gate-report-validation.json --failure-index-snapshot-max-chars=200` | 结合团队习惯调整 `--failure-index-snapshot-max-chars`，并用 `workflow:ci:step-summary:self-check` 验证截断行为 |
| WF-SMOKE-041 | quality report 校验块 diagnostics 统计异常（计数为 `N/A` 或与错误数不一致） | `failureIndexDiagnostics` 字段缺失/回退，或 validator/renderers 版本不一致导致 reasonCode/source/snapshot 统计漂移 | `cat logs/workflow-quality-gate-report-validation.json`（重点看 `failureIndexDiagnostics` 与 `validationErrors`） | 先重跑 `pnpm workflow:quality:report:validate` 生成最新摘要，再执行 `pnpm workflow:summary:renderers:self-check` 与 `pnpm workflow:quality:report:validate:self-check`，以 `validationErrors` 为真值修复 diagnostics 映射 |
| WF-SMOKE-042 | quality report 校验块 `Diagnostics Consistency Status=FAILED` | `failureIndexDiagnostics` 的 total/map/snapshot 契约不一致（常见于手工改摘要或脚本版本混用） | `cat logs/workflow-quality-gate-report-validation.json`（重点看 `failureIndexDiagnostics.consistency.mismatchReasons`） | 先按 `mismatchReasons` 定位不一致字段，重跑 `pnpm workflow:quality:report:validate` 生成新摘要，再回归 `pnpm workflow:summary:renderers:self-check` 与 `pnpm workflow:ci:step-summary:self-check` |
| WF-SMOKE-043 | `workflow:summary:self-check:all` 失败后定位成本高 | 聚合自检在首个失败步骤中断，未优先使用 quick locate 信息导致排障路径分散 | `pnpm workflow:summary:self-check:all`（重点看 stderr 的 `quick locate` 行） | 先执行 `quick locate: rerun ...` 对应命令，再用 `quick locate: first failed output` 判断环境/脚本问题；若指向 quality report 校验，再看 `failureIndexDiagnostics.consistency.mismatchReasons` |
| WF-SMOKE-044 | `workflow:summary:self-check:report:validate` 报 `failureFingerprint` 相关错误 | 聚合自检报告 `summary.failureFingerprint` 缺失或与首个失败 step 不一致（command/首行输出/hash 漂移） | `pnpm workflow:summary:self-check:all -- --report-file=logs/workflow-summary-self-check-report.json` + `pnpm workflow:summary:self-check:report:validate -- --report-file=logs/workflow-summary-self-check-report.json --summary-json-file=logs/workflow-summary-self-check-validation.json --expected-report-schema-version=1.0` | 先重跑聚合自检生成新报告，再核对 `summary.failureFingerprint.stepId/command/firstOutputLine/hash` 与首个失败 step 是否一致，修复后回归 `workflow:summary:self-check:all:self-check` 与 `workflow:ci:step-summary:self-check` |
| WF-SMOKE-045 | Workflow Smoke 页面首屏无法快速看到 `failure fingerprint hash` | Step Summary 输出过长且未优先查看 quick index，或 `workflow-ci-step-summary` 未输出 `Workflow Quick Locate Index` 区块 | `pnpm workflow:ci:step-summary -- --self-check-report-file=logs/workflow-summary-self-check-report.json --self-check-validation-file=logs/workflow-summary-self-check-validation.json` | 先看 `Workflow Quick Locate Index` 区块中的 `Self-Check Failure Fingerprint Hash`；若为 `N/A` 但自检失败，回查 `logs/workflow-summary-self-check-report.json.summary.failureFingerprint` 并重跑 `workflow:summary:self-check:all` |
| WF-SMOKE-046 | Quick Locate 中 `Self-Check Suggested Command` / `First Failed Output` 显示 `N/A`，但 self-check 实际失败 | 使用了 legacy 报告（`summary.failureFingerprint` 缺失）且 quick index 未做 failed step 计算回退，导致首屏无法直接复现 | `pnpm workflow:ci:step-summary -- --self-check-report-file=logs/workflow-summary-self-check-report.json --self-check-validation-file=logs/workflow-summary-self-check-validation.json`（重点看 `Workflow Quick Locate Index`） | 优先升级到包含 fallback 的脚本版本；若暂时无法升级，先从 `logs/workflow-summary-self-check-report.json.steps` 找首个 `status=FAILED` 的 step，手工执行 `command + args` 并查看 `outputTail` 首行定位 |
| WF-SMOKE-047 | Quick Locate 中 `Quality Validation Suggested Command` 为 `N/A`，但 quality gate 已失败 | quality report validation 的 `failureIndex.suggestedCommand` 缺失（legacy 摘要或字段退化），若无回退逻辑会导致首屏无法给出首修命令 | `pnpm workflow:ci:step-summary -- --quality-report-file=logs/workflow-quality-gate-report.json --quality-report-validation-file=logs/workflow-quality-gate-report-validation.json`（重点看 `Workflow Quick Locate Index`） | 优先使用 `Quality Gate Suggested Command`（会回退到 failed step 命令）；再结合 `Quality Gate First Failed Output` 判断失败类型；若两者仍为 `N/A`，回查 `logs/workflow-quality-gate-report.json.steps` 与 `logs/workflow-quality-gate-report-validation.json.failureIndex` |
| WF-SMOKE-048 | Quick Locate 中 `Quality Failure Fingerprint` 字段为 `N/A` 或来源异常，导致质量失败无法稳定定位 | 渲染器未按 `summary.failureFingerprint -> failed step computed` 优先级解析，或 quality report 缺少 failed step 细节 | `pnpm workflow:summary:renderers:self-check` + `pnpm workflow:ci:step-summary:self-check` | 先查看 `Quality Failure Fingerprint Source`：若为 `SUMMARY`，核对 `logs/workflow-quality-gate-report.json.summary.failureFingerprint`；若为 `COMPUTED`，核对首个失败 step 的 `command/outputTail`；修复后重跑两类自检与 `pnpm workflow:summary:self-check:all:self-check` |
| WF-SMOKE-049 | Quick Locate 中 `Quality Gate Suggested Command` / `Self-Check Suggested Command` 可执行但来源不清晰，排障顺序混乱 | 缺少命令来源字段，无法判断该命令来自 validation failureIndex、failure fingerprint 还是 failed step 回退 | `pnpm workflow:ci:step-summary -- --quality-report-file=logs/workflow-quality-gate-report.json --quality-report-validation-file=logs/workflow-quality-gate-report-validation.json --self-check-report-file=logs/workflow-summary-self-check-report.json --self-check-validation-file=logs/workflow-summary-self-check-validation.json`（重点看 `Workflow Quick Locate Index`） | 优先看 `Quality Gate Suggested Command Source` / `Self-Check Suggested Command Source`：`VALIDATION_FAILURE_INDEX` 先修校验输入，`FAILURE_FINGERPRINT` 先按指纹对应失败步骤复现，`FAILED_STEP` 直接执行首个失败 step 命令；修复后回归 renderer/ci-step-summary/self-check-all 自检 |
| WF-SMOKE-050 | Quick Locate 出现建议命令来源字段但团队对“先修路径”理解不一致，导致反复走错命令 | 未统一使用来源优先级说明（quality: `VALIDATION_FAILURE_INDEX > FAILURE_FINGERPRINT > FAILED_STEP > N/A`；self-check: `FAILURE_FINGERPRINT > FAILED_STEP > N/A`） | `pnpm workflow:ci:step-summary -- --quality-report-file=logs/workflow-quality-gate-report.json --quality-report-validation-file=logs/workflow-quality-gate-report-validation.json --self-check-report-file=logs/workflow-summary-self-check-report.json --self-check-validation-file=logs/workflow-summary-self-check-validation.json`（重点看 `*Suggested Command Source Priority` 行） | 严格按 Priority 行选择首修路径：quality 先看 validation failureIndex，再看 fingerprint，再回退 failed step；self-check 先看 fingerprint，再回退 failed step；若来源为 `N/A`，回查原始报告 `steps/failureIndex` 并重跑自检链路 |
| WF-SMOKE-051 | Quick Locate 已给出建议命令但执行顺序仍混乱，团队不确定“第一步先修什么” | 未使用 `Quality Gate First Fix Route` / `Self-Check First Fix Route` 统一首修路径，导致在 source 变化时仍沿用旧习惯 | `pnpm workflow:ci:step-summary -- --quality-report-file=logs/workflow-quality-gate-report.json --quality-report-validation-file=logs/workflow-quality-gate-report-validation.json --self-check-report-file=logs/workflow-summary-self-check-report.json --self-check-validation-file=logs/workflow-summary-self-check-validation.json`（重点看 `*First Fix Route` 行） | 按 route 直接执行首修：quality `RUN_QUALITY_VALIDATION_SUGGESTED_COMMAND -> RUN_QUALITY_FINGERPRINT_COMMAND -> RUN_QUALITY_FAILED_STEP_COMMAND -> INSPECT_QUALITY_REPORT_STEPS_AND_FAILURE_INDEX`；self-check `RUN_SELF_CHECK_FINGERPRINT_COMMAND -> RUN_SELF_CHECK_FAILED_STEP_COMMAND -> INSPECT_SELF_CHECK_REPORT_STEPS`；执行后再回归 `workflow:summary:renderers:self-check` 与 `workflow:ci:step-summary:self-check` |
| WF-SMOKE-052 | `workflow:summary:self-check:all` 失败时已有 `quick locate: rerun`，但团队仍不确定该命令来源与首修路径 | 聚合自检 quick locate 未显式标注 `command source / first fix route`，导致“是否用 override 命令”判断不一致 | `pnpm workflow:summary:self-check:all`（重点看 stderr 的 `quick locate: command source*` 与 `quick locate: first fix route`） | 先按 source priority 执行：`STEP_OVERRIDE > FAILED_STEP > N/A`；当 route=`RERUN_QUICK_LOCATE_COMMAND` 时直接执行 `quick locate: rerun` 命令，route=`RERUN_FAILED_STEP_COMMAND` 时执行失败 step 原命令，route=`INSPECT_SELF_CHECK_REPORT_STEPS` 时回查 `logs/workflow-summary-self-check-report.json.steps` 与 `summary.failedStepIds` |
| WF-SMOKE-053 | CI 摘要中 `Workflow Summary Self-Check Suite` 的首修建议与聚合 stderr 不一致 | 未优先消费 `summary.quickLocate*` 结构化字段，导致 UI 仍走旧 fallback 映射（尤其在 `FAILED_STEP` 来源时误判为 override） | `pnpm workflow:summary:self-check:all -- --report-file=logs/workflow-summary-self-check-report.json` + `pnpm workflow:ci:step-summary -- --self-check-report-file=logs/workflow-summary-self-check-report.json`（重点看 `Quick Locate Command Source/First Fix Route/Suggested Command`） | 若 summary 中存在 `quickLocateCommandSource/quickLocateFirstFixRoute/quickLocateCommand`，CI 摘要必须同值展示；若字段缺失，才回退 `STEP_OVERRIDE > FAILED_STEP > N/A` 规则；修复后回归 `pnpm workflow:summary:renderers:self-check`、`pnpm workflow:ci:step-summary:self-check`、`pnpm workflow:summary:self-check:all:self-check` |
| WF-SMOKE-054 | `workflow:summary:self-check:report:validate` 报 `quickLocateFirstFixRoute must be RERUN_FAILED_STEP_COMMAND` 或 `quickLocateCommand mismatch` | `summary.quickLocateCommandSource=FAILED_STEP` 时，`quickLocateFirstFixRoute`/`quickLocateCommand` 未与首个失败 step 原命令保持一致（常见于手工改 report 或混用旧版脚本） | `pnpm workflow:summary:self-check:report:validate -- --report-file=logs/workflow-summary-self-check-report.json --summary-json-file=logs/workflow-summary-self-check-validation.json --expected-report-schema-version=1.0` + `cat logs/workflow-summary-self-check-report.json`（重点看 `summary.quickLocate*` 与首个失败 step） | 先按失败 step 回填：`quickLocateCommandSource=FAILED_STEP`、`quickLocateFirstFixRoute=RERUN_FAILED_STEP_COMMAND`、`quickLocateCommand=首个失败 step 的 command+args`、`quickLocateFirstFailedOutput=outputTail 首行`；再回归 `pnpm workflow:summary:self-check:report:validate:self-check`、`pnpm workflow:summary:renderers:self-check`、`pnpm workflow:ci:step-summary:self-check` |

## 3. Recommended Triage Order

1. Verify database connectivity and migration status (`WF-SMOKE-001`, `WF-SMOKE-002`).
2. Run targeted smoke command for the failing assertion domain.
3. Compare `outputSnapshot.riskGate` and `nodeExecutions.outputSnapshot` fields.
4. Validate smoke/perf reports: `pnpm workflow:reports:validate`.
5. If regression is confirmed, patch and rerun `pnpm workflow:quality:gate`.
