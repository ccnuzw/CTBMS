# æ™ºèƒ½é‡‡é›†æ•°æ®å­˜å‚¨å¢å¼º - Walkthrough

> **å®Œæˆæ—¥æœŸ**: 2026-01-19
> **æ ¸å¿ƒæ”¹åŠ¨**: æ”¯æŒ C ç±»æ—¥æŠ¥è‡ªåŠ¨è§£æå¹¶æå– A ç±»ä»·æ ¼æ•°æ®å’Œ B ç±»å¸‚åœºå¿ƒæ€

---

## ğŸ“‹ å˜æ›´æ¦‚è§ˆ

æœ¬æ¬¡æ›´æ–°å®ç°äº†ä» **C ç±»æ—¥æŠ¥ï¼ˆ500-1000å­—ï¼‰** ä¸­è‡ªåŠ¨è§£æå¹¶æå– **A ç±»ä»·æ ¼æ•°æ®** å’Œ **B ç±»å¸‚åœºå¿ƒæ€** çš„èƒ½åŠ›ï¼Œé‡‡ç”¨ **JSON æ‰©å±•æ–¹æ¡ˆ**ï¼Œæ— éœ€æ•°æ®åº“è¿ç§»ã€‚

```mermaid
flowchart LR
    A[Cç±»æ—¥æŠ¥è¾“å…¥] --> B[AI æ™ºèƒ½è§£æ]
    B --> C{è§£æç»“æœ}
    C --> D[pricePoints: Aç±»ä»·æ ¼æ•°æ®]
    C --> E[marketSentiment: Bç±»å¿ƒæ€]
    C --> F[forecast: åå¸‚é¢„åˆ¤]
    C --> G[sections: åŸæ–‡åˆ†æ®µ]
    D --> H[è‡ªåŠ¨å†™å…¥ PriceData è¡¨]
    E --> I[å­˜å…¥ aiAnalysis JSON]
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

### 1. ç±»å‹å®šä¹‰æ‰©å±•

#### [market-intel.ts](file:///Users/mac/Progame/CTBMS/packages/types/src/modules/market-intel.ts)

æ–°å¢ 5 ä¸ª Zod Schema å’Œå¯¹åº” TypeScript ç±»å‹ï¼š

| Schema | ç”¨é€” |
| :--- | :--- |
| `ExtractedPricePointSchema` | ä»æ—¥æŠ¥ä¸­æå–çš„ä»·æ ¼ç‚¹ |
| `MarketSentimentSchema` | å¸‚åœºå¿ƒæ€åˆ†æç»“æœ |
| `ForecastSchema` | åå¸‚é¢„åˆ¤ |
| `ReportSectionSchema` | åŸæ–‡åˆ†æ®µ |
| `DailyReportMetaSchema` | æ—¥æŠ¥å…ƒä¿¡æ¯ |

render_diffs(file:///Users/mac/Progame/CTBMS/packages/types/src/modules/market-intel.ts)

---

### 2. åç«¯ AI æœåŠ¡å¢å¼º

#### [ai.service.ts](file:///Users/mac/Progame/CTBMS/apps/api/src/modules/ai/ai.service.ts)

å®Œå…¨é‡å†™ï¼Œæ–°å¢ä»¥ä¸‹æ ¸å¿ƒæ–¹æ³•ï¼š

| æ–¹æ³• | åŠŸèƒ½ |
| :--- | :--- |
| `extractPricePoints()` | æ‰¹é‡æå–ä»·æ ¼ç‚¹ï¼Œæ”¯æŒå¤šç§æ ¼å¼åŒ¹é… |
| `analyzeMarketSentiment()` | åˆ†æå¸‚åœºæƒ…ç»ªï¼ˆbullish/bearish/neutral/mixedï¼‰ |
| `extractForecast()` | æå–çŸ­æœŸ/ä¸­æœŸé¢„åˆ¤åŠå…³é”®å› ç´  |
| `extractSections()` | è¯†åˆ«æ—¥æŠ¥åˆ†æ®µç»“æ„ |
| `extractEvents()` | æå–äº‹ä»¶åŠ¨æ€ |
| `detectReportType()` | è‡ªåŠ¨è¯†åˆ«æ—¥æŠ¥ç±»å‹ |
| `generateDailyReportSummary()` | ç”Ÿæˆæ™ºèƒ½æ‘˜è¦ |

**æ”¯æŒçš„é‡‡é›†ç‚¹**:
```
é”¦å·æ¸¯ã€é²…é±¼åœˆã€åŒ—è‰¯æ¸¯ã€å¤§è¿æ¸¯ã€æ¢…èŠ±å‘³ç²¾ã€ç›Šæµ·å˜‰é‡Œã€ä¸­ç²®ã€è±¡å±¿...
```

**æ”¯æŒçš„å“ç§**:
```
ç‰ç±³ã€å¤§è±†ã€å°éº¦ã€ç¨»è°·ã€é«˜ç²±
```

render_diffs(file:///Users/mac/Progame/CTBMS/apps/api/src/modules/ai/ai.service.ts)

---

### 3. æ•°æ®å†™å…¥æœåŠ¡å¢å¼º

#### [market-intel.service.ts](file:///Users/mac/Progame/CTBMS/apps/api/src/modules/market-intel/market-intel.service.ts)

æ–°å¢ `batchCreatePriceData()` æ–¹æ³•ï¼Œåœ¨åˆ›å»ºæƒ…æŠ¥æ—¶è‡ªåŠ¨ï¼š

1. æ£€æµ‹ `aiAnalysis.pricePoints` æ˜¯å¦å­˜åœ¨
2. æ‰¹é‡å†™å…¥ `PriceData` è¡¨ï¼ˆä½¿ç”¨ upsert é¿å…é‡å¤ï¼‰
3. è‡ªåŠ¨å…³è”æƒ…æŠ¥ ID

render_diffs(file:///Users/mac/Progame/CTBMS/apps/api/src/modules/market-intel/market-intel.service.ts)

---

### 4. å‰ç«¯ç•Œé¢ä¼˜åŒ–

#### [DataEntry.tsx](file:///Users/mac/Progame/CTBMS/apps/web/src/features/market-intel/components/DataEntry.tsx)

åœ¨ AI åˆ†æç»“æœåŒºåŸŸæ–°å¢ï¼š

| ç»„ä»¶ | åŠŸèƒ½ |
| :--- | :--- |
| **ä»·æ ¼æ•°æ®åˆ—è¡¨** | å±•ç¤ºä»æ—¥æŠ¥æå–çš„æ‰€æœ‰ä»·æ ¼ç‚¹ï¼Œå¸¦æ¶¨è·Œæ ‡è¯† |
| **å¸‚åœºå¿ƒæ€å¡ç‰‡** | å±•ç¤ºæƒ…ç»ªåˆ†æï¼ˆçœ‹æ¶¨/çœ‹è·Œ/ä¸­æ€§/åˆ†åŒ–ï¼‰å’Œåˆ†å€¼ |
| **åå¸‚é¢„åˆ¤å¡ç‰‡** | å±•ç¤ºçŸ­æœŸ/ä¸­æœŸé¢„åˆ¤å’Œå…³é”®å½±å“å› ç´  |

render_diffs(file:///Users/mac/Progame/CTBMS/apps/web/src/features/market-intel/components/DataEntry.tsx)

---

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### 1. æ—¥æŠ¥é‡‡é›†æµç¨‹

1. è®¿é—® `/intel/entry` é¡µé¢
2. é€‰æ‹© **C ç±»ï¼šæ–‡æ¡£ä¸å›¾è¡¨**
3. ç²˜è´´æ—¥æŠ¥å…¨æ–‡ï¼ˆæˆ–ç‚¹å‡»ã€Œæ–‡æ¡£æ¼”ç¤ºã€ä½“éªŒç¤ºä¾‹ï¼‰
4. ç‚¹å‡»ã€AI åˆ†æä¸æ ¡éªŒã€‘
5. æŸ¥çœ‹è§£æç»“æœï¼š
   - **ä»·æ ¼æ•°æ® (Aç±»)**: è‡ªåŠ¨æå–çš„ä»·æ ¼ç‚¹åˆ—è¡¨
   - **å¸‚åœºå¿ƒæ€ (Bç±»)**: çœ‹æ¶¨/çœ‹è·Œ/ä¸­æ€§åˆ¤å®š
   - **åå¸‚é¢„åˆ¤**: çŸ­æœŸ/ä¸­æœŸå±•æœ›
6. ç¡®è®¤åç‚¹å‡»ã€ç¡®è®¤å…¥åº“ã€‘

### 2. æ•°æ®æµå‘

```
ç”¨æˆ·ç²˜è´´æ—¥æŠ¥
    â†“
POST /market-intel/analyze
    â†“
AI è§£æè¿”å› aiAnalysis {
    pricePoints: [...],
    marketSentiment: {...},
    forecast: {...}
}
    â†“
ç”¨æˆ·ç¡®è®¤æäº¤
    â†“
POST /market-intel
    â†“
1. å†™å…¥ MarketIntel è¡¨
2. è‡ªåŠ¨å†™å…¥ PriceData è¡¨ï¼ˆæ‰¹é‡ï¼‰
```

---

## ğŸ“Š æ–°å¢ç±»å‹ç»“æ„

### ExtractedPricePoint

```typescript
interface ExtractedPricePoint {
  location: string;           // é‡‡é›†ç‚¹
  price: number;              // ä»·æ ¼
  change: number | null;      // æ¶¨è·Œå¹…
  unit: string;               // å•ä½ï¼ˆé»˜è®¤ å…ƒ/å¨ï¼‰
  commodity?: string;         // å“ç§
  grade?: string;             // ç­‰çº§
}
```

### MarketSentiment

```typescript
interface MarketSentiment {
  overall: 'bullish' | 'bearish' | 'neutral' | 'mixed';
  score?: number;             // -100 ~ 100
  traders?: string;           // è´¸æ˜“å•†å¿ƒæ€
  processors?: string;        // åŠ å·¥ä¼ä¸šå¿ƒæ€
  farmers?: string;           // å†œæˆ·/åŸºå±‚å¿ƒæ€
  summary?: string;           // å¿ƒæ€æ¦‚è¿°
}
```

### Forecast

```typescript
interface Forecast {
  shortTerm?: string;         // çŸ­æœŸé¢„åˆ¤
  mediumTerm?: string;        // ä¸­æœŸé¢„åˆ¤
  longTerm?: string;          // é•¿æœŸé¢„åˆ¤
  keyFactors?: string[];      // å…³é”®å½±å“å› ç´ 
  riskLevel?: 'low' | 'medium' | 'high';
}
```

---

## âœ… éªŒè¯ç»“æœ

| é¡¹ç›® | çŠ¶æ€ |
| :--- | :---: |
| `packages/types` ç¼–è¯‘ | âœ… |
| `apps/api` ç¼–è¯‘ | âœ… |
| `apps/web` ç¼–è¯‘ | âœ… |

---

## ğŸ”® åç»­è¿­ä»£å»ºè®®

1. **é›†æˆçœŸå® AI API**
   - é…ç½® `GEMINI_API_KEY` å¯ç”¨ Gemini é©±åŠ¨çš„æ™ºèƒ½è§£æ
   
2. **ä»·æ ¼æ•°æ®æ‰‹åŠ¨ç¼–è¾‘**
   - å…è®¸ç”¨æˆ·åœ¨æäº¤å‰ä¿®æ”¹/åˆ é™¤é”™è¯¯çš„ä»·æ ¼ç‚¹
   
3. **ä¼ä¸šè‡ªåŠ¨å…³è”**
   - ä»æ—¥æŠ¥ä¸­è¯†åˆ«çš„ä¼ä¸šåç§°è‡ªåŠ¨å…³è”åˆ° `Enterprise` è¡¨

4. **å†å²æ—¥æŠ¥æ‰¹é‡å¯¼å…¥**
   - æ”¯æŒ Excel/CSV æ‰¹é‡å¯¼å…¥å†å²æ•°æ®

---

*Walkthrough ç”Ÿæˆæ—¶é—´: 2026-01-19*
