datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// =============================================
// 用户状态枚举（原 EmployeeStatus）
// =============================================
enum UserStatus {
  ACTIVE      // 在职
  PROBATION   // 试用期
  RESIGNED    // 离职
  SUSPENDED   // 停职
}

// 性别枚举
enum Gender {
  MALE
  FEMALE
  OTHER
}

// =============================================
// 用户模型 (合并原 User + Employee)
// =============================================
model User {
  id             String       @id @default(uuid())
  
  // 登录凭证
  username       String       @unique   // 登录用户名
  email          String       @unique
  
  // 基本信息
  name           String                 // 姓名（显示名称）
  gender         Gender?                // 性别
  birthday       DateTime?              // 生日
  employeeNo     String?      @unique   // 工号（可选）
  phone          String?                // 电话
  avatar         String?                // 头像 URL
  
  // 归属组织/部门（可选，有归属即为员工）
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  departmentId   String?
  department     Department?   @relation(fields: [departmentId], references: [id])
  
  // 职位信息
  position       String?      // 职位名称
  hireDate       DateTime?    // 入职日期
  
  // 员工状态
  status         UserStatus   @default(ACTIVE)
  
  // 角色（通过 UserRole 关联）
  roles          UserRole[]
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

// =============================================
// 角色模型
// =============================================
model Role {
  id          String       @id @default(uuid())
  name        String
  code        String       @unique   // 角色代码，如 "MANAGER", "STAFF"
  description String?
  isSystem    Boolean      @default(false) // 系统内置角色不可删除
  
  sortOrder   Int          @default(0)
  status      EntityStatus @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  users       UserRole[]
}

// 用户-角色关联表 (多对多)
model UserRole {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, roleId])
}

// =============================================
// 全局标签系统 (Global Tag System)
// =============================================

// 标签作用域枚举
enum TagScope {
  GLOBAL       // 全局可用
  CUSTOMER     // 客户
  SUPPLIER     // 供应商
  VEHICLE      // 车辆
  CONTRACT     // 合同单据
  MARKET_INFO  // 信息采集（兼容旧数据）
}

// 可挂载标签的实体类型
enum TaggableEntityType {
  CUSTOMER
  SUPPLIER
  VEHICLE
  CONTRACT
  MARKET_INFO
}

// 标签组模型 (用于互斥逻辑)
model TagGroup {
  id           String       @id @default(uuid())
  name         String       @unique
  description  String?
  isExclusive  Boolean      @default(true)  // 组内互斥
  sortOrder    Int          @default(0)
  status       EntityStatus @default(ACTIVE)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  tags         Tag[]
}

// 全局标签模型
model Tag {
  id          String       @id @default(uuid())
  name        String
  color       String?      // HEX 颜色
  icon        String?      // 图标标识符
  description String?
  
  // 作用域 (决定该标签可挂载到哪些实体)
  scopes      TagScope[]   @default([GLOBAL])
  
  // 所属标签组 (可选)
  groupId     String?
  group       TagGroup?    @relation(fields: [groupId], references: [id])
  
  sortOrder   Int          @default(0)
  status      EntityStatus @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // 关联实体
  entityTags  EntityTag[]
  
  @@unique([name, groupId]) // 同组内标签名唯一
}

// 多态关联表 (标签 <-> 业务实体)
model EntityTag {
  id         String             @id @default(uuid())
  tagId      String
  tag        Tag                @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  // 多态字段
  entityType TaggableEntityType
  entityId   String             // 目标实体ID
  
  createdAt  DateTime           @default(now())
  
  @@unique([tagId, entityType, entityId]) // 防止重复关联
  @@index([entityType, entityId])         // 按实体查询优化
}

// =============================================
// 信息采集子系统 (Market Info Subsystem)
// =============================================
model MarketCategory {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  description String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  infos       MarketInfo[]
}

// MarketTag 已迁移到全局 Tag 系统，通过 EntityTag 关联

model MarketInfo {
  id          String   @id @default(uuid())
  title       String
  content     String   @db.Text
  summary     String?
  status      InfoStatus @default(DRAFT)
  publishedAt DateTime?
  
  categoryId  String
  category    MarketCategory @relation(fields: [categoryId], references: [id])
  // 标签关联已迁移到 EntityTag 表
  
  attachments Json?      
  
  authorId    String     
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

enum InfoStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// =============================================
// 组织架构管理 (Organization Structure)
// =============================================

// 组织类型枚举
enum OrganizationType {
  HEADQUARTERS  // 总部
  REGION        // 大区/分公司
  BRANCH        // 经营部/办事处
  SUBSIDIARY    // 子公司
}

// 通用状态枚举
enum EntityStatus {
  ACTIVE
  INACTIVE
}

// 组织/公司模型 (支持多层级自引用)
model Organization {
  id          String           @id @default(uuid())
  name        String
  code        String           @unique   // 组织代码，如 "HQ", "REGION_EAST"
  type        OrganizationType @default(BRANCH)
  description String?
  
  // 自引用关系 (实现无限层级)
  parentId    String?
  parent      Organization?    @relation("OrgHierarchy", fields: [parentId], references: [id])
  children    Organization[]   @relation("OrgHierarchy")
  
  // 关联部门
  departments Department[]
  
  // 关联用户（员工）
  users       User[]
  
  sortOrder   Int              @default(0)
  status      EntityStatus     @default(ACTIVE)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

// 部门模型 (支持多层级自引用)
model Department {
  id             String        @id @default(uuid())
  name           String
  code           String
  description    String?
  
  // 所属组织
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id])
  
  // 自引用关系 (实现无限层级部门)
  parentId       String?
  parent         Department?   @relation("DeptHierarchy", fields: [parentId], references: [id])
  children       Department[]  @relation("DeptHierarchy")
  
  // 关联用户（员工）
  users          User[]
  
  sortOrder      Int           @default(0)
  status         EntityStatus  @default(ACTIVE)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  @@unique([organizationId, code]) // 同一组织内部门代码唯一
}
