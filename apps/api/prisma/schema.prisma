datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// =============================================
// 用户状态枚举（原 EmployeeStatus）
// =============================================
enum UserStatus {
  ACTIVE      // 在职
  PROBATION   // 试用期
  RESIGNED    // 离职
  SUSPENDED   // 停职
}

// 性别枚举
enum Gender {
  MALE
  FEMALE
  OTHER
}

// =============================================
// 用户模型 (合并原 User + Employee)
// =============================================
model User {
  id             String       @id @default(uuid())
  
  // 登录凭证
  username       String       @unique   // 登录用户名
  email          String       @unique
  
  // 基本信息
  name           String                 // 姓名（显示名称）
  gender         Gender?                // 性别
  birthday       DateTime?              // 生日
  employeeNo     String?      @unique   // 工号（可选）
  phone          String?                // 电话
  avatar         String?                // 头像 URL
  
  // 归属组织/部门（可选，有归属即为员工）
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  departmentId   String?
  department     Department?   @relation(fields: [departmentId], references: [id])
  
  // 职位信息
  position       String?      // 职位名称
  hireDate       DateTime?    // 入职日期
  
  // 员工状态
  status         UserStatus   @default(ACTIVE)
  
  // 角色（通过 UserRole 关联）
  roles          UserRole[]
  
  // 商情情报关联
  marketIntels   MarketIntel[]
  intelStats     UserIntelStats?
  intelTasks     IntelTask[]       // 分配的采集任务
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

// =============================================
// 角色模型
// =============================================
model Role {
  id          String       @id @default(uuid())
  name        String
  code        String       @unique   // 角色代码，如 "MANAGER", "STAFF"
  description String?
  isSystem    Boolean      @default(false) // 系统内置角色不可删除
  
  sortOrder   Int          @default(0)
  status      EntityStatus @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  users       UserRole[]
}

// 用户-角色关联表 (多对多)
model UserRole {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, roleId])
}

// =============================================
// 全局标签系统 (Global Tag System)
// =============================================

// 标签作用域枚举
enum TagScope {
  GLOBAL       // 全局可用
  CUSTOMER     // 客户
  SUPPLIER     // 供应商
  LOGISTICS    // 物流供应商
  CONTRACT     // 合同单据
  MARKET_INFO  // 信息采集（兼容旧数据）
}

// 可挂载标签的实体类型
enum TaggableEntityType {
  CUSTOMER
  SUPPLIER
  LOGISTICS
  CONTRACT
  MARKET_INFO
}

// 标签组模型 (用于互斥逻辑)
model TagGroup {
  id           String       @id @default(uuid())
  name         String       @unique
  description  String?
  isExclusive  Boolean      @default(true)  // 组内互斥
  sortOrder    Int          @default(0)
  status       EntityStatus @default(ACTIVE)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  tags         Tag[]
}

// 全局标签模型
model Tag {
  id          String       @id @default(uuid())
  name        String
  color       String?      // HEX 颜色
  icon        String?      // 图标标识符
  description String?
  
  // 作用域 (决定该标签可挂载到哪些实体)
  scopes      TagScope[]   @default([GLOBAL])
  
  // 所属标签组 (可选)
  groupId     String?
  group       TagGroup?    @relation(fields: [groupId], references: [id])
  
  sortOrder   Int          @default(0)
  status      EntityStatus @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // 关联实体
  entityTags  EntityTag[]
  
  @@unique([name, groupId]) // 同组内标签名唯一
}

// 多态关联表 (标签 <-> 业务实体)
model EntityTag {
  id         String             @id @default(uuid())
  tagId      String
  tag        Tag                @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  // 多态字段
  entityType TaggableEntityType
  entityId   String             // 目标实体ID
  
  createdAt  DateTime           @default(now())
  
  @@unique([tagId, entityType, entityId]) // 防止重复关联
  @@index([entityType, entityId])         // 按实体查询优化
}

// =============================================
// 信息采集子系统 (Market Info Subsystem)
// =============================================
model MarketCategory {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  description String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  infos       MarketInfo[]
}

// MarketTag 已迁移到全局 Tag 系统，通过 EntityTag 关联

model MarketInfo {
  id          String   @id @default(uuid())
  title       String
  content     String   @db.Text
  summary     String?
  status      InfoStatus @default(DRAFT)
  publishedAt DateTime?
  
  categoryId  String
  category    MarketCategory @relation(fields: [categoryId], references: [id])
  // 标签关联已迁移到 EntityTag 表
  
  attachments Json?      
  
  authorId    String     
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

enum InfoStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// =============================================
// 组织架构管理 (Organization Structure)
// =============================================

// 组织类型枚举
enum OrganizationType {
  HEADQUARTERS  // 总部
  REGION        // 大区/分公司
  BRANCH        // 经营部/办事处
  SUBSIDIARY    // 子公司
}

// 通用状态枚举
enum EntityStatus {
  ACTIVE
  INACTIVE
}

// 组织/公司模型 (支持多层级自引用)
model Organization {
  id          String           @id @default(uuid())
  name        String
  code        String           @unique   // 组织代码，如 "HQ", "REGION_EAST"
  type        OrganizationType @default(BRANCH)
  description String?
  
  // 自引用关系 (实现无限层级)
  parentId    String?
  parent      Organization?    @relation("OrgHierarchy", fields: [parentId], references: [id])
  children    Organization[]   @relation("OrgHierarchy")
  
  // 关联部门
  departments Department[]
  
  // 关联用户（员工）
  users       User[]
  
  sortOrder   Int              @default(0)
  status      EntityStatus     @default(ACTIVE)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

// 部门模型 (支持多层级自引用)
model Department {
  id             String        @id @default(uuid())
  name           String
  code           String
  description    String?
  
  // 所属组织
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id])
  
  // 自引用关系 (实现无限层级部门)
  parentId       String?
  parent         Department?   @relation("DeptHierarchy", fields: [parentId], references: [id])
  children       Department[]  @relation("DeptHierarchy")
  
  // 关联用户（员工）
  users          User[]
  
  sortOrder      Int           @default(0)
  status         EntityStatus  @default(ACTIVE)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  @@unique([organizationId, code]) // 同一组织内部门代码唯一
}

// =============================================
// 基础数据：行政区划 (国标编码)
// =============================================

// 行政区划层级
enum RegionLevel {
  COUNTRY       // 国家
  PROVINCE      // 省级（省/直辖市/自治区）
  CITY          // 地级市
  DISTRICT      // 区/县
  TOWN          // 乡镇/街道（可选）
}

// 行政区划表（采用国家统计局标准编码）
model AdministrativeRegion {
  id            String       @id @default(uuid())
  
  code          String       @unique  // 国标行政区划代码（如 110000 北京市）
  name          String                // 名称
  shortName     String?               // 简称（如 京、沪）
  level         RegionLevel           // 层级
  
  // 层级关系
  parentCode    String?               // 上级区划代码
  parent        AdministrativeRegion?  @relation("RegionHierarchy", fields: [parentCode], references: [code])
  children      AdministrativeRegion[] @relation("RegionHierarchy")
  
  // 地理信息
  longitude     Float?                // 中心经度
  latitude      Float?                // 中心纬度
  
  // 排序与状态
  sortOrder     Int          @default(0)
  isActive      Boolean      @default(true)
  
  // 关联
  collectionPoints CollectionPoint[]
  
  @@index([level])
  @@index([parentCode])
}

// =============================================
// 基础数据：采集点配置
// =============================================

// 采集点类型
enum CollectionPointType {
  ENTERPRISE    // 企业（深加工、贸易商等）
  PORT          // 港口
  STATION       // 站台
  REGION        // 地域（大区级别，如"东北"）
  MARKET        // 批发市场
}

// 采集点配置表
model CollectionPoint {
  id            String               @id @default(uuid())
  
  // 基本信息
  code          String               @unique  // 唯一编码（如 JINZHOU_PORT）
  name          String                        // 显示名称
  shortName     String?                       // 简称
  aliases       String[]                      // 别名列表（用于 AI 模糊匹配）
  type          CollectionPointType           // 采集点类型
  
  // 行政区划关联
  regionCode    String?                       // 关联的行政区划代码
  region        AdministrativeRegion? @relation(fields: [regionCode], references: [code])
  
  // 详细地理信息（可覆盖行政区划的坐标）
  address       String?                       // 详细地址
  longitude     Float?                        // 经度
  latitude      Float?                        // 纬度
  
  // 业务属性
  commodities   String[]                      // 主营品种
  defaultSubType String?                      // 默认价格子类型（如 FOB、LISTED）
  
  // 关联企业（如果是企业类型）
  enterpriseId  String?
  enterprise    Enterprise?          @relation(fields: [enterpriseId], references: [id])
  
  // 优先级与状态
  priority      Int                  @default(0)  // 匹配优先级（高优先匹配）
  isActive      Boolean              @default(true)
  
  // 元数据
  description   String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  createdById   String?              // 创建人
  
  @@index([type])
  @@index([regionCode])
  @@index([isActive, priority])
}

// =============================================
// 客商管理系统 (Enterprise Management System)
// =============================================

// 企业/客商类型枚举
enum EnterpriseType {
  SUPPLIER         // 供应商
  CUSTOMER         // 客户
  LOGISTICS        // 物流商
  GROUP            // 集团
}

// 联系人角色枚举
enum ContactRole {
  PROCUREMENT      // 采购决策线
  EXECUTION        // 执行运营线
  FINANCE          // 财务结算线
  MANAGEMENT       // 高层管理线
}

// 企业/客商模型
model Enterprise {
  id          String           @id @default(uuid())
  name        String           // 企业全称
  shortName   String?          // 简称
  taxId       String           @unique  // 统一社会信用代码
  types       EnterpriseType[] // 业务身份（可多选）
  
  // 集团层级关系 (自引用)
  parentId    String?
  parent      Enterprise?      @relation("EnterpriseHierarchy", fields: [parentId], references: [id])
  children    Enterprise[]     @relation("EnterpriseHierarchy")
  
  // 地址信息
  province    String?
  city        String?
  address     String?
  longitude   Float?           // 经度
  latitude    Float?           // 纬度
  
  description String?          @db.Text  // 企业描述
  riskScore   Int              @default(80)  // 信用评分 0-100
  
  // 关联
  contacts     Contact[]
  bankAccounts BankAccount[]
  intelLinks   IntelEntityLink[]  // 关联的商情情报
  priceData    PriceData[]        // 关联的价格数据（企业价格）
  collectionPoints CollectionPoint[]  // 关联的采集点配置
  
  status      EntityStatus     @default(ACTIVE)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

// 联系人模型
model Contact {
  id           String       @id @default(uuid())
  name         String       // 姓名
  title        String?      // 职位
  role         ContactRole  // 职能角色
  phone        String       // 电话
  email        String?      // 邮箱
  notes        String?      // 备注（如：决策人、响应快等）
  
  enterpriseId String
  enterprise   Enterprise   @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

// 银行账户模型
model BankAccount {
  id            String     @id @default(uuid())
  bankName      String     // 开户行
  accountNumber String     // 账号
  accountName   String     // 户名
  branch        String?    // 支行
  isDefault     Boolean    @default(false)  // 默认账户
  isWhitelisted Boolean    @default(false)  // 是否白名单验证
  
  enterpriseId  String
  enterprise    Enterprise @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

// =============================================
// 商情情报子系统 (Market Intelligence Subsystem)
// =============================================

// 情报分类枚举
enum IntelCategory {
  A_STRUCTURED      // 标准化硬数据 (价格/库存)
  B_SEMI_STRUCTURED // 半结构化情报 (心态/事件)
  C_DOCUMENT        // 文档与图表 (研报/政策)
  D_ENTITY          // 实体档案 (企业画像)
}

// 信源类型枚举
enum IntelSourceType {
  FIRST_LINE  // 一线采集
  COMPETITOR  // 竞对情报
  OFFICIAL    // 官方发布
}

// 商情情报主表
model MarketIntel {
  id            String          @id @default(uuid())
  category      IntelCategory
  sourceType    IntelSourceType
  
  // 元数据
  effectiveTime DateTime        // 业务生效时间
  location      String          // 地理位置
  region        String[]        // 行政区划层级
  gpsLat        Float?          // GPS 纬度
  gpsLng        Float?          // GPS 经度
  gpsVerified   Boolean         @default(false)  // 地理围栏验证
  
  // 内容
  rawContent    String          @db.Text
  summary       String?         @db.Text
  
  // AI 分析结果 (JSON)
  aiAnalysis    Json?
  
  // 质量评分
  completenessScore Int         @default(0)  // 完整度
  scarcityScore     Int         @default(0)  // 稀缺度
  validationScore   Int         @default(0)  // 验证分
  totalScore        Int         @default(0)  // 总分
  
  // 标记
  isFlagged     Boolean         @default(false)  // 风控标记
  
  // 关联
  authorId      String
  author        User            @relation(fields: [authorId], references: [id])
  
  // 扩展关联
  priceData     PriceData[]       // A类：提取的价格数据
  attachments   IntelAttachment[] // C类：附件
  entityLinks   IntelEntityLink[] // D类：关联实体
  tasks         IntelTask[]       // 关联任务
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@index([category])
  @@index([sourceType])
  @@index([effectiveTime])
  @@index([authorId])
}

// 情报员统计表
model UserIntelStats {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  creditCoefficient Float    @default(3.0)   // 信用系数 0-5
  monthlyPoints     Int      @default(0)     // 月度积分
  submissionCount   Int      @default(0)     // 提交数量
  accuracyRate      Float    @default(0)     // 准确率 %
  highValueCount    Int      @default(0)     // 高价值引用数
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// =============================================
// A类：结构化价格数据（宽表存储）
// =============================================

// 价格主体类型（谁的价格）
enum PriceSourceType {
  ENTERPRISE    // 企业收购价（具体企业的挂牌/成交价）
  REGIONAL      // 地域市场价（区域综合价格）
  PORT          // 港口价格（港口到港/平舱价）
}

// 价格子类型（什么性质的价格）
enum PriceSubType {
  LISTED        // 挂牌价（企业对外公布）
  TRANSACTION   // 成交价（实际成交）
  ARRIVAL       // 到港价（到达港口的价格）
  FOB           // 平舱价（船舱交货价）
  STATION_ORIGIN    // 站台价-产区（东北站台发货价）
  STATION_DEST      // 站台价-销区（销区站台到货价）
  PURCHASE      // 收购价（向农户/贸易商收购）
  WHOLESALE     // 批发价（批发市场价格）
  OTHER         // 其他
}

// 地理层级
enum GeoLevel {
  COUNTRY       // 国家级
  REGION        // 大区（东北/华北等）
  PROVINCE      // 省级
  CITY          // 市级
  DISTRICT      // 区县级
  PORT          // 港口
  STATION       // 站台
  ENTERPRISE    // 企业点位
}

model PriceData {
  id            String   @id @default(uuid())
  
  // ===== 价格分类 =====
  sourceType    PriceSourceType @default(REGIONAL)  // 价格主体类型
  subType       PriceSubType    @default(LISTED)    // 价格子类型
  
  // ===== 地理维度 =====
  geoLevel      GeoLevel        @default(CITY)      // 地理层级
  location      String                              // 采集点名称（锦州港/梅花味精）
  province      String?                             // 省份
  city          String?                             // 城市
  district      String?                             // 区县
  region        String[]                            // 行政区划数组（向后兼容）
  longitude     Float?                              // 经度（用于地图展示）
  latitude      Float?                              // 纬度（用于地图展示）
  
  // ===== 企业关联（仅企业价格有值）=====
  enterpriseId  String?
  enterprise    Enterprise? @relation(fields: [enterpriseId], references: [id])
  enterpriseName String?                            // 冗余存储企业名称（便于查询）
  
  // ===== 品种维度 =====
  effectiveDate DateTime @db.Date                   // 价格日期
  commodity     String                              // 品种（玉米/大豆等）
  grade         String?                             // 等级（二等/三等）
  
  // ===== 价格指标 =====
  price         Decimal  @db.Decimal(10, 2)         // 价格（元/吨）
  moisture      Decimal? @db.Decimal(5, 2)          // 水分 %
  bulkDensity   Int?                                // 容重 g/L
  toxin         Decimal? @db.Decimal(5, 2)          // 毒素
  freight       Decimal? @db.Decimal(10, 2)         // 运费
  inventory     Int?                                // 库存量（吨）
  
  // ===== 计算列 =====
  foldPrice     Decimal? @db.Decimal(10, 2)         // 折标价格
  dayChange     Decimal? @db.Decimal(10, 2)         // 较昨日涨跌
  yearChange    Decimal? @db.Decimal(10, 2)         // 较去年同期涨跌
  
  // ===== 备注 =====
  note          String?                             // 附加说明
  
  // ===== 关联 =====
  intelId       String?
  intel         MarketIntel? @relation(fields: [intelId], references: [id])
  authorId      String
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // 唯一约束：同一天同一地点同一品种同一来源类型同一子类型
  @@unique([effectiveDate, commodity, location, sourceType, subType])
  @@index([sourceType, commodity, effectiveDate])
  @@index([geoLevel, effectiveDate])
  @@index([enterpriseId, effectiveDate])
  @@index([commodity, effectiveDate])
  @@index([location, effectiveDate])
  @@index([province, city, effectiveDate])
}

// =============================================
// C类：文档附件存储
// =============================================
model IntelAttachment {
  id          String   @id @default(uuid())
  
  // 文件信息
  filename    String
  mimeType    String
  fileSize    Int
  storagePath String               // 存储路径（OSS/本地）
  
  // 索引内容
  ocrText     String?  @db.Text    // OCR 提取的全文
  
  // 关联
  intelId     String
  intel       MarketIntel @relation(fields: [intelId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@index([intelId])
}

// =============================================
// D类：情报-实体关联表
// =============================================

// 关联类型枚举
enum IntelEntityLinkType {
  MENTIONED   // 在情报中被提及
  SUBJECT     // 情报主体
  SOURCE      // 情报来源
}

model IntelEntityLink {
  id           String              @id @default(uuid())
  
  intelId      String
  intel        MarketIntel         @relation(fields: [intelId], references: [id], onDelete: Cascade)
  
  enterpriseId String
  enterprise   Enterprise          @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)
  
  // 关联类型
  linkType     IntelEntityLinkType @default(MENTIONED)
  
  createdAt    DateTime            @default(now())
  
  @@unique([intelId, enterpriseId])
  @@index([enterpriseId])
}

// =============================================
// 任务调度系统
// =============================================

// 任务类型枚举
enum IntelTaskType {
  PRICE_REPORT   // 价格上报
  FIELD_CHECK    // 现场确认
  DOCUMENT_SCAN  // 文档采集
}

// 任务状态枚举
enum IntelTaskStatus {
  PENDING
  COMPLETED
  OVERDUE
}

model IntelTask {
  id          String          @id @default(uuid())
  
  title       String
  type        IntelTaskType
  deadline    DateTime
  
  // 分配对象
  assigneeId  String
  assignee    User            @relation(fields: [assigneeId], references: [id])
  
  // 状态
  status      IntelTaskStatus @default(PENDING)
  completedAt DateTime?
  
  // 关联完成的情报
  intelId     String?
  intel       MarketIntel?    @relation(fields: [intelId], references: [id])
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  @@index([assigneeId, status])
  @@index([deadline])
}
