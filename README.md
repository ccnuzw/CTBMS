# CTBMS - 企业管理系统

> **C**omprehensive **T**eam **B**usiness **M**anagement **S**ystem  
> 基于 Turborepo + React + NestJS + Prisma 的全栈企业管理平台

---

## 🚀 技术栈

| 层级 | 技术 | 说明 |
|:---|:---|:---|
| **Monorepo** | Turborepo + pnpm | 多包管理 |
| **前端** | React 18 + Vite + Ant Design 5 | 现代化 UI / Zero CSS |
| **后端** | NestJS + Prisma | RESTful API |
| **数据库** | PostgreSQL | 关系型数据库 |
| **类型共享** | Zod + TypeScript | 前后端类型统一 |

---

## 📦 项目结构

```
/
├── apps
│   ├── web          # 前端 (React + Vite)
│   └── api          # 后端 (NestJS)
├── packages
│   ├── types        # 共享 Zod Schema 和 TypeScript 类型
│   ├── tsconfig     # 共享 TS 配置
│   └── eslint-config# 共享 Lint 配置
└── package.json
```

---

## ✨ 功能模块

### 🏢 组织架构管理
- **三栏式布局**：经典的 "组织树 - 成员列表 - 详情面板" 布局，提升管理效率
- **沉浸式详情**：点击成员即可在右侧展开详情面板，支持快速编辑与操作
- **组织管理**：多层级公司/分公司结构，支持无限级树形展示
- **部门管理**：树形部门结构，支持多级嵌套与动态调整
- **用户管理**：全字段员工档案，支持头像上传与部门关联
- **角色管理**：基于 RBAC 的动态权限控制

### 🤝 客商管理
- **全生命周期**：供应商、客户、物流商及集团的全周期管理
- **客商360视图**：
    - **全景概览**：集成工商档案、业务身份与组织架构关系
    - **财务沙箱**：防诈骗预警、开票资料一键复制、银行账户白名单验证
    - **职能通讯录**：基于业务角色的联系人分组（采购/运营/财务/高管）
- **智能列表体验**：
    - **动态列显隐**：详情展开时自动隐藏次要列，最大化信息展示
    - **视图切换**：支持高效表格视图与可视化卡片视图
    - **层级透视**：支持“仅顶级”与“仅集团”快速筛选，清晰展示分子公司关系
- **风控体系**：内置信用评分体系与风险预警机制

### 🗺️ 行政区划
- **全量数据覆盖**：内置教育部/民政部标准的 34 个省级、300+ 地级、2800+ 县级行政区数据
- **高性能级联**：支持省/市/区县三级联动选择，智能懒加载
- **数据维护**：提供完整的增删改查管理界面，支持数据热更新
- **智能清洗**：自动处理“市辖区”冗余，确保数据结构扁平化且精准

### 📊 信息采集
- **分类管理**：信息分类树形结构
- **全局标签系统**：
    - **统一管理**：支持全局标签与专用标签（如客户、供应商、信息采集）
    - **标签组**：支持标签分组管理，可配置组内互斥（单选）或多选
    - **智能校验**：前端实时校验互斥冲突，后端严格作用域验证
- **信息维护**：集成 Tiptap 富文本编辑器，支持图文混排
- **文件中心**：支持多格式文件上传、管理与在线预览 (PDF/Office)

### 📉 商情中心 (Smart Market Intelligence)
- **智能配置中心 (Configuration Center)**：
    - **事件类型管理**：标准化市场事件定义（如价格异动、供应冲击），支持中文分类与全生命周期管理
    - **洞察多维分析**：预置“后市预判”、“供需分析”等核心分析维度，赋能 AI 深度研判
    - **提取规则引擎**：可视化配置关键词提取规则，支持“左词+右词+距离约束”的精准提取逻辑
- **AI 智能分析**：集成 LLM 大模型，自动解析非结构化日报，提取结构化价格与事件数据
- **看板可视化**：基于标准化数据的实时市场情绪看板与价格趋势图

### 📈 数据仪表盘
- 可视化统计图表
- 关键指标展示

### 📱 移动端适配
- **响应式布局**：完美适配 PC、平板、手机多端展示
- **移动端交互**：针对移动端优化的卡片式列表视图
- **智能显隐**：基于屏幕尺寸自动调整表格列与操作区

---

## 🛠️ 快速开始

### 环境要求
- Node.js 18+
- pnpm 9+
- PostgreSQL 14+

### 安装依赖

```bash
pnpm install
```

### 配置环境变量

复制 `apps/api/.env.example` 为 `apps/api/.env`，配置数据库连接：

```env
DATABASE_URL="postgresql://user:password@localhost:5432/ctbms_dev"
```

### 数据库初始化 (One-Click Deployment)

推荐使用以下命令一次性完成 Schema 同步与全量数据初始化（包含行政区划、组织架构、配置规则及测试数据）：

```bash
# 1. 同步数据库结构
pnpm --filter api exec prisma db push

# 2. 一键播种所有测试数据
pnpm --filter api exec prisma db seed
```

> 详细配置说明请参考 [配置中心使用说明](./docs/CONFIGURATION_CENTER_GUIDE.md)

### 启动开发服务器

```bash
# 启动所有服务
pnpm dev

# 或分别启动
pnpm dev:web   # 前端 http://localhost:5173
pnpm dev:api   # 后端 http://localhost:3000
```

---

## 🔐 系统初始化

首次部署需初始化系统数据（管理员角色和用户）。

### 方式一：浏览器访问（推荐）

启动后端服务后，浏览器访问：

```
http://localhost:3000/init
```

成功后返回：
```json
{
  "success": true,
  "message": "系统初始化成功",
  "data": {
    "roles": ["系统管理员", "普通员工"],
    "adminUser": "admin"
  }
}
```

### 方式二：命令行 SQL

```bash
psql $DATABASE_URL -f apps/api/prisma/seed.sql
```

### 初始化数据

| 类型 | 名称 | 代码 | 说明 |
|:---|:---|:---|:---|
| 角色 | 系统管理员 | `SUPER_ADMIN` | 系统内置，不可删除 |
| 角色 | 普通员工 | `STAFF` | 系统内置，不可删除 |
| 用户 | admin | - | 默认管理员账号 |

> **注意**：生产环境部署后请立即修改默认管理员信息！

---

## 📝 开发规范

详见 [WORKFLOW_RULES.md](./WORKFLOW_RULES.md)

### 关键原则
- **单一事实来源**：共享类型定义在 `packages/types`
- **严格使用 pnpm**：禁止 npm/yarn
- **Ant Design Token**：禁止硬编码颜色
- **ProComponents 优先**：表格使用 ProTable，表单使用 ProForm
- **错误处理策略**：
    - **业务错误 (4xx)**：前端拦截或静默处理，通过 UI 弹窗提示，不打印控制台红字。
    - **系统错误 (5xx)**：保留控制台错误日志 (`console.error`)，便于开发调试。

---

## 📄 License

MIT
